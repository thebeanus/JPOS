<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>jPOS Programmer&#8217;s Guide</title><link rel="stylesheet" type="text/css" href="css/manual.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><meta name="description" content="jPOS is an ISO-8583 library/framework that can be used to implement financial interchanges, protocol converters, payment gateways, credit card verification clients and servers (merchant/issuer/acquirer roles), etc. This document describes jPOS' design, its internals and shows you how to get the most out of it."></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d0e3"></a>jPOS Programmer&#8217;s Guide</h1></div><div><h2 class="subtitle">jPOS Programmer's Guide</h2></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Alejandro</span> <span class="othername">P</span> <span class="surname">Revilla</span></h3></div></div></div><div><div class="author"><h3 class="author"><span class="firstname">jPOS</span> <span class="othername">Software</span> <span class="surname">SRL</span></h3><code class="email">&lt;<a class="email" href="mailto:apr@jpos.org">apr@jpos.org</a>&gt;</code></div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Dave</span> <span class="surname">Bergert</span></h3><span class="contrib">Extensive review, and multiple corrections</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Alwyn</span> <span class="surname">Schoeman</span></h3><span class="contrib">Review, Feedback, Corrections</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Andy</span> <span class="surname">Orrock</span></h3><span class="contrib">Extensive feedback and corrections</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Mark</span> <span class="surname">Salter</span></h3><span class="contrib">Extensive feedback and corrections</span>&nbsp;</div></div><div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Murtuza</span> <span class="surname">Chhil</span></h3><span class="contrib">Extensive feedback and corrections</span>&nbsp;</div></div><div><p class="releaseinfo">2.1.4</p></div><div><p class="copyright">Copyright &copy; 1998-2015 Alejandro Revilla / Uruguay</p></div><div><div class="legalnotice"><a name="d0e42"></a><p>
    All rights reserved. No part of this document may be reproduced in any
    form or by any electronic or mechanical means, including information
    storage and retrieval systems, without permission in writing from
    jPOS Software SRL (Uruguay).
  </p></div></div><div><div class="revhistory"><table style="border-style:solid; width:100%;" summary="Revision History"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left">Revision 2.1.5</td><td align="left">2022-09-10</td><td align="left">jSS</td></tr></table></div></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>
    jPOS is an ISO-8583 library/framework that can be used to
    implement financial interchanges, protocol converters,
    payment gateways, credit card verification clients and
    servers (merchant/issuer/acquirer roles), etc.
  </p><p>
     This document describes jPOS' design, its internals and shows
     you how to get the most out of it.
  </p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="preface"><a href="#copyright_notice">Copyright notice</a></span></dt><dt><span class="preface"><a href="#preface">Preface</a></span></dt><dt><span class="chapter"><a href="#_the_jpos_project">1. The jPOS Project</a></span></dt><dd><dl><dt><span class="section"><a href="#_about_jpos_org">1.1. About jPOS.org</a></span></dt><dt><span class="section"><a href="#license">1.2. jPOS License</a></span></dt><dt><span class="section"><a href="#iso8583_intro">1.3. About ISO-8583</a></span></dt><dt><span class="section"><a href="#_downloading_jpos">1.4. Downloading jPOS</a></span></dt><dt><span class="section"><a href="#_directory_structure">1.5. Directory structure</a></span></dt><dt><span class="section"><a href="#_using_jpos">1.6. Using jPOS</a></span></dt><dt><span class="section"><a href="#building">1.7. Building jPOS</a></span></dt><dd><dl><dt><span class="section"><a href="#_available_tasks">1.7.1. Available tasks</a></span></dt></dl></dd><dt><span class="section"><a href="#running">1.8. Running jPOS</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_about_iso_8583">2. About ISO-8583</a></span></dt><dd><dl><dt><span class="section"><a href="#iso8583">2.1. An ISO-8583 primer</a></span></dt><dd><dl><dt><span class="section"><a href="#_international_standard_iso_8583">2.1.1. International standard ISO 8583</a></span></dt><dt><span class="section"><a href="#iso8583_message_structure">2.1.2. Message format</a></span></dt><dd><dl><dt><span class="section"><a href="#iso8583_fieldtypes">ISO-8583 fields</a></span></dt></dl></dd><dt><span class="section"><a href="#iso8583_wire_protocol">2.1.3. Wire protocol</a></span></dt><dt><span class="section"><a href="#iso8583_message_flow">2.1.4. Message flow</a></span></dt></dl></dd><dt><span class="section"><a href="#jposiso">2.2. jPOS approach to ISO-8583</a></span></dt><dd><dl><dt><span class="section"><a href="#_isomsg_co">2.2.1. ISOMsg &amp; Co.</a></span></dt><dt><span class="section"><a href="#_packing_and_unpacking">2.2.2. Packing and unpacking</a></span></dt><dt><span class="section"><a href="#_creating_custom_packagers">2.2.3. Creating custom packagers</a></span></dt><dt><span class="section"><a href="#_managing_the_wire_protocol_with_isochannel">2.2.4. Managing the wire protocol with ISOChannel</a></span></dt><dd><dl><dt><span class="section"><a href="#isofilter">Filtered Channels</a></span></dt></dl></dd><dt><span class="section"><a href="#isoserver">2.2.5. Accepting connections with ISOServer</a></span></dt><dt><span class="section"><a href="#multiplexing_with_mux">2.2.6. Multiplexing an ISOChannel with a MUX</a></span></dt></dl></dd><dt><span class="section"><a href="#incoming_filter">2.3. IncomingListener</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_support_classes">3. Support classes</a></span></dt><dd><dl><dt><span class="section"><a href="#logger">3.1. jPOS' Logger</a></span></dt><dt><span class="section"><a href="#nameregistrar">3.2. NameRegistrar</a></span></dt><dt><span class="section"><a href="#configuration">3.3. Configuration</a></span></dt><dt><span class="section"><a href="#SystemMonitor">3.4. SystemMonitor</a></span></dt><dt><span class="section"><a href="#profiler">3.5. Profiler</a></span></dt><dt><span class="section"><a href="#dirpoll">3.6. DirPoll</a></span></dt><dt><span class="section"><a href="#threadpool">3.7. ThreadPool</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_packagers">4. Packagers</a></span></dt><dd><dl><dt><span class="section"><a href="#packagerimpl">4.1. Implementing Custom Packagers</a></span></dt><dt><span class="section"><a href="#GenericPackager">4.2. GenericPackager</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_channels">5. Channels</a></span></dt><dd><dl><dt><span class="section"><a href="#_tcpip_socket_based_channels">5.1. TCP/IP Socket-based channels</a></span></dt><dt><span class="section"><a href="#_ssl_channels">5.2. SSL Channels</a></span></dt><dt><span class="section"><a href="#_loopbackchannel">5.3. LoopbackChannel</a></span></dt><dt><span class="section"><a href="#_channelpool">5.4. ChannelPool</a></span></dt><dt><span class="section"><a href="#_channel_filters">5.5. Channel Filters</a></span></dt><dd><dl><dt><span class="section"><a href="#_md5filter">5.5.1. MD5Filter</a></span></dt><dt><span class="section"><a href="#_channelinfofilter">5.5.2. ChannelInfoFilter</a></span></dt><dt><span class="section"><a href="#_delayfilter">5.5.3. DelayFilter</a></span></dt><dt><span class="section"><a href="#_debugfilter">5.5.4. DebugFilter</a></span></dt><dt><span class="section"><a href="#_throughputcontrolfilter">5.5.5. ThroughputControlFilter</a></span></dt><dt><span class="section"><a href="#_bshfilter">5.5.6. BSHFilter</a></span></dt><dt><span class="section"><a href="#_additional_filters">5.5.7. Additional filters</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_jpos_space">6. jPOS Space</a></span></dt><dd><dl><dt><span class="section"><a href="#space_interface">6.1. Space interface</a></span></dt><dt><span class="section"><a href="#local_space_interface">6.2. Local Space interface</a></span></dt><dt><span class="section"><a href="#space_factory">6.3. Space Factory</a></span></dt><dt><span class="section"><a href="#tspace">6.4. TSpace</a></span></dt><dt><span class="section"><a href="#jdbm_space">6.5. JDBMSpace</a></span></dt><dt><span class="section"><a href="#je_space">6.6. JESpace</a></span></dt><dt><span class="section"><a href="#space_interceptor">6.7. SpaceInterceptor</a></span></dt><dt><span class="section"><a href="#space_tap">6.8. SpaceTap</a></span></dt><dt><span class="section"><a href="#space_util">6.9. SpaceUtil</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_q2">7. Q2</a></span></dt><dd><dl><dt><span class="section"><a href="#running_Q2">7.1. Running Q2</a></span></dt><dd><dl><dt><span class="section"><a href="#_command_line_options">7.1.1. Command line options</a></span></dt><dd><dl><dt><span class="section"><a href="#cli_commands"><code class="literal">--cli</code></a></span></dt><dt><span class="section"><a href="#_command_arg"><code class="literal">--command &lt;arg&gt;</code></a></span></dt><dt><span class="section"><a href="#_deploydir_arg"><code class="literal">--deploydir &lt;arg&gt;</code></a></span></dt><dt><span class="section"><a href="#_recursive"><code class="literal">--recursive</code></a></span></dt><dt><span class="section"><a href="#_config_arg"><code class="literal">--config &lt;arg&gt;</code></a></span></dt><dt><span class="section"><a href="#_encrypt_arg"><code class="literal">--encrypt &lt;arg&gt;</code></a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="#embedding_Q2">7.2. Embedding Q2</a></span></dt><dt><span class="section"><a href="#q2_shutdown">7.3. Shutting down Q2</a></span></dt><dt><span class="section"><a href="#writing_first_script">7.4. Writing your first Q2 Script</a></span></dt><dt><span class="section"><a href="#qtest">7.5. QTest - a sample QBean</a></span></dt><dt><span class="section"><a href="#qbean_support">7.6. QBeanSupport</a></span></dt><dt><span class="section"><a href="#dynamic_classloading">7.7. Dynamic classloading</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_q2_jpos_services">8. Q2 jPOS Services</a></span></dt><dd><dl><dt><span class="section"><a href="#channel_adaptor">8.1. ChannelAdaptor</a></span></dt><dd><dl><dt><span class="section"><a href="#_qbean_descriptor">8.1.1. QBean descriptor</a></span></dt><dt><span class="section"><a href="#_handling_alternate_connections">8.1.2. Handling alternate connections</a></span></dt><dt><span class="section"><a href="#_channel_timeout_keep_alive_connection_timeout">8.1.3. Channel timeout, keep-alive, connection-timeout</a></span></dt></dl></dd><dt><span class="section"><a href="#one_shot_channel_adaptor">8.2. OneShotChannelAdaptor</a></span></dt><dd><dl><dt><span class="section"><a href="#_qbean_descriptor_2">8.2.1. QBean descriptor</a></span></dt></dl></dd><dt><span class="section"><a href="#qmux">8.3. QMUX</a></span></dt><dd><dl><dt><span class="section"><a href="#_qbean_descriptor_3">8.3.1. QBean descriptor</a></span></dt><dt><span class="section"><a href="#_mti_mapping_and_default_key">8.3.2. MTI mapping and default key</a></span></dt></dl></dd><dt><span class="section"><a href="#qserver">8.4. QServer</a></span></dt><dd><dl><dt><span class="section"><a href="#_qbean_descriptor_4">8.4.1. QBean descriptor</a></span></dt></dl></dd><dt><span class="section"><a href="#logger-adaptor">8.5. LoggerAdaptor</a></span></dt><dd><dl><dt><span class="section"><a href="#_simpleloglistener">8.5.1. SimpleLogListener</a></span></dt><dt><span class="section"><a href="#_rotateloglistener">8.5.2. RotateLogListener</a></span></dt><dt><span class="section"><a href="#_dailyloglistener">8.5.3. DailyLogListener</a></span></dt><dt><span class="section"><a href="#ProtectedLogListener">8.5.4. ProtectedLogListener</a></span></dt><dt><span class="section"><a href="#_fsdprotectedloglistener">8.5.5. FSDProtectedLogListener</a></span></dt><dt><span class="section"><a href="#_sysloglistener">8.5.6. SysLogListener</a></span></dt><dt><span class="section"><a href="#_realmlogfilter">8.5.7. RealmLogFilter</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_transactionmanager">9. TransactionManager</a></span></dt><dd><dl><dt><span class="section"><a href="#_transactionconstants">9.1. TransactionConstants</a></span></dt><dt><span class="section"><a href="#_transaction_context">9.2. Transaction Context</a></span></dt><dt><span class="section"><a href="#_context_recovery_interface">9.3. Context Recovery Interface</a></span></dt><dt><span class="section"><a href="#_assembly_line">9.4. Assembly Line</a></span></dt><dt><span class="section"><a href="#_abortparticipant">9.5. AbortParticipant</a></span></dt><dt><span class="section"><a href="#_groupselector">9.6. GroupSelector</a></span></dt><dt><span class="section"><a href="#_transactionmanager_implementation">9.7. TransactionManager implementation</a></span></dt><dd><dl><dt><span class="section"><a href="#_tm_use_of_spaces">9.7.1. TM use of spaces</a></span></dt><dt><span class="section"><a href="#_configuration">9.7.2. Configuration</a></span></dt><dt><span class="section"><a href="#_transactionstatuslistener">9.7.3. TransactionStatusListener</a></span></dt></dl></dd><dt><span class="section"><a href="#_transaction_participants">9.8. Transaction Participants</a></span></dt><dd><dl><dt><span class="section"><a href="#_switch_participant">9.8.1. Switch participant</a></span></dt><dt><span class="section"><a href="#_checkfields_participant">9.8.2. CheckFields participant</a></span></dt><dt><span class="section"><a href="#_selectdestination">9.8.3. SelectDestination</a></span></dt><dt><span class="section"><a href="#_queryhost">9.8.4. QueryHost</a></span></dt><dt><span class="section"><a href="#_sendresponse">9.8.5. SendResponse</a></span></dt><dt><span class="section"><a href="#_jsparticipant">9.8.6. JSParticipant</a></span></dt><dt><span class="section"><a href="#_pause">9.8.7. Pause</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#_resultcode">10. ResultCode</a></span></dt><dd><dl><dt><span class="section"><a href="#_cmf">10.1. CMF</a></span></dt><dt><span class="section"><a href="#_result_holder_class">10.2. Result holder class</a></span></dt></dl></dd><dt><span class="appendix"><a href="#getting_involved">A. Getting involved</a></span></dt><dt><span class="appendix"><a href="#appendix_license">B. License</a></span></dt></dl></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="copyright_notice"></a>Copyright notice</h1></div></div></div><div class="informalexample"><p>Copyright &copy; 1998-2019 by jPOS Software SRL, Uruguay.
All rights reserved. No part of this book may be reproduced in any form or by
any electronic or mechanical means, including information storage and retrieval
systems, without permission in writing from jPOS Software SRL, except by a
reviewer who may quote brief passages  in a review.</p></div></div><div class="preface"><div class="titlepage"><div><div><h1 class="title"><a name="preface"></a>Preface</h1></div></div></div><p>This document covers <span class="strong"><strong>jPOS 2.1.4</strong></span> (and 2.1.5-SNAPSHOT).</p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_the_jpos_project"></a>1.&nbsp;The jPOS Project</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_about_jpos_org"></a>1.1&nbsp;About jPOS.org</h2></div></div></div><p>The jPOS project is hosted at <a class="link" href="http://jpos.org" target="_top">http://jpos.org</a>.
In order to stay up-to-date with jPOS news, you may want to visit
the project&#8217;s main page, as well as its blog at <a class="link" href="http://jpos.org/blog" target="_top">http://jpos.org/blog</a>.
For an up to date list of project resources, you can visit the <a class="link" href="http://jpos.org/resources" target="_top">http://jpos.org/resources</a> page.
There&#8217;s also a low traffic <span class="strong"><strong>jPOS News</strong></span> mailing list where we post important
announcements, such as a the availability of new versions of this guide. You&#8217;re
encouraged to register by visiting the project&#8217;s main page at <a class="link" href="http://jpos.org" target="_top">http://jpos.org</a>.</p><p>Code is hosted at <a class="link" href="http://github.com/jpos/jPOS" target="_top">http://github.com/jpos/jPOS</a>.</p><p>You may also want to follow us on Twitter, where we keep a list of users who regularly tweet about jPOS at <a class="link" href="http://twitter.com/apr/lists/jpos" target="_top">@apr/lists/jpos</a>.</p><p>In addition, you may want to subscribe to our
<a class="link" href="http://groups.google.com/group/jpos-users" target="_top">users' mailing list (jpos-users@googlegroups.com)</a>.</p><p>Commit notifications can be tracked by following <a class="link" href="http://twitter.com/jposcommits" target="_top">@jposcommits</a>.</p><p>We are also active on <a class="link" href="https://jpos.slack.com" target="_top">Slack</a>. Please request an invitation via e-mail to <a class="link" href="mailto:support@jpos.org" target="_top">support@jpos.org</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you happen to tweet about jPOS, please use the hash tag <code class="literal">#jPOS</code> so we can follow you.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="license"></a>1.2&nbsp;jPOS License</h2></div></div></div><p>jPOS is distributed under the <a class="link" href="#appendix_license" title="Appendix&nbsp;B.&nbsp;License">GNU Affero General Public License version 3</a>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: IMPORTANT NOTICE"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">IMPORTANT NOTICE</th></tr><tr><td align="left" valign="top"><p>If you don&#8217;t plan to release your jPOS based application under a compatible license
(see <a class="link" href="http://www.fsf.org/licensing/licenses/agpl-3.0.html" target="_top">AGPL 3.0 FAQ</a>
where you can find a license compatibility matrix)
 <span class="strong"><strong>you need to buy a commercial license</strong></span>
(you can contact us using the <a class="link" href="http://jpos.org/contact?p=CL.Proguide" target="_top">contact form</a>).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="iso8583_intro"></a>1.3&nbsp;About ISO-8583</h2></div></div></div><p>We assume the reader is familiar with the ISO-8583 standard.</p><p>For starters, you can take a look at the Wikipedia
<a class="link" href="http://en.wikipedia.org/wiki/ISO_8583" target="_top">ISO_8583</a> page and the <a class="xref" href="#iso8583" title="2.1&nbsp;An ISO-8583 primer">Section&nbsp;2.1, &#8220;An ISO-8583 primer&#8221;</a>
of this document, but for any serious work you need to get a copy
of the standard from <a class="link" href="http://www.iso.org" target="_top">http://www.iso.org</a>.</p><p>This is a high level standard, and vendors have implemented it in slightly
different ways. You also need the protocol specifications for your
particular interchange.</p><p>If you are starting a new payments application and you have full control over
your spec, you may want to consider using the ISO-8583 v2003 based jPOS Common
Message Format described in <a class="link" href="http://jpos.org/doc/jPOS-CMF.pdf" target="_top">http://jpos.org/doc/jPOS-CMF.pdf</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The jPOS-CMF is an open source project, you can get the DocBook sources
in the jPOS Github reporitory at <a class="link" href="http://github.com/jPOS/jPOS-CMF" target="_top">http://github.com/jPOS/jPOS-CMF</a> and
modify it to fit your needs. This is an open spec, we expect institutions
using it to get in touch with us in order to improve it.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_downloading_jpos"></a>1.4&nbsp;Downloading jPOS</h2></div></div></div><p>The community edition of jPOS can be downloaded from the
<a class="link" href="http://jpos.org/download" target="_top">jPOS Download</a> page.</p><p>A Git repository is hosted at <a class="link" href="http://github.com/jpos/jPOS" target="_top">Github</a>.
The repository has many branches and tags. Unless you are dealing with a
legacy jPOS application, you want to use the <code class="literal">master</code> branch.</p><p>If you are looking for older jPOS versions, you can
find them in the <a class="link" href="http://sourceforge.net/projects/jpos/files/jpos/" target="_top">SourceForge</a>
repository, but please note all current development activity is taking place in the
<a class="link" href="http://github.com/jpos/jPOS" target="_top">Github</a> repository, though.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_directory_structure"></a>1.5&nbsp;Directory structure</h2></div></div></div><p>jPOS uses <a class="link" href="http://www.gradle.org/" target="_top">Gradle</a> with a <span class="strong"><strong>multi-module</strong></span> setup.</p><p>The modules are defined in the <code class="literal">settings.gradle</code> file and listed below:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>jpos</strong></span> : this is the jPOS system</li><li class="listitem"><span class="strong"><strong>compat_1_5_2</strong></span> : compatibility with older versions</li></ul></div><p>You&#8217;ll find the jPOS sources in the <code class="literal">jpos/src</code> directory.</p><pre class="screen">|-- COPYRIGHT                                                             <a name="CO1-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
|-- CREDITS
|-- LICENSE
|-- README.md                                                             <a name="CO1-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
|-- build.gradle                                                          <a name="CO1-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
|-- settings.gradle                                                       <a name="CO1-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
...
...

|-- gradlew                                                               <a name="CO1-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
|-- gradlew.bat
|-- gradle
|   `-- wrapper
|       |-- gradle-wrapper.jar
|       `-- gradle-wrapper.properties
...
...
|-- jpos                                                                  <a name="CO1-6"></a><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span>
|   |-- build.gradle
|   |-- src
|   |   |-- main
|   |   |   |-- java
|   |   |-- main
|   |   |   |-- resources
|   |   |-- dist                                                          <a name="CO1-7"></a><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span>
|   |   |   |-- bin
|   |   |   |   |-- bsh
|   |   |   |   |-- q2
|   |   |   |   |-- start
|   |   |   |   `-- stop
|   |   |   |-- cfg
|   |   |   |   |-- packager
|   |   |   |   |   |-- base1.xml
|   |   |   |   |   |-- base24-eps.xml
|   |   |   |   |   |-- base24.xml
...
...
|   |   |   |-- deploy
|   |   |   |   |-- 00_logger.xml
|   |   |   |   `-- 99_sysmon.xml
|   |   |   `-- log
|   |   |       `-- q2.log
...
...</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Copyright notice</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Readme file in markdown format shown in the <a class="link" href="https://github.com/jpos/jPOS" target="_top">Github</a> repository</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Main Gradle configuration file</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Gradle&#8217;s <code class="literal">settings</code> file, lists the modules to be compiled, in this case, <code class="literal">jpos</code> and <code class="literal">compat_1_5_2</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>It is recommended that you install Gradle locally, but for a quick build, you can use the Gradle wrapper (<code class="literal">gradlew</code> in Unix, <code class="literal">gradlew.bat</code> in Windows).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-6"><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left"><p>Home for the jPOS module</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-7"><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left"><p>Template for a production distribution directory with its deploy, cfg, bin and log directories</p></td></tr></table></div><pre class="screen">|-- compat_1_5_2                                                          <a name="CO2-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
|   |-- build.gradle
|   |-- compat_1_5_2.iml
|   |-- src
|   |   `-- main
|   |       `-- java
|   |           `-- org
|   |               `-- jpos
|   |   |   `-- resources
...
...
|-- legal                                                                 <a name="CO2-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
|   |-- cla-template.txt
|   |-- ccla-template.txt
|-- incoming                                                              <a name="CO2-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
...
...</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Backward compatibility with version 1.5.2</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Legal directory with contributor license agreements</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO2-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Contributed files not yet merged into jPOS. Now with Git and pull requests, this directory will be removed at some point.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Unless you&#8217;re dealing with a legacy jPOS system, you probably don&#8217;t want to use
the <code class="literal">compat_1_5_2</code> module.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_using_jpos"></a>1.6&nbsp;Using jPOS</h2></div></div></div><p>You don&#8217;t have to build jPOS in order to use it in your projects,
although you are welcome to try and build it (see <a class="xref" href="#building" title="1.7&nbsp;Building jPOS">Section&nbsp;1.7, &#8220;Building jPOS&#8221;</a>) for
learning purposes or if you want to contribute to the project.</p><p>jPOS produces Maven compatible <code class="literal">poms</code> and regularly publishes releases
to <a class="link" href="http://search.maven.org" target="_top">Maven Central</a>.</p><p>If you want to use it from Maven, you can add this dependency to your <code class="literal">pom</code>:</p><p>Here is a sample POM</p><pre class="programlisting"><span class="hl-tag">&lt;dependency&gt;</span>
    <span class="hl-tag">&lt;groupId&gt;</span>org.jpos<span class="hl-tag">&lt;/groupId&gt;</span>
    <span class="hl-tag">&lt;artifactId&gt;</span>jpos<span class="hl-tag">&lt;/artifactId&gt;</span>
    <span class="hl-tag">&lt;version&gt;</span>2.1.4<span class="hl-tag">&lt;/version&gt;</span>
<span class="hl-tag">&lt;/dependency&gt;</span></pre><p>or Gradle dependency:</p><pre class="screen">org.jpos:jpos:2.1.4</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The stable release is 2.1.4, development release is 2.1.5-SNAPSHOT.</p></td></tr></table></div><p>jPOS uses the following dependency not available in Maven central, so you need to add
the following repository</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="http://download.oracle.com/maven" target="_top">http://download.oracle.com/maven</a> (required by Berkeley DB Java Edition)</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>We publish SNAPSHOT daily builds (i.e. version 2.1.5-SNAPSHOT) to
the <a class="link" href="http://jpos.org/maven" target="_top">jPOS Maven repository</a> and stable releases to Maven Central.
Please note the <span class="strong"><strong>compat_1_5_2</strong></span> module is only published to jPOS Maven repo.</p></td></tr></table></div><p>if you use Gradle, you can configure:</p><pre class="programlisting">repositories {
    mavenCentral()
    maven { url 'http://jpos.org/maven' }
    maven { url 'http://download.oracle.com/maven' }
    mavenLocal()
}

dependencies {
    compile org.jpos:jpos:2.1.4
    testCompile 'junit:junit4.8.2'
}</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you&#8217;re building a jPOS application, the easiest way is to clone the
<a class="link" href="http://github.com/jpos/jPOS-template" target="_top">jPOS Template</a>
project and take it from there.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="building"></a>1.7&nbsp;Building jPOS</h2></div></div></div><p>jPOS uses <a class="link" href="http://www.gradle.org/" target="_top">Gradle</a> as its build system.
For a quick build, you don&#8217;t even need to install Gradle, you
can use the handy <code class="literal">gradlew</code> (or <code class="literal">gradlew.bat</code> if you&#8217;re on Windows)
Gradle <span class="emphasis"><em>wrapper</em></span> that automatically downloads Gradle for you, but
for daily development, it&#8217;s a good idea to install it locally.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Whenever we mention the <code class="literal">gradle</code> command in this guide, you can
either use your locally installed Gradle, or the <code class="literal">gradlew</code> wrapper
scripts mentioned above.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Gradle has the ability to run in background, dramatically reducing
the load time. In order to enable that feature, you can use its
<code class="literal">--daemon</code> parameter or</p><pre class="screen">export GRADLE_OPTS=-Dorg.gradle.daemon=true</pre></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_available_tasks"></a>1.7.1&nbsp;Available tasks</h3></div></div></div><p>Running <code class="literal">gradle tasks</code> provides a list of available tasks.</p><p>Most of them are standard in the Gradle build system and have self-explanatory
names (i.e. <code class="literal">jar</code> to build the jPOS jar, <code class="literal">javadoc</code> to build the javadoc
documentation). A few deserve further explanation, though:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong><code class="literal">installApp</code></strong></span> is a handy task defined in the <code class="literal">jpos</code> module that can
be used to create a runtime environment inside the <code class="literal">build/installs</code>
directory. That runtime envirnoment copies all the scripts coming from
the <code class="literal">src/dist</code> directory and it&#8217;s ready to execute the jPOS system
using the <code class="literal">bin/q2</code> (or <code class="literal">bin\q2.bat</code>) scripts. The <code class="literal">installApp</code> task
is similar to running the <code class="literal">dist</code> task to create a <code class="literal">tar.gz</code> tarball
and then extracting that tarball into a local directory, ready to run.</li><li class="listitem"><span class="strong"><strong><code class="literal">version</code></strong></span> can be used to build jPOS and run it to query its own version.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note about releases"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note about releases</th></tr><tr><td align="left" valign="top"><p>jPOS stable releases (non SNAPSHOTS) are signed and published to Maven Central.
If you are trying to build a stable release, you&#8217;d have to hack <code class="literal">build.gradle</code>
to trick the <code class="literal">isSnapshot</code> variable to be true, otherwise the build will fail
because you don&#8217;t have the PGP private keys required to sign a build.</p><p>If you&#8217;re making some changes to jPOS off a stable release, you should
change the version number to avoid confusion.</p><p>But remember, you don&#8217;t have to build jPOS in order to use it, just add
it to your <span class="emphasis"><em>pom</em></span> as a dependency.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: The clean task is your friend"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">The <span class="emphasis"><em>clean</em></span> task is your friend</th></tr><tr><td align="left" valign="top"><p>Out of all the available tasks, there&#8217;s one that will keep you out
of trouble: <span class="strong"><strong>clean</strong></span>. While Gradle is very smart when it comes to figuring
out which dependencies have been modified and need to be rebuilt, there&#8217;s
nothing like the extra confidence that a good old <code class="literal">clean</code> gives. When
in doubt, <code class="literal">gradle clean</code>.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="running"></a>1.8&nbsp;Running jPOS</h2></div></div></div><p>From the <code class="literal">jpos</code> directory, run <code class="literal">gradle installApp</code> to create
a working jPOS in the <code class="literal">build/install/jpos</code> directory.</p><p>Change directory there and you will see a <code class="literal">jpos-x.x.xjar</code> (i.e <code class="literal">jpos-1.9.9-SNAPSHOT.jar</code>).</p><p>You can run the jar using <code class="literal">java -jar jpos-1.9.1-SNAPSHOT.jar</code> or use
the <code class="literal">bin/q2</code> or <code class="literal">bin/q2.bat</code> scripts.</p><p>Once started, the output should look like this:</p><pre class="screen">&lt;log realm="org.jpos.q2.qbean.SystemMonitor" at="2016-08-27T22:26:51.720"&gt;
  &lt;info&gt;
               OS: Linux (3.14.35-28.38.amzn1.x86_64)
     process name: 19213@ip-172-30-0-180
             host: ip-172-30-0-180/52.5.73.144
              cwd: /opt/local/jpos
       free space: 133.3 GiB
     usable space: 123.3 GiB
          version: 2.0.7-SNAPSHOT (bdcac3f)
         instance: b1016676-b840-4fb6-916b-37c4b4355c45
           uptime: 00:00:00.691 (0.460000)
       processors: 2
           drift : 0
    memory(t/u/f): 75/14/60
         encoding: UTF-8
         timezone: Etc/UTC (Coordinated Universal Time) Z
    watch service: sun.nio.fs.LinuxWatchService
            clock: 1472336811 2016-08-27T22:26:51.720Z
     thread count: 10
     peak threads: 10
     user threads: 6
            Thread[Reference Handler,10,system]
            Thread[Finalizer,8,system]
            Thread[Signal Dispatcher,9,system]
            Thread[RMI TCP Accept-0,5,system]
            Thread[pool-1-thread-1,5,main]
            Thread[Q2-b1016676-b840-4fb6-916b-37c4b4355c45,5,main]
            Thread[DestroyJavaVM,5,main]
            Thread[Thread-2,5,main]
            Thread[Timer-0,5,main]
            Thread[SystemMonitor,5,main]
    name-registrar:
      Q2: org.jpos.q2.Q2
      logger.Q2: org.jpos.util.Logger
  &lt;/info&gt;
&lt;/log&gt;</pre><p>You may want to review the content in the <code class="literal">deploy</code> directory,
that comes from the <code class="literal">src/dist</code> source tree.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_about_iso_8583"></a>2.&nbsp;About ISO-8583</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="iso8583"></a>2.1&nbsp;An ISO-8583 primer</h2></div></div></div><p>This section contains general information about the ISO-8583 International Standard.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_international_standard_iso_8583"></a>2.1.1&nbsp;International standard ISO 8583</h3></div></div></div><p><span class="strong"><strong>Financial transaction card-originated messages Interchange message specifications</strong></span>.</p><p>You have to read it, period. And you have to read the correct one
(1987/1993/2003) for your particular interchange.  And you also have to read
your vendor-specific interchange specs as well.</p><p>But while you manage to gather all that information, let&#8217;s have a look at this
brief introduction. When talking about ISO-8583, we have to be aware of the difference between:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">message format (its binary representation),</li><li class="listitem">wire protocol (how a  message is transmitted over the wire), and</li><li class="listitem">message flow (e.g., send  request for authorization, wait for response, retransmit, reversal, etc.).</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="iso8583_message_structure"></a>2.1.2&nbsp;Message format</h3></div></div></div><p>ISO-8583 messages are composed by fields, which are represented in different ways. Basically we have the following structure:</p><div class="table"><a name="d0e637"></a><p class="title"><b>Table&nbsp;2.1.&nbsp;ISO-8583 message structure</b></p><div class="table-contents"><table summary="ISO-8583 message structure" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Field #</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0 - MTI</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Message Type Indicator</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1 - Bitmap</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>64 (or 128) bits indicating presence/absence of other fields</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>2 .. 128</p></td><td style="" align="left" valign="top"><p>Other fields as specified in bitmap</p></td></tr></tbody></table></div></div><br class="table-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The bitmaps are encoded in network byte order, with the most significant bit (leftmost bit) of the first
byte indicating presence of a secondary bitmap. Then, the next bit towards the right indicates presence
of field 2, the next one refers to field 3, and so on.</p></td></tr></table></div><p>So let&#8217;s have a look at a simple example:</p><div class="table"><a name="d0e676"></a><p class="title"><b>Table&nbsp;2.2.&nbsp;Sample 0800 message</b></p><div class="table-contents"><table summary="Sample 0800 message" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">#</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Hex Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MTI</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0800</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>08 00</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PRIMARY BITMAP</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates presence of fields 3, 11 and 41</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>20 20 00 00 00 80 00 00</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PROCESSING CODE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00 00 00</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>11</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SYSTEM TRACE AUDIT NUMBER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00 00 01</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>41</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>TERMINAL ID</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>29110001</p></td><td style="" align="left" valign="top"><p>32 39 31 31 30 30 30 31</p></td></tr></tbody></table></div></div><br class="table-break"><p>Here is the binary representation of our 0800 message:</p><pre class="screen">   080020200000008000000000000000013239313130303031</pre><p>In the previous example, 0800 is the  <span class="strong"><strong>message type indicator (<span class="emphasis"><em>MTI</em></span>)</strong></span>;
The first position represents ISO-8583 version number:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">0 for version 1987</li><li class="listitem">1 for version 1993</li><li class="listitem">2 for version 2003</li><li class="listitem">3-7 reserved for ISO use</li><li class="listitem">8 is reserved for national use</li><li class="listitem">9 is reserved for private use</li></ul></div><p>The second position represents <span class="strong"><strong>message class</strong></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">0 is reserved for ISO use</li><li class="listitem">1 authorization</li><li class="listitem">2 financial</li><li class="listitem">3 file update</li><li class="listitem">4 reversals and chargebacks</li><li class="listitem">5 reconciliation</li><li class="listitem">6 administrative</li><li class="listitem">7 fee collection</li><li class="listitem">8 network management</li><li class="listitem">9 reserved for ISO use</li></ul></div><p>The third position is the <span class="strong"><strong>message function</strong></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">0 request</li><li class="listitem">1 request response</li><li class="listitem">2 advice</li><li class="listitem">3 advice response</li><li class="listitem">4 notification</li><li class="listitem">5-9 reserved for ISO use</li></ul></div><p>And the last position is used to indicate the <span class="strong"><strong>transaction originator</strong></span>:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">0 acquirer</li><li class="listitem">1 acquirer repeat</li><li class="listitem">2 card issuer</li><li class="listitem">3 card issuer repeat</li><li class="listitem">4 other</li><li class="listitem">5 other repeat</li><li class="listitem">6-9 reserved for ISO use</li></ul></div><p>So "0800" is a <span class="emphasis"><em>version 1987 network management request</em></span>.</p><p>Next we have field 1, the primary bitmap:</p><div class="table"><a name="d0e885"></a><p class="title"><b>Table&nbsp;2.3.&nbsp;Primary Bitmap</b></p><div class="table-contents"><table summary="Primary Bitmap" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">byte</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">hex value</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">bit value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">field #</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>20</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0010 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>20</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0010 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>11</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>5</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>80</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>41</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>6</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>7</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table></div></div><br class="table-break"><p>So now that we&#8217;ve parsed the MTI (0800) and bitmap (2020000000800000),
we know that fields 3, 11 and 41 are present.
So our next field is number 3.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="iso8583_fieldtypes"></a>ISO-8583 fields</h4></div></div></div><p>There are many field types:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Fixed length</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Numeric</li><li class="listitem">Alphanumeric</li><li class="listitem">Binary</li></ul></div></li><li class="listitem"><p class="simpara">Variable length with a max length 99</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Numeric</li><li class="listitem">Alphanumeric</li><li class="listitem">Binary</li></ul></div></li><li class="listitem"><p class="simpara">Variable length with a max length 999</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Numeric</li><li class="listitem">Alphanumeric</li><li class="listitem">Binary</li></ul></div></li><li class="listitem"><p class="simpara">Variable length with a max length 9999 (available starting in ISO-8583 version 2003)</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">Numeric</li><li class="listitem">Alphanumeric</li><li class="listitem">Binary</li></ul></div></li><li class="listitem">Nested message</li></ul></div><p>So far, so good, this is very simple stuff, isn&#8217;t it?
The problem is not complexity but diversity, ISO-8583 is not specific about how
a given field is represented, so you can have a numeric field represented as a
sequence of ASCII characters, EBCDIC characters, BCD, etc.</p><p>Variable length fields have a prefix specifying its length, but how this is represented
is not defined. Different vendors use different representations (e.g., BCD, EBCDIC,
binary value).</p><p>In our example, field #3 is using a BCD representation in network byte order, so a value of "000000"
is represented with just three bytes whose hex values are "00 00 00".
Same goes for field #11 whose value is "000001" - it is represented as "00 00 01".
In our example, field #41 is an eight-byte alphanumeric field represented as eight ASCII characters</p><pre class="screen">     Message: 08002020 00000080 00000000 00000001
              32393131 30303031

         MTI: 0800
      Bitmap: 20200000 00800000
    Field 03: 000000
    Field 11: 000001
    field 41: 3239313130303031 (ASCII for "29110001")</pre><p>Let&#8217;s have a look at another sample message:</p><div class="table"><a name="d0e1071"></a><p class="title"><b>Table&nbsp;2.4.&nbsp;Another 0800 message</b></p><div class="table-contents"><table summary="Another 0800 message" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">#</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Hex Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MTI</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0800</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">08 00</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1.</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PRIMARY BITMAP</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates presence of secondary bitmap plus fields 3, 11, 41 and 60</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">A0 20 00 00 00 80 00 10</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SECONDARY BITMAP</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Indicates presence of field 70</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">04 00 00 00 00 00 00 00</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PROCESSING CODE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">00 00 00</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>11</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SYSTEM TRACE AUDIT NUMBER</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">00 00 01</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>41</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>TERMINAL ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>29110001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">32 39 31 31 30 30 30 31</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>60</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RESERVED FOR PRIVATE USE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jPOS 1.9.1</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">00 10 6A 50 4F 53 20 31 2E 39 2E 31</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>70</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>NETWORK MANAGEMENT INFORMATION CODE</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>301</p></td><td style="" align="left" valign="top"><p><code class="literal">03 01</code></p></td></tr></tbody></table></div></div><br class="table-break"><p>Two new fields are present: #60 and #70. Here is our message representation:</p><pre class="screen">         Message: 0800A020 00000080 00100400 00000000
                  00000000 00000001 32393131 30303031
                  00106A50 4F532031 2E392E31 0301

             MTI: 0800
  Primary bitmap: A0200000 00800010
Secondary bitmap: 04000000 00000000
        Field 03: 000000
        Field 11: 000001
        Field 41: 3239313130303031 (ASCII for "29110001")
        Field 60: 0010 6A504F5320312E392E31 (length=10, value="jPOS 1.9.1") <a name="CO3-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
        Field 70: 0301</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO3-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>In this example, the length prefix in field 60 is expressed as a 2-byte BCD number; therefore, a length of 10 is encoded as 0010 in hexadecimal.</p></td></tr></table></div><p>Let&#8217;s break down this bitmap:</p><div class="table"><a name="d0e1214"></a><p class="title"><b>Table&nbsp;2.5.&nbsp;Primary Bitmap</b></p><div class="table-contents"><table summary="Primary Bitmap" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">byte</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">hex value</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">bit value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">field #</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1010 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>secondary bitmap present plus #3</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>20</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0010 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>11</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>5</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>80</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>41</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>6</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>7</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>10</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>0001 0000</p></td><td style="" align="left" valign="top"><p>60</p></td></tr></tbody></table></div></div><br class="table-break"><div class="table"><a name="d0e1329"></a><p class="title"><b>Table&nbsp;2.6.&nbsp;Secondary Bitmap</b></p><div class="table-contents"><table summary="Secondary Bitmap" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">byte</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">hex value</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">bit value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">field #</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>04</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0100</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>70</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>5</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>6</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>7</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>0000 0000</p></td><td style="" align="left" valign="top">&nbsp;</td></tr></tbody></table></div></div><br class="table-break"><p>To make things more complex to developers, different vendors choose different padding
styles when handling odd-length BCD fields. So in order to represent "003" one
vendor may use two bytes with the values <code class="literal">"00 03"</code> while others may use <code class="literal">"00 30"</code>
or even <code class="literal">"00 3F"</code>.</p><p>Same goes for variable-length fields: field length as well as field values can
be padded to the left or to the right (that&#8217;s not defined by ISO-8583, it&#8217;s
just a matter of fact of different implementations).</p><p>Then we have nested fields - some implementations use "reserved for private
use" fields to carry other ISO-8583 messages. These messages are usually packed
as variable-length binary fields as seen by the outer message.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You will see that jPOS handles this problem in a very simple way so you
don&#8217;t have to worry about this low-level stuff.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="iso8583_wire_protocol"></a>2.1.3&nbsp;Wire protocol</h3></div></div></div><p>Once we have a binary representation of a given ISO-8583 message, we have to
transmit it over the wire using some communication protocol (e.g., TCP/IP,
UDP, X.25, SDLC, SNA, ASYNC, QTP, SSL, HTTP, you name it).</p><p>That communication protocol is not part of the ISO-8583 standard, so different
vendors have chosen different protocols.</p><p>Many implementations (especially the older ones) require support for some kind
of routing information (e.g., a CICS transaction name), so they use different sorts
of <code class="literal">headers</code>.</p><p>A few of them (especially stream-based ones) require some kind of trailers as well.</p><p>So, the wire protocol is composed by:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">An optional header / message boundary delimiter</li><li class="listitem">ISO-8583 message data</li><li class="listitem">An optional trailer (sometimes used as a message boundary delimiter)</li></ul></div><p>A TCP/IP-based implementation may use a couple of bytes to indicate message
length, so our 0800 example described earlier would be sent as:</p><pre class="screen">  00 46 08 00 A0 20 00 00  00 80 00 10 04 00 00 00
  00 00 00 00 00 00 00 00  00 01 32 39 31 31 30 30
  30 31 00 10 6A 50 4F 53  20 31 2E 34 2E 31 03 01</pre><p>0046 being the message length expressed in network byte order.</p><p>But this is just one way of specifying message length. Other implementations may choose to send
four ASCII bytes, e.g.:</p><pre class="screen">  30 30 34 36 08 00 A0 20  00 00 00 80 00 10 04 00
  00 00 00 00 00 00 00 00  00 00 00 01 32 39 31 31
  30 30 30 31 00 10 6A 50  4F 53 20 31 2E 34 2E 31
  03 01</pre><p><code class="literal">30 30 34 36</code> being the ASCII representation of "0046".</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Some implementations count the size of the message length indicator&#8201;&#8212;&#8201;in the
previous example the four bytes "0046"&#8201;&#8212;&#8201;so instead of sending "0046" they would
send "0050".</p></td></tr></table></div><p>A few of them perform odd things with those headers, flagging rejected messages
(e.g., you send a 0100 and instead of receiving a 0110 with a suitable response
code you get back your own 0100 with some proprietary flag in the header
indicating for example a temporarily failure such as destination unreachable).</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>It&#8217;s very important to read your interchange specification(s)
as early as possible during your development.</p></td></tr></table></div><p>jPOS deals with the wire protocol by using a set of classes called
<span class="strong"><strong>channels</strong></span> that implement the
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/iso/ISOChannel.html" target="_top">ISOChannel</a> interface
that hides the wire protocol details.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="iso8583_message_flow"></a>2.1.4&nbsp;Message flow</h3></div></div></div><p>Message flow will vary depending on your particular interchange specification.
But let&#8217;s have a look at a simple example:</p><div class="table"><a name="d0e1517"></a><p class="title"><b>Table&nbsp;2.7.&nbsp;Sample authorization</b></p><div class="table-contents"><table summary="Sample authorization" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Time</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Acquirer</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Issuer</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>t<sub>0</sub></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0100 --&gt;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>authorization request</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>t<sub>1</sub></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>&lt;-- 0110</p></td><td style="" align="left" valign="top"><p>authorization response</p></td></tr></tbody></table></div></div><br class="table-break"><p>While this is the typical case (you send a request, you get a response),
sometimes there are temporary failures, and you don&#8217;t get a response.  You have
to reverse the previously transmitted transaction and then either retry your
authorization request, abort that transaction or get an authorization approval
by other means (e.g., by phone) and send an advice.</p><div class="table"><a name="d0e1564"></a><p class="title"><b>Table&nbsp;2.8.&nbsp;Authorization timeout</b></p><div class="table-contents"><table summary="Authorization timeout" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Time</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Acquirer</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Issuer</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>t<sub>0</sub></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0100 --&gt;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>authorization request</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>t<sub>1</sub></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no response</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>t<sub>2</sub></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0400 --&gt;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>reverse previous authorization</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>t<sub>3</sub></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&lt;-- 0410</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>reverse received</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>t<sub>4</sub></p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0120 --&gt;</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>authorization advice</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>t<sub>5</sub></p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top">&nbsp;</td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>&lt;-- 0130</p></td><td style="" align="left" valign="top"><p>advice received</p></td></tr></tbody></table></div></div><br class="table-break"><p>Depending on your particular implementation, you may be able to send
retransmissions as well (e.g., 0101 after an unanswered 0100). Some
implementations use private messages (e.g., 9600)  to request extended time to
process a transaction. So you can see  it is very important to become familiar
with your interchange specifications and its expected message flow as early
as possible.</p><p>jPOS provides tools to deal with message structure, wire protocol and message
flow, but it&#8217;s the responsibility of your higher-level application to interface
the message flow  with your business logic.</p><p>A real example may help you get the idea of what kind of information is
exchanged during an authorization request and response. See below:</p><div class="table"><a name="d0e1665"></a><p class="title"><b>Table&nbsp;2.9.&nbsp;Sample authorization request</b></p><div class="table-contents"><table summary="Sample authorization request" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Fld #</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Comments</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MTI</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0100</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Authorization request</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Primary Account Number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4321123443211234</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Processing Code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Amount transaction</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000000012300</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>e.g., 123.00</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>7</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transmission data/time</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0304054133</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MMYYHHMMSS</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>11</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>System trace audit number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>001205</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>14</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Expiration date</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0205</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>YYMM</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>18</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Merchant Type</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>5399</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>22</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>POS Entry Mode</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>022</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Swiped Card</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>25</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>POS Condition Code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>35</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Track 2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4321123443211234=0205..</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>37</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Retrieval Reference Number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>206305000014</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>41</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Terminal ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>29110001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>42</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Merchant ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1001001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>49</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Currency</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>840</p></td><td style="" align="left" valign="top"><p>US Dollars</p></td></tr></tbody></table></div></div><br class="table-break"><div class="table"><a name="d0e1861"></a><p class="title"><b>Table&nbsp;2.10.&nbsp;Sample authorization response</b></p><div class="table-contents"><table summary="Sample authorization response" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Fld #</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Comments</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MTI</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0110</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Authorization response</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Primary Account Number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4321123443211234</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Processing Code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000000</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Amount transaction</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>000000012300</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>e.g., 123.00</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>7</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transmission data/time</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0304054133</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>MMYYHHMMSS</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>11</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>System trace audit number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>001205</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>14</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Expiration date</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0205</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>YYMM</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>18</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Merchant Type</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>5399</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>22</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>POS Entry Mode</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>022</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Swiped Card</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>25</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>POS Condition Code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>35</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Track 2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4321123443211234=0205..</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>37</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Retrieval Reference Number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>206305000014</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>38</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Authorization number</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>010305</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>39</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Response code</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>00</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Approved</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>41</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Terminal ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>29110001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>42</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Merchant ID</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1001001</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>49</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Currency</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>840</p></td><td style="" align="left" valign="top"><p>US Dollars</p></td></tr></tbody></table></div></div><br class="table-break"></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jposiso"></a>2.2&nbsp;jPOS approach to ISO-8583</h2></div></div></div><p>This chapter describes how jPOS handles ISO-8583 messages.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_isomsg_co"></a>2.2.1&nbsp;ISOMsg &amp; Co.</h3></div></div></div><p>jPOS' internal representation of an ISO-8583 message is usually an ISOMsg
object (or an ISOMsg&#8217;s subclass).</p><p>The ISOMsg class uses the <span class="strong"><strong>Composite pattern</strong></span> (see
Design Patterns, elements of Reusable Object-Oriented Software
by Gamma, Helm, Johnson and Vlissides).</p><p>ISOMsg, ISOField, ISOBitMapField, ISOBinaryField and any custom field type
that you may implement are subclasses of ISOComponent.  Let&#8217;s have a look at
ISOComponent&#8217;s methods:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> ISOComponent <span class="hl-keyword">implements</span> Cloneable {
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> set (ISOComponent c) <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> unset (<span class="hl-keyword">int</span> fldno) <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> ISOComponent getComposite();
        <span class="hl-keyword">public</span> Object getKey() <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> Object getValue() <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] getBytes() <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getMaxField();
        <span class="hl-keyword">public</span> Hashtable getChildren();
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">void</span> setFieldNumber (<span class="hl-keyword">int</span> fieldNumber);
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">void</span> setValue(Object obj) <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">byte</span>[] pack() <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">int</span> unpack(<span class="hl-keyword">byte</span>[] b) <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">void</span> dump (PrintStream p, String indent);
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">void</span> pack (OutputStream out) <span class="hl-keyword">throws</span> IOException, ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">void</span> unpack (InputStream in) <span class="hl-keyword">throws</span> IOException, ISOException;
    }</pre><p>This approach has proven to be really useful and maps quite well to the
ISO-8583 message structure.</p><p>There are many situations where some methods are not applicable (i.e.,
getChildren() has no meaning in a leaf field, same goes for methods such as
getMaxField()), but as a general rule, using the same super-class for ISOMsg
and ISOFields has proven to be a good thing. You can easily assign an ISOMsg as
a field of an outer ISOMsg.</p><p>The following diagram shows how some ISOComponents interact with each other.</p><p><span class="inlinemediaobject"><img src="images/isomsg.jpg" alt="ISOMsg"></span></p><p>The following code can be used to create an internal representation of our 0800
message (described in <a class="link" href="#iso8583" title="2.1&nbsp;An ISO-8583 primer">An ISO-8583 primer</a>).</p><pre class="programlisting">   <span class="hl-keyword">import</span> org.jpos.iso.*;

   ISOMsg m = <span class="hl-keyword">new</span> ISOMsg();
   m.set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">0</span>, <span class="hl-string">"0800"</span>));
   m.set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">3</span>, <span class="hl-string">"000000"</span>));
   m.set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">11</span>, <span class="hl-string">"000001"</span>));
   m.set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">41</span>, <span class="hl-string">"29110001"</span>));
   m.set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">60</span>, <span class="hl-string">"jPOS 6"</span>));
   m.set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">70</span>, <span class="hl-string">"301"</span>));</pre><p>We are just calling <code class="literal">ISOComponent.set (ISOComponent)</code> method.</p><p>In order to reduce typing and improve code readability, ISOMsg provides some
handy methods such as</p><pre class="programlisting">ISOMsg.setMTI (String)</pre><pre class="literallayout">and</pre><pre class="programlisting">ISOMsg.set (<span class="hl-keyword">int</span> fieldNumber, String fieldValue)</pre><p>implemented like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> set (<span class="hl-keyword">int</span> fldno, String value) <span class="hl-keyword">throws</span> ISOException {
        set (<span class="hl-keyword">new</span> ISOField (fldno, value));
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setMTI (String mti) <span class="hl-keyword">throws</span> ISOException {
	<span class="hl-keyword">if</span> (isInner())
	    <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> ISOException (<span class="hl-string">"can't setMTI on inner message"</span>);
	set (<span class="hl-keyword">new</span> ISOField (<span class="hl-number">0</span>, mti));
    }</pre><p>So the previous example can be written like this:</p><pre class="programlisting">    ISOMsg m = <span class="hl-keyword">new</span> ISOMsg();
    m.setMTI (<span class="hl-string">"0800"</span>);
    m.set (<span class="hl-number">3</span>, <span class="hl-string">"000000"</span>);
    m.set (<span class="hl-number">11</span>, <span class="hl-string">"000001"</span>);
    m.set (<span class="hl-number">41</span>, <span class="hl-string">"29110001"</span>);
    m.set (<span class="hl-number">60</span>, <span class="hl-string">"jPOS 6"</span>);
    m.set (<span class="hl-number">70</span>, <span class="hl-string">"301"</span>);</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>ISOMsg is one of the most used classes in typical ISO-8583-based jPOS applications.
While you can subclass it, you probably won&#8217;t have to. If there&#8217;s a single class in
all jPOS that you want to study in great detail, this is it.</p><p>We recommend you to have a look at its
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/iso/ISOMsg.html" target="_top">API documentation </a>
and play with its helper methods such as clone, merge, unset, etc.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_packing_and_unpacking"></a>2.2.2&nbsp;Packing and unpacking</h3></div></div></div><p>ISOComponents have two useful methods called:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">byte</span>[] pack() <span class="hl-keyword">throws</span> ISOException;
    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">int</span> unpack(<span class="hl-keyword">byte</span>[] b) <span class="hl-keyword">throws</span> ISOException;</pre><p><code class="literal">pack</code> returns a <code class="literal">byte[]</code> containing the binary representation of a given
component (can be just a field or the whole ISOMsg);
<code class="literal">unpack</code> does the opposite and also returns the number of consumed
bytes.</p><p>jPOS uses a <span class="strong"><strong>Peer pattern</strong></span> that allows a given ISOComponent to be packed and unpacked
by a peer class, <span class="emphasis"><em>plugged</em></span> at runtime.</p><p>You use</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPackager (ISOPackager p);</pre><p>in order to assign a packager to a given <code class="literal">ISOMsg</code>, e.g.:</p><pre class="programlisting">   ISOPackager customPackager = MyCustomPackager ();
   ISOMsg m = <span class="hl-keyword">new</span> ISOMsg();
   m.setMTI (<span class="hl-string">"0800"</span>);
   m.set (<span class="hl-number">3</span>, <span class="hl-string">"000000"</span>);
   m.set (<span class="hl-number">11</span>, <span class="hl-string">"000001"</span>);
   m.set (<span class="hl-number">41</span>, <span class="hl-string">"29110001"</span>);
   m.set (<span class="hl-number">60</span>, <span class="hl-string">"jPOS 6"</span>);
   m.set (<span class="hl-number">70</span>, <span class="hl-string">"301"</span>);
   m.setPackager (customPackager);
   <span class="hl-keyword">byte</span>[] binaryImage = m.pack();</pre><p>In order to unpack this <code class="literal">binaryImage</code> you may write code like this:</p><pre class="programlisting">   ISOPackager customPackager = MyCustomPackager ();
   ISOMsg m = <span class="hl-keyword">new</span> ISOMsg();
   m.setPackager (customPackager);
   m.unpack (binaryImage);</pre><p>It is very easy to create protocol converters using jPOS, e.g.:</p><pre class="programlisting">   ISOPackager packagerA = MyCustomPackagerA ();
   ISOPackager packagerB = MyCustomPackagerB ();
   ISOMsg m = <span class="hl-keyword">new</span> ISOMsg();
   m.setPackager (packagerA);
   m.unpack (binaryImage);
   m.setPackager (packagerB);
   <span class="hl-keyword">byte</span>[] convertedBinaryImage = m.pack();</pre><p><code class="literal">ISOMsg.pack()</code> delegates message packing/unpacking operations
to its underlying "peer" ISOPackager. The code looks like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] pack() <span class="hl-keyword">throws</span> ISOException {
        <span class="hl-keyword">synchronized</span> (<span class="hl-keyword">this</span>) {
            recalcBitMap();
            <span class="hl-keyword">return</span> packager.pack(<span class="hl-keyword">this</span>);
        }
    }</pre><p><code class="literal">packager.pack(ISOComponent)</code> also delegates its packing/unpacking duties to an
underlying <code class="literal">ISOFieldPackager</code>. There are <code class="literal">ISOFieldPackager</code> implementations for many
different ways of representing a field. It is very easy to create your own, if required.</p><p>The following code is used by an <code class="literal">ISOFieldPackager</code> implementation to pack and unpack
fixed-length alphanumeric fields:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] pack (ISOComponent c) <span class="hl-keyword">throws</span> ISOException {
        String s = (String) c.getValue();
        <span class="hl-keyword">if</span> (s.length() &gt; getLength())
            s = s.substring(<span class="hl-number">0</span>, getLength());
        <span class="hl-keyword">return</span> (ISOUtil.strpad (s, getLength())).getBytes();
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> unpack (ISOComponent c, <span class="hl-keyword">byte</span>[] b, <span class="hl-keyword">int</span> offset)
        <span class="hl-keyword">throws</span> ISOException
    {
        c.setValue(<span class="hl-keyword">new</span> String(b, offset, getLength()));
        <span class="hl-keyword">return</span> getLength();
    }</pre><p>jPOS comes with many <code class="literal">ISOFieldPackager</code> implementations so you&#8217;ll probably
never have to write your own. Names chosen are somewhat cryptic, though.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Many people are using them for their own custom packagers so we&#8217;ll probably
have to live with those names for a while.</p></td></tr></table></div><p>As a general rule, all <code class="literal">ISOFieldPackagers</code> live under package <code class="literal">org.jpos.iso</code>
and start with the name <span class="strong"><strong><code class="literal">IF</code></strong></span> which stands for "ISO Field", but that&#8217;s just
an arbitrary naming convention. You can name and place your own ISOFieldPackager
implementations at your will.</p><p>So we have things like this:</p><div class="table"><a name="d0e2241"></a><p class="title"><b>Table&nbsp;2.11.&nbsp;ISOFieldPackagers</b></p><div class="table-contents"><table summary="ISOFieldPackagers" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Purpose</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IF_CHAR</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Fixed length alphanumeric (ASCII)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFE_CHAR</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Fixed length alphanumeric (EBCDIC)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFA_NUMERIC</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Fixed length numeric (ASCII)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFE_NUMERIC</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Fixed length numeric (EBCDIC)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFB_NUMERIC</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Fixed length numeric (BCD)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFB_LLNUM</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Variable length numeric (BCD, maxlength=99)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFB_LLLNUM</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Variable length numeric (BCD, maxlength=999)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>IFB_LLLLNUM</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Variable length numeric (BCD, maxlength=9999)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#8230;&#8203;</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#8230;&#8203;</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>&#8230;&#8203;</p></td><td style="" align="left" valign="top"><p>&#8230;&#8203;</p></td></tr></tbody></table></div></div><br class="table-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_creating_custom_packagers"></a>2.2.3&nbsp;Creating custom packagers</h3></div></div></div><p>jPOS provides the ability to create customized packagers for different kind of
ISO-8583 implementations. Over the last few years, several developers have
contributed their customized ISOPackagers and ISOFieldPackagers, so chances are
good that you can find an implementation suitable for you, or something very
close to what you need as part of jPOS distribution.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Before writing your own packager, have a look at the classes under
<code class="literal">jpos/src/main/java/org/jpos/iso/packager</code> directory.</p></td></tr></table></div><p>Writing a packager is very easy. There&#8217;s a support class called ISOBasePackager
that you can easily extend, e.g.:</p><pre class="screen">public class ISO93APackager extends ISOBasePackager {
    protected ISOFieldPackager fld[] = {
    /*000*/ new IFA_NUMERIC (  4, "Message Type Indicator"),
    /*001*/ new IFA_BITMAP  ( 16, "Bitmap"),
    /*002*/ new IFA_LLNUM   ( 19, "Primary Account number"),
    /*003*/ new IFA_NUMERIC (  6, "Processing Code"),
    /*004*/ new IFA_NUMERIC ( 12, "Amount, Transaction"),
    /*005*/ new IFA_NUMERIC ( 12, "Amount, Reconciliation"),
    ...
    ...
    ...
    public ISO93APackager() {
        super();
        setFieldPackager(fld);
    }
}</pre><p>So the programmer&#8217;s task (BTW, an easy but boring one) is to verify that  every
single field in your packager configuration matches your interchange
specifications.</p><p>An ISOPackager is not required to extend the supporting class ISOBasePackager,
but we&#8217;ve found it quite convenient for most situations.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>while you write your own packager implementation, we recommend you to write a
unit test for it. Have a look at the <code class="literal">jpos/src/test/java/org/jpos/iso/&#8230;&#8203;</code> directory
to find some sample unit tests that can be used as a starting point.</p></td></tr></table></div><p>After adding several packagers to our repository, jPOS developer Eoin Flood
came up with a good idea: a <span class="emphasis"><em>GenericPackager</em></span>  that one could configure by
means of an XML file. The GenericPackager configuration looks like this:</p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;!DOCTYPE isopackager PUBLIC
        "-//jPOS/jPOS Generic Packager DTD 1.0//EN"
        "http://jpos.org/dtd/generic-packager-1.0.dtd"&gt;

&lt;!-- ISO 8583:1993 (ASCII) field descriptions for GenericPackager --&gt;

&lt;isopackager&gt;
  &lt;isofield
      id="0"
      length="4"
      name="Message Type Indicator"
      class="org.jpos.iso.IFA_NUMERIC"/&gt;
  &lt;isofield
      id="1"
      length="16"
      name="Bitmap"
      class="org.jpos.iso.IFA_BITMAP"/&gt;
  &lt;isofield
      id="2"
      length="19"
      name="Primary Account number"
      class="org.jpos.iso.IFA_LLNUM"/&gt;
  &lt;isofield
      id="3"
      length="6"
      name="Processing Code"
      class="org.jpos.iso.IFA_NUMERIC"/&gt;
  &lt;isofield
      id="4"
      length="12"
      name="Amount, Transaction"
      class="org.jpos.iso.IFA_NUMERIC"/&gt;
  &lt;isofield
      id="5"
      length="12"
      name="Amount, Reconciliation"
      class="org.jpos.iso.IFA_NUMERIC"/&gt;
  &lt;isofield
      id="6"
      length="12"
      name="Amount, Cardholder billing"
      class="org.jpos.iso.IFA_NUMERIC"/&gt;
      ...
      ...
      ...
&lt;/isopackager&gt;</pre><p>We now have XML configurations for most packagers under the
<code class="literal">org.jpos.iso.packager</code> package. They are available in the
<code class="literal">jpos/src/main/resources/packager</code> directory.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you are to develop a custom packager, we encourage you to use
GenericPackager with a suitable custom configuration file instead.
It will greately simplify your task.</p><p>If you&#8217;re using Q2 to configure your packagers, GenericPackager
uses the "packager-config" property in order to determine its
configuration file.</p><p>The XML based packager configuration can be either placed
in the operating system or inside a jar within the classpath,
GenericPackager has the ability to read it as a resource.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you need support for nested messages, you may want to have
a look at <code class="literal">jpos/src/main/resources/org/jpos/iso/packager/genericpackager.dtd</code>
as well as examples such as <code class="literal">jpos/src/dist/cfg/packager/base1.xml</code>
(see field 127).</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_managing_the_wire_protocol_with_isochannel"></a>2.2.4&nbsp;Managing the wire protocol with ISOChannel</h3></div></div></div><p>jPOS uses an interface called <code class="literal">ISOChannel</code> to encapsulate wire protocol details.</p><p><code class="literal">ISOChannel</code> is used to send and receive <code class="literal">ISOMsg</code> objects. It leverages the <span class="strong"><strong>peer
pattern</strong></span>  where its <span class="emphasis"><em>peer</em></span> is an <code class="literal">ISOPackager</code> instance. It has <code class="literal">send</code> and <code class="literal">receive</code>
methods as well as means to <code class="literal">set</code> and <code class="literal">get</code> a peer packager:</p><pre class="programlisting">    ...
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> send (ISOMsg m) <span class="hl-keyword">throws</span> IOException, ISOException;
    <span class="hl-keyword">public</span> ISOMsg receive() <span class="hl-keyword">throws</span> IOException, ISOException;
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setPackager(ISOPackager p);
    <span class="hl-keyword">public</span> ISOPackager getPackager();
    ...</pre><p>Although not meaningful under all possible situations, <code class="literal">ISOChannel</code> has a few
connection-related methods as well:</p><pre class="programlisting">    ...
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> connect () <span class="hl-keyword">throws</span> IOException;
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> disconnect () <span class="hl-keyword">throws</span> IOException;
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> reconnect() <span class="hl-keyword">throws</span> IOException;
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setUsable(<span class="hl-keyword">boolean</span> b);
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isConnected();
    ...</pre><p>In order for applications to bind jPOS components at runtime, there&#8217;s a
Singleton class called <code class="literal">org.jpos.util.NameRegistrar</code> where you
can register and get references to Objects. The ISOChannel interface provides
handy methods to access ISOChannels at runtime by their name.</p><pre class="programlisting">    ...
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName (String name);
    <span class="hl-keyword">public</span> String getName();
    ...</pre><p>ISOChannel extends ISOSource which reads like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ISOSource {
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> send (ISOMsg m)
            <span class="hl-keyword">throws</span> IOException, ISOException, VetoException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isConnected();
    }</pre><p>Different interchanges use different wire protocols. jPOS encapsulates that
functionality in completely isolated ISOChannel implementations. It comes with
many implementations and it&#8217;s easy to write your own, perhaps taking advantage
of the <code class="literal">BaseChannel</code> as a super class.</p><div class="table"><a name="d0e2441"></a><p class="title"><b>Table&nbsp;2.12.&nbsp;Sample ISOChannel implementations</b></p><div class="table-contents"><table summary="Sample ISOChannel implementations" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ASCIIChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4 bytes message length plus ISO-8583 data</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LogChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Can be used to read jPOS&#8217;s logs and inject messages into other channels</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LoopbackChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Every message sent gets received (possibly applying filters).
 Very useful for testing purposes.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PADChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Used to connect to X.25 packet assembler/dissamblers</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>XMLChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jPOS Internal XML representation for ISO-8583 messages</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#8230;&#8203;</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>&#8230;&#8203;</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>&#8230;&#8203;</p></td><td style="" align="left" valign="top"><p>&#8230;&#8203;</p></td></tr></tbody></table></div></div><br class="table-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>(see <code class="literal">org.jpos.iso.channel.\*</code> for a complete list)</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Out of all channel implementations, PADChannel deserves a special note.
Most TCP/IP based ISO-8583 wire protocol implementations use some kind
of indicator to easily detect message bounderies. Most of them use a
packet length header so the receiving implementation can tell apart
a given ISO-8583 packet from the next one.</p><p>On the other hand, implementations that do not use any message boundary
indicator are typically migrations from older packet-based networks such as
X.25 and assume that a given ISO-8583 packet will come in a single TCP/IP
packet, which is <span class="strong"><strong>absolutely wrong</strong></span>. Intermediate networks may split packets
(depending on the MTUs involved) or join packets on retransmissions.</p><p>PADChannel use no message boundary indicator, it reads the ISO-8583 message
on-the-fly. It does the right thing. Unfortunately, unless you have another
PADChannel on the other endpoint, you&#8217;ll probably have to deal with the problem
mentioned in the previous paragraph.</p></td></tr></table></div><div class="example"><a name="d0e2519"></a><p class="title"><b>Example&nbsp;2.1.&nbsp;ISOChannel example</b></p><div class="example-contents"><pre class="programlisting">    <span class="hl-keyword">import</span> org.jpos.iso.*;
    <span class="hl-keyword">import</span> org.jpos.util.*;
    <span class="hl-keyword">import</span> org.jpos.iso.channel.*;
    <span class="hl-keyword">import</span> org.jpos.iso.packager.*;

    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Test {
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main (String[] args) <span class="hl-keyword">throws</span> Exception {
            Logger logger = <span class="hl-keyword">new</span> Logger();
            logger.addListener (<span class="hl-keyword">new</span> SimpleLogListener (System.out));
            ISOChannel channel = <span class="hl-keyword">new</span> ASCIIChannel (
                <span class="hl-string">"localhost"</span>, <span class="hl-number">7</span>, <span class="hl-keyword">new</span> ISO87APackager()
            );
            ((LogSource)channel).setLogger (logger, <span class="hl-string">"test-channel"</span>);
            channel.connect ();

            ISOMsg m = <span class="hl-keyword">new</span> ISOMsg ();
            m.setMTI (<span class="hl-string">"0800"</span>);
            m.set (<span class="hl-number">3</span>, <span class="hl-string">"000000"</span>);
            m.set (<span class="hl-number">41</span>, <span class="hl-string">"00000001"</span>);
            m.set (<span class="hl-number">70</span>, <span class="hl-string">"301"</span>);
            channel.send (m);
            ISOMsg r = channel.receive ();
            channel.disconnect ();
        }
    }</pre></div></div><br class="example-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>While we&#8217;ll see many examples similar to the previous one throughout this
document, where a simple main() method takes care of instantiating and
configuring several jPOS components, later we&#8217;ll introduce <span class="strong"><strong>Q2</strong></span>, jPOS&#8217;s
component assembler. We <span class="strong"><strong>strongly recommend</strong></span> to use Q2 to run
jPOS. It will make your life easier.</p><p>Q2 lets you define your jPOS-based application in a very simple, easy to create
and easy to maintain set of XML configuration files.</p><p>We recommend that you wait until we talk about Q2 before diving into coding
your own jPOS-based application. Using code like the previous example is good
to learn jPOS but not to run it in a production environment.</p><p>In addition, you usually don&#8217;t deal directly with a channel using its <code class="literal">send</code>
and <code class="literal">receive</code> methods. You typically interact with it via a multiplexer (<code class="literal">MUX</code>)
or a server (<code class="literal">ISOServer</code>).</p></td></tr></table></div><p>If you have a look at the ISOChannel implementations (most of them live in
org.jpos.iso.channel package) you&#8217;ll notice that many of them extend
<code class="literal">org.jpos.iso.BaseChannel</code>.</p><p>BaseChannel is an abstract class that provides hooks and default
implementations for several methods that are useful when writing custom
channels. While you don&#8217;t necesarily have to extend BaseChannel to write a
custom channel, you&#8217;ll probably find it very useful.</p><p>Depending on your wire protocol, you&#8217;ll probably only need to extend
BaseChannel and just override a few methods, e.g.:</p><pre class="programlisting">   <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> sendMessageLength(<span class="hl-keyword">int</span> len) <span class="hl-keyword">throws</span> IOException;
   <span class="hl-keyword">protected</span> <span class="hl-keyword">int</span> getMessageLength() <span class="hl-keyword">throws</span> IOException, ISOException;</pre><p>(see jpos/src/main/java/org/jpos/iso/channel/CSChannel.java for an example).</p><p>You may also want to have a look at the LoopbackChannel implementation for an
example of an ISOChannel that doesn&#8217;t extend BaseChannel.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="isofilter"></a>Filtered Channels</h4></div></div></div><p>Many ISOChannels implement <code class="literal">FilteredChannel</code> which looks like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FilteredChannel <span class="hl-keyword">extends</span> ISOChannel {
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addIncomingFilter (ISOFilter filter);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addOutgoingFilter (ISOFilter filter);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addFilter (ISOFilter filter);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeFilter (ISOFilter filter);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeIncomingFilter (ISOFilter filter);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeOutgoingFilter (ISOFilter filter);
        <span class="hl-keyword">public</span> Collection getIncomingFilters();
        <span class="hl-keyword">public</span> Collection getOutgoingFilters();
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setIncomingFilters (Collection filters);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setOutgoingFilters (Collection filters);
    }</pre><p>The <code class="literal">ISOFilter</code> interface is very simple as well:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ISOFilter {
        <span class="hl-keyword">public</span> ISOMsg filter (ISOChannel channel, ISOMsg m, LogEvent evt)
            <span class="hl-keyword">throws</span> VetoException;
        }
    }</pre><p>Whenever you add a filter (be it incoming, outgoing, or both) to a
FilteredChannel, all messages sent or received by that channel are passed
through that filter.</p><p>Filters give you the opportunity to stop a given message from being sent or
received by that channel, by throwing an ISOFilter.VetoException.</p><p>Let&#8217;s have a look at a very simple filter, DelayFilter:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DelayFilter <span class="hl-keyword">implements</span> ISOFilter, ReConfigurable {
        <span class="hl-keyword">long</span> delay;
        <span class="hl-keyword">public</span> DelayFilter() {
            <span class="hl-keyword">super</span>();
            delay = <span class="hl-number">0L</span>;
        }
       <strong class="hl-tag" style="color: blue">/**
        * @param delay desired delay, expressed in milliseconds
        */</strong>
        <span class="hl-keyword">public</span> DelayFilter(<span class="hl-keyword">long</span> delay) {
            <span class="hl-keyword">super</span>();
            <span class="hl-keyword">this</span>.delay = delay;
        }
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setConfiguration (Configuration cfg) {
            delay = cfg.getInt (<span class="hl-string">"delay"</span>);
        }
        <span class="hl-keyword">public</span> ISOMsg filter (ISOChannel channel, ISOMsg m, LogEvent evt)
        {
            evt.addMessage (<span class="hl-string">"&lt;delay-filter delay=\""</span>+delay+<span class="hl-string">"\"/&gt;"</span>);
            <span class="hl-keyword">if</span> (delay &gt; <span class="hl-number">0L</span>)
                ISOUtil.sleep(delay);
            <span class="hl-keyword">return</span> m;
        }
    }</pre><p>DelayFilter simply applies a given delay to all traffic being sent or received
by a given channel. It can be used to simulate remote host delays, a good tool
for testing purposes.</p><p>But the filter method has the ability to modify the <code class="literal">ISOMsg</code> object or to
just replace it with a new one. A handy <code class="literal">LogEvent</code> is provided for log/audit
purposes.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The previous code introduces a few classes and interfaces, namely
<code class="literal">Configuration</code>, <code class="literal">LogEvent</code>. We&#8217;ll talk about these
important parts of jPOS soon.</p></td></tr></table></div><p>jPOS comes with many general purpose filters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">MD5Filter</code> can be used to authenticate messages;</li><li class="listitem"><code class="literal">MacroFilter</code> can be used  to expand internal variables and sequencers; and</li><li class="listitem"><code class="literal">XSLTFilter</code> can be used to apply XSLT Transformations to ISO-8583 messages.</li></ul></div><p>There&#8217;s a popular filter called <code class="literal">BSHFilter</code> that can execute <a class="link" href="http://www.beanshell.org" target="_top">BeanShell</a>
code placed in an external file that can be modified at runtime without restarting
the system, providing an excellent way to make quick changes (which are welcome
during tests and initial rounds of certifications - the BSH code can be easily
migrated to Java later).</p><div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/admon/caution.png"></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>We&#8217;ve seen full applications implemented as BSH-based filters.
Those are very difficult to maintain and are significantly slower
than business logic implemented in Java code. We encourage you
to use this handy scripting capability as a tool for hot-fixes
and testing and remember to move the code to Java as soon as
you can.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="isoserver"></a>2.2.5&nbsp;Accepting connections with ISOServer</h3></div></div></div><p><code class="literal">ISOServer</code> listens in a given port for incoming connections and takes care of
accepting them and passing control to an underlying ISOChannel implementation.</p><p>Once a new connection is accepted and an ISOChannel is created, a
ThreadPool-controlled Thread takes care of receiving messages from it.
Those messages are passed to an ISORequestListener implementation.</p><div class="example"><a name="d0e2648"></a><p class="title"><b>Example&nbsp;2.2.&nbsp;ISOServer</b></p><div class="example-contents"><pre class="screen">import org.jpos.iso.*;
import org.jpos.util.*;
import org.jpos.iso.channel.*;
import org.jpos.iso.packager.*;

public class Test {
    public static void main (String[] args) throws Exception {
        Logger logger = new Logger ();
        logger.addListener (new SimpleLogListener (System.out));
        ServerChannel channel = new XMLChannel (new XMLPackager());
        ((LogSource)channel).setLogger (logger, "channel");
        ISOServer server = new ISOServer (8000, channel, null);
        server.setLogger (logger, "server");
        new Thread (server).start ();
    }
}</pre></div></div><br class="example-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The third argument of ISOServer&#8217;s constructor is an optional
ThreadPool. Should you pass a null parameter there, a new ThreadPool
is created for you, which defaults to 100 threads.
(<code class="literal">new ThreadPool (1,100)</code>)</p><p>Once again, we show this sample code for
educational purposes. In real life applications, you
want to use Q2&#8217;s <code class="literal">QServer</code> component instead.</p></td></tr></table></div><p>In order to test the previous server Test program (which is listening on port
8000), you can use a simple <span class="emphasis"><em>telnet</em></span> client where you will be able to type an
XML-formatted ISO-8583 message, e.g.:</p><pre class="screen">   $ telnet localhost 8000
   Trying 127.0.0.1...
   Connected to localhost.
   Escape character is '^]'.</pre><p>Now if you have a look at your running Test program you&#8217;ll see something like this:</p><pre class="programlisting">    <span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"server"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Fri May 17 08:11:34 UYT 2002.824"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;iso-server&gt;</span>
            listening on port 8000
        <span class="hl-tag">&lt;/iso-server&gt;</span>
    <span class="hl-tag">&lt;/log&gt;</span></pre><p>Back on your telnet session, you can type in an
XML formatted ISO-8583 message like this:</p><pre class="programlisting">   <span class="hl-tag">&lt;isomsg&gt;</span>
    <span class="hl-tag">&lt;field</span> <span class="hl-attribute">id</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0800"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;field</span> <span class="hl-attribute">id</span>=<span class="hl-value">"3"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"333333"</span><span class="hl-tag">/&gt;</span>
   <span class="hl-tag">&lt;/isomsg&gt;</span></pre><p>(please note XMLChannel expects &lt;isomsg&gt; as well as &lt;/isomsg&gt; to be placed as
the first thing in a line)</p><p>Your test program will then show:</p><pre class="programlisting">    <span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"server.channel"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Fri May 17 07:56:58 UYT 2002.407"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;receive&gt;</span>
      <span class="hl-tag">&lt;isomsg</span> <span class="hl-attribute">direction</span>=<span class="hl-value">"incoming"</span><span class="hl-tag">&gt;</span>
       <span class="hl-tag">&lt;field</span> <span class="hl-attribute">id</span>=<span class="hl-value">"0"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0800"</span><span class="hl-tag">/&gt;</span>
       <span class="hl-tag">&lt;field</span> <span class="hl-attribute">id</span>=<span class="hl-value">"3"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"333333"</span><span class="hl-tag">/&gt;</span>
      <span class="hl-tag">&lt;/isomsg&gt;</span>
     <span class="hl-tag">&lt;/receive&gt;</span>
    <span class="hl-tag">&lt;/log&gt;</span></pre><p>As stated above, you can add an ISORequestListener to your ISOServer that will
take care of actually processing the incoming messages. So let&#8217;s modify our
little Test program to answer our messages. Our Test class has to implement
ISORequestListener, e.g.:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Test <span class="hl-keyword">implements</span> ISORequestListener {
    ...
    ...
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> process (ISOSource source, ISOMsg m) {
        <span class="hl-keyword">try</span> {
            m.setResponseMTI ();
            m.set (<span class="hl-number">39</span>, <span class="hl-string">"00"</span>);
            source.send (m);
        } <span class="hl-keyword">catch</span> (ISOException e) {
            e.printStackTrace();
        } <span class="hl-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        <span class="hl-keyword">return</span> true;
    }
    ...
    ...
}</pre><p>You have to assign this request listener to your server. You can do  this
assignment with the following instruction:</p><pre class="programlisting">    server.addISORequestListener (<span class="hl-keyword">new</span> Test ());</pre><p>The full program looks like this:</p><pre class="programlisting"><span class="hl-keyword">import</span> java.io.*;
<span class="hl-keyword">import</span> org.jpos.iso.*;
<span class="hl-keyword">import</span> org.jpos.util.*;
<span class="hl-keyword">import</span> org.jpos.iso.channel.*;
<span class="hl-keyword">import</span> org.jpos.iso.packager.*;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Test <span class="hl-keyword">implements</span> ISORequestListener {
    <span class="hl-keyword">public</span> Test () {
        <span class="hl-keyword">super</span>();
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> process (ISOSource source, ISOMsg m) {
        <span class="hl-keyword">try</span> {
            m.setResponseMTI ();
            m.set (<span class="hl-number">39</span>, <span class="hl-string">"00"</span>);
            source.send (m);
        } <span class="hl-keyword">catch</span> (ISOException e) {
            e.printStackTrace();
        } <span class="hl-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        <span class="hl-keyword">return</span> true;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main (String[] args) <span class="hl-keyword">throws</span> Exception {
        Logger logger = <span class="hl-keyword">new</span> Logger ();
        logger.addListener (<span class="hl-keyword">new</span> SimpleLogListener (System.out));
        ServerChannel channel = <span class="hl-keyword">new</span> XMLChannel (<span class="hl-keyword">new</span> XMLPackager());
        ((LogSource)channel).setLogger (logger, <span class="hl-string">"channel"</span>);
        ISOServer server = <span class="hl-keyword">new</span> ISOServer (<span class="hl-number">8000</span>, channel, null);
        server.setLogger (logger, <span class="hl-string">"server"</span>);
        server.addISORequestListener (<span class="hl-keyword">new</span> Test ());
        <span class="hl-keyword">new</span> Thread (server).start ();
    }
}</pre><p>Now try to telnet to port 8000 and send another XML-formatted ISO-8583 message.
You&#8217;ll get a response, with a result code "00" (field 39), e.g.:</p><pre class="screen">    (you type)
    &lt;isomsg&gt;
     &lt;field id="0" value="0800"/&gt;
     &lt;field id="3" value="333333"/&gt;
    &lt;/isomsg&gt;

    (and you should receive)
    &lt;isomsg direction="outgoing"&gt;
      &lt;field id="0" value="0810"/&gt;
      &lt;field id="3" value="333333"/&gt;
      &lt;field id="39" value="00"/&gt;
    &lt;/isomsg&gt;</pre><p>ISOServer uses a ThreadPool in order to be able to accept multiple connections
at the same time. Every socket connection is handled by a single thread.  If
your request listener implementation takes too long to reply, new messages
arriving over that session will have to wait for their response.</p><p>To solve this problem, your ISORequestListener implementation should run in its
own thread pool so that its process(&#8230;&#8203;) method will just queue requests to be
processed by a peer thread.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Before worrying too much about handling simultaneous transactions, you&#8217;ll be
happy to know that jPOS has a <code class="literal">TransactionManager</code> that deals with that.
We&#8217;ll cover it very soon, keep reading.</p></td></tr></table></div><p>ISOServer uses ISOChannel implementations to pull ISOMsgs from the wire.  These
ISOChannels can, of course, have associated filters as described earlier.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In modern jPOS applications ISOServer is usually managed by the
QServer service (see QServer).
The ISORequestListener is usually a thin implementation
that forwards the request to the TransactionManager.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="multiplexing_with_mux"></a>2.2.6&nbsp;Multiplexing an ISOChannel with a MUX</h3></div></div></div><p>Imagine an acquirer implementation that receives several requests at a time
from several POS terminals and has to route them to an issuer institution by
means of an ISOChannel.</p><p>While you can establish one socket connection per transaction, it is common use
to setup just one socket connection (handled by an ISOChannel instance) and
multiplex it.</p><p>So a MUX is basically a <span class="strong"><strong>channel multiplexer</strong></span>.
Once you have instantiated a MUX, you just send a request and wait for the response.</p><p>Originally, the MUX interface look like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MUX {
        <span class="hl-keyword">public</span> ISOMsg request (ISOMsg m, <span class="hl-keyword">long</span> timeout) <span class="hl-keyword">throws</span> ISOException;
        <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isConnected();
    }</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The <code class="literal">ISOMsg request(ISOMsg, long)</code> method queues
a request to be sent by the underlying ISOChannel(s) and waits for
the response up to the timeout specified in milliseconds. It either
returns a response or null.</li><li class="listitem"><code class="literal">isConnected()</code> is self explanatory, it returns
true if the underlying channel(s) are connected.</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>MUX is an interface that can have many different implementations.
Depending on the implementation and the configuration the
value returned by <code class="literal">isConnected()</code> might not
be reliable (it could return true even on an unconnected channel).</p></td></tr></table></div><p>Recently <a href="#ftn.d0e2752" class="footnote" name="d0e2752"><sup class="footnote">[1]</sup></a> we&#8217;ve added the ability to asynchronously queue requests,
the new MUX interface has another <code class="literal">request</code> method that returns immediately and calls
an ISOResponseListener (with an optional handBack Object).</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MUX {
        ...
        ...
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> request
            (ISOMsg m, <span class="hl-keyword">long</span> timeout, ISOResponseListener r, Object handBack)
        <span class="hl-keyword">throws</span> ISOException;
    }</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This new asynchronous way of calling the MUX is available in the
<code class="literal">QMUX</code> implementation of the <code class="literal">MUX</code> interface but it has not been
back-ported to the <code class="literal">ISOMUX</code> implementation which is going to be
deprecated in future versions of jPOS.
ISOMUX has a <code class="literal">queue</code> method that can be used to achieve a similar asynchronous
behavior.</p></td></tr></table></div><p>In order to send responses to the appropriate sending thread, a <code class="literal">MUX</code>
implementation uses selected fields from the original <code class="literal">ISOMsg</code> request
expected to be present in the <code class="literal">ISOMsg</code> response. Although not part of the
<code class="literal">MUX</code> interface, implementations such as QMUX (the new one) and ISOMUX
(the old one) have a protected method called <code class="literal">String getKey(ISOMsg m)</code> that
returns a matching key based on the <code class="literal">ISOMsg</code> content.</p><p>QMUX reads an XML file that honors a <code class="literal">&lt;key&gt;nn,nn,nn&lt;/key&gt;</code> child element
and can be used to easily set the appropriate matching key.</p><p>The default implementation uses fields such as 41 (Terminal ID) plus field 11
(Serial Trace Audit Number) to create an unique key. You can override
<code class="literal">getKey()</code> in order to use other fields.</p><div class="example"><a name="d0e2806"></a><p class="title"><b>Example&nbsp;2.3.&nbsp;MUX example</b></p><div class="example-contents"><pre class="programlisting">    ...
    ...
    MUX mux = (MUX) NameRegister.get (<span class="hl-string">"mux.mymultiplexer"</span>);
    ...
    ...</pre><pre class="programlisting">    ISOMsg m = <span class="hl-keyword">new</span> ISOMsg();
    m.setMTI (<span class="hl-string">"0800"</span>);
    m.set (<span class="hl-number">11</span>, <span class="hl-string">"000001"</span>);
    m.set (<span class="hl-number">41</span>, <span class="hl-string">"00000001"</span>);
    ISOMsg response = mux.request (m, <span class="hl-number">30000</span>);
    <span class="hl-keyword">if</span> (response != null) {
        <span class="hl-comment">// you've got a response</span>
    } <span class="hl-keyword">else</span> {
        <span class="hl-comment">// request has timed out</span>
        <span class="hl-comment">// you may want to reverse or retransmit</span>
    }</pre></div></div><br class="example-break"><p>When a message arrives to MUX&#8217;s underlying ISOChannel, the MUX implementation
checks to see if that message&#8217;s <span class="emphasis"><em>key</em></span> is registered as a pending request.</p><p>Should that key match a pending request, the response is handed to the waiting
thread. If the key was registered as a request, or the response comes in too
late then that response is (depending on the configuration) ignored, forwarded
to an ISORequestListener or to a well defined Space queue. (see QMUX for
details).</p><p>Under many situations, the same channel that a client application may use to
send requests and wait for responses may also receive requests coming from the
remote server.</p><p>Those <span class="emphasis"><em>unmatched requests</em></span> coming from the remote server are delegated to an
<code class="literal">ISORequestListener</code> (or a well defined "unhandled" Space queue).</p><p>Let&#8217;s have a look at the ISORequestListener interface:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ISORequestListener {
        <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> process (ISOSource source, ISOMsg m);
    }</pre><p>Imagine we want to answer the 0800 echo requests arriving to our MUX.
We can write the following implementation:</p><pre class="programlisting">   <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> EchoHandler <span class="hl-keyword">extends</span> Log
        <span class="hl-keyword">implements</span> ISORequestListener
   {
        <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> process (ISOSource source, ISOMsg m) {
            <span class="hl-keyword">try</span> {
                <span class="hl-keyword">if</span> (<span class="hl-string">"0800"</span>.equals (m.getMTI())) {
                    m.setResponseMTI ();
                    m.set (<span class="hl-number">39</span>, <span class="hl-string">"00"</span>);
                    source.send (m);
                }
            } <span class="hl-keyword">catch</span> (Exception e) {
                warn (<span class="hl-string">"echo-handler"</span>, e);
            }
            <span class="hl-keyword">return</span> true;
        }
   }</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="incoming_filter"></a>2.3&nbsp;IncomingListener</h2></div></div></div><p>As of jPOS 2.1.0, there&#8217;s a new general purpose <code class="literal">ISORequestListener</code>
called <code class="literal">org.jpos.iso.IncomingListener</code> that forwards all incoming
transactions to a space queue, to be picked up by the TransactionManager.</p><p>It honors the following configuration properties:</p><div class="table"><a name="d0e2851"></a><p class="title"><b>Table&nbsp;2.13.&nbsp;IncomingListener Configuration Properties</b></p><div class="table-contents"><table summary="IncomingListener Configuration Properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>queue</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Transaction Manager&#8217;s queue</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>no default, this property is required</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Source Based Timeout</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>15000ms, set to 0 to disable</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>source</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Places <code class="literal">ISOSource</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SOURCE</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Places <code class="literal">ISOMsg</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REQUEST</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timestamp</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Context creation timestamp</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TIMESTAMP</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>space</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Spaces to use when queuing transaction</p></td><td style="" align="left" valign="top"><p>"" (default space)</p></td></tr></tbody></table></div></div><br class="table-break"><p>In addition to the previous configuration properties, <code class="literal">IncomingListener</code> places
in the context any additional optional property starting with the prefix <code class="literal">ctx.</code>,
so for example, if a server or mux uses a request listener configured to handle
transactions from a given endpoing "XYZ", a property called <code class="literal">ctx.XYZ</code> can be
added to the configuration and will be available to the transaction participants,
i.e.:</p><pre class="programlisting"><span class="hl-tag">&lt;mux</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QMUX"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"postilion"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;in&gt;</span>receive<span class="hl-tag">&lt;/in&gt;</span>
  <span class="hl-tag">&lt;out&gt;</span>send<span class="hl-tag">&lt;/out&gt;</span>
  <span class="hl-tag">&lt;readychannel.ready&lt;</span>/ready&gt;

  <span class="hl-tag">&lt;request-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IncomingListener"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span>
     <span class="hl-attribute">realm</span>=<span class="hl-value">"incoming-listener"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span>   <span class="hl-attribute">value</span>=<span class="hl-value">"JPTS.TXN"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ctx.STATION"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"SS_XYZ"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ctx.PORT"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1234"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/request-listener&gt;</span>
<span class="hl-tag">&lt;/mux&gt;</span></pre><p>The <code class="literal">Context</code> queued to the <code class="literal">JPTS.TXN</code> queue would have the following properties:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">STATION</code> with a value of <code class="literal">SS_XYZ</code></li><li class="listitem"><code class="literal">PORT</code> with a value of <code class="literal">1234</code></li></ul></div><p>as well as the entries <code class="literal">SOURCE</code>, <code class="literal">REQUEST</code>, <code class="literal">TIMESTAMP</code> and also a fresh <code class="literal">PROFILER</code>.</p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d0e2752" class="footnote"><p><a href="#d0e2752" class="simpara"><sup class="simpara">[1] </sup></a>jPOS 1.6.1</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_support_classes"></a>3.&nbsp;Support classes</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="logger"></a>3.1&nbsp;jPOS' Logger</h2></div></div></div><p>Yet another Logger subsystem?</p><p>You may wonder why we&#8217;ve chosen to develop our own Logger subsystem. The
answer is very simple: when we wrote it, there were no other suitable logger
subsystems available. Log4j was just a tiny library hosted in IBM alphaWorks.</p><p>You may wonder why we don&#8217;t deprecate it now that there are other options
available. The main difference between our logger sub-system and other logger
sub-systems out there is that we deal with <span class="strong"><strong>live objects</strong></span>. A LogEvent holds
live objects that can be handled by the LogListeners, for example to protect
sensitive information (PCI requirement) or to act on special conditions (i.e.
e-mailing an Operator on an Exception without having to parse the serialized
message).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>While other logger subsystems are mostly "line oriented", jPOS' is mostly
"transaction oriented". A jPOS LogEvent is likely to carry information for the
whole transaction making it very suitable for audit and debugging purposes.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In order to avoid the initial desire to get rid of the jPOS Logger and
use your the logger you&#8217;re used to use, you may want to consider jPOS'
as an <span class="strong"><strong>Event Logger</strong></span>, or <span class="strong"><strong>Audit Log</strong></span>. We don&#8217;t use it to add debug or
trace statements in applications, we use it to log business related data.</p><p>You can still use your preferred logger subsystem as part of your business
logic.</p></td></tr></table></div><p>jPOS&#8217;s logger subsystem is very easy to extend, so one can easily plug in other
logger engines (such as Log4j, commons logging or the new JDK&#8217;s 1.4 logging
stuff), but that has little use. One of the benefit of our logger is the
fact that it produce easy to read (very lightweight) and easy to parse
XML output. The <code class="literal">LogChannel</code> for example can read a jPOS log file and parse
ISO-8583 messages from it. If you plug another layer of logging on top of it,
the output is likely to add per-line timestamps that will render the file
difficult to parse.</p><p>Our logger is implemented by the following main classes:</p><div class="table"><a name="d0e3020"></a><p class="title"><b>Table&nbsp;3.1.&nbsp;Logger&#8217;s main classes</b></p><div class="table-contents"><table summary="Logger&#8217;s main classes" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Class</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Logger</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Main logger class</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Listens to log events</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LogSource</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A log event producer has to implement LogSource</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>LogEvent</p></td><td style="" align="left" valign="top"><p>The Log Event</p></td></tr></tbody></table></div></div><br class="table-break"><p>The <code class="literal">Logger</code> class has the following important methods:</p><pre class="programlisting">   <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Logger {
      <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> log (LogEvent ev);
      ...
      <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addListener (LogListener l);
      <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeListener (LogListener l);
      <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> hasListeners();
      ...
      ...
   }</pre><p><code class="literal">LogSource</code> looks like this:</p><pre class="programlisting">   <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> LogSource {
      <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setLogger (Logger logger, String realm);
      <span class="hl-keyword">public</span> String getRealm ();
      <span class="hl-keyword">public</span> Logger getLogger ();
   }</pre><p>And <code class="literal">LogEvent</code>:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LogEvent {
       <span class="hl-keyword">public</span> LogEvent (LogSource source, String tag);
       ...
       ...
       <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addMessage (Object msg);
       ...
    }</pre><p>(please take a look at
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/util/LogEvent.html" target="_top">jPOS&#8217;s javadoc</a>
or source code for a full description)</p><p>Here is a simple way to create a Logger:</p><pre class="programlisting">   Logger logger = <span class="hl-keyword">new</span> Logger();
   logger.addListener (<span class="hl-keyword">new</span> SimpleLogListener (System.out));</pre><p>Now you can easily attach that logger to any jPOS component implementing
LogSource such as channels, packagers, multiplexers, etc. You can easily call:</p><pre class="programlisting">   component.setLogger (logger, <span class="hl-string">"some-component-description"</span>);</pre><p>You can use jPOS&#8217;s logger subsystem to log events of your own. In those cases,
you have to either implement LogSource or extend or use the the <code class="literal">org.jpos.util.SimpleLogSource</code>
class or better yet, use the newer <code class="literal">org.jpos.util.Log</code> class.</p><p>Then you can write code like this:</p><pre class="programlisting">   LogEvent evt = <span class="hl-keyword">new</span> LogEvent (yourLogSource, <span class="hl-string">"my-event"</span>);
   evt.addMessage (<span class="hl-string">"A String message"</span>);
   evt.addMessage (anyLoggeableObject);
   Logger.log (evt);</pre><p>The <code class="literal">Loggeable</code> interface is a very simple way of letting an object render itself:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Loggeable {
       <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> dump (PrintStream p, String indent);
    }</pre><p>Most of jPOS&#8217;s components already implement the <code class="literal">Loggeable</code> interface, but you
can easily  wrap any given object with a Loggeable class that holds the former
object as its payload, e.g.:</p><pre class="programlisting"><span class="hl-keyword">package</span> net.swini.util;

<span class="hl-keyword">import</span> java.io.PrintStream;
<span class="hl-keyword">import</span> org.jpos.util.Loggeable;

<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> LoggeableBase <span class="hl-keyword">implements</span> Loggeable {
    <span class="hl-keyword">protected</span> String toXML (String tag, String value, String indent) {
        StringBuffer sb = <span class="hl-keyword">new</span> StringBuffer (indent);
        sb.append (<span class="hl-string">'&lt;'</span>);
        sb.append (tag);
        sb.append (<span class="hl-string">'&gt;'</span>);
        sb.append (value);
        sb.append (<span class="hl-string">"&lt;/"</span>);
        sb.append (tag);
        sb.append (<span class="hl-string">'&gt;'</span>);
        <span class="hl-keyword">return</span> sb.toString ();
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">void</span> dump (PrintStream p, String indent);
}

<span class="hl-keyword">package</span> net.swini.util;

<span class="hl-keyword">import</span> java.io.PrintStream;
<span class="hl-keyword">import</span> net.jini.core.lookup.ServiceItem;
<span class="hl-keyword">import</span> net.jini.lookup.entry.ServiceInfo;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LoggeableServiceItem <span class="hl-keyword">extends</span> LoggeableBase {
    String tag;
    ServiceItem item;
    <span class="hl-keyword">public</span> LoggeableServiceItem (String tag, ServiceItem item) {
        <span class="hl-keyword">super</span>();
        <span class="hl-keyword">this</span>.tag  = tag;
        <span class="hl-keyword">this</span>.item = item;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> dump (PrintStream p, String indent) {
        String inner = indent + <span class="hl-string">"   "</span>;
        p.println (indent + <span class="hl-string">"&lt;"</span> + tag + <span class="hl-string">"&gt;"</span>);

        <span class="hl-keyword">if</span> (item.service != null) {
            p.println (toXML (<span class="hl-string">"class"</span>, item.service.getClass().getName(), inner));
        } <span class="hl-keyword">else</span> {
            p.println (inner + <span class="hl-string">"null item.service - (check http server)"</span>);
        }
        p.println (toXML (<span class="hl-string">"id"</span>, item.serviceID.toString(), inner));

        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> i=<span class="hl-number">0</span> ; i&lt;item.attributeSets.length ; i++) {
            <span class="hl-keyword">if</span> (item.attributeSets[i] <span class="hl-keyword">instanceof</span> ServiceInfo) {
                ServiceInfo info = (ServiceInfo) item.attributeSets[i];
                p.println (toXML (<span class="hl-string">"name"</span>, info.name, inner));
                p.println (toXML (<span class="hl-string">"manufacturer"</span>, info.manufacturer, inner));
                p.println (toXML (<span class="hl-string">"vendor"</span>, info.vendor, inner));
                p.println (toXML (<span class="hl-string">"version"</span>, info.version, inner));
                p.println (toXML (<span class="hl-string">"model"</span>, info.model, inner));
                p.println (toXML (<span class="hl-string">"serial"</span>, info.serialNumber, inner));
            }
            <span class="hl-keyword">else</span> {
                p.println (inner + <span class="hl-string">"&lt;attr&gt;"</span>);
                p.println (inner + <span class="hl-string">"  "</span>+item.attributeSets[i].toString());
                p.println (inner + <span class="hl-string">"&lt;/attr&gt;"</span>);
            }
        }
        p.println (indent + <span class="hl-string">"&lt;/"</span> + tag + <span class="hl-string">"&gt;"</span>);
    }
}</pre><p>There&#8217;s a general purpose Loggeable class called <code class="literal">SimpleMsg</code> which has an
overloaded constructor for several commonly used Java types. You can easily add
a <code class="literal">SimpleMsg</code> to your log stream with code like this:</p><pre class="programlisting">    ...
    ...
    evt.addMessage (<span class="hl-keyword">new</span> SimpleMsg (<span class="hl-string">"demo"</span>, <span class="hl-string">"boolean"</span>, true));
    evt.addMessage (<span class="hl-keyword">new</span> SimpleMsg (<span class="hl-string">"demo"</span>, <span class="hl-string">"time"</span>, System.currentTimeMillis()));
    evt.addMessage (<span class="hl-keyword">new</span> SimpleMsg (<span class="hl-string">"demo"</span>, <span class="hl-string">"dump"</span>, <span class="hl-string">"TEST"</span>.getBytes()));
    ...
    ...</pre><p>jPOS comes with several <code class="literal">LogListener</code> implementations and it&#8217;s very easy to write your own.
The ready available ones include:</p><div class="table"><a name="d0e3135"></a><p class="title"><b>Table&nbsp;3.2.&nbsp;LogListener</b></p><div class="table-contents"><table summary="LogListener" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Class</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SimpleLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Dumps log events to a PrintStream (such as System.out)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RotateLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Automatically rotate logs based on file size and time window</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DailyLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Automatically rotate logs daily. Has the ability to compress old log files</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>OperatorLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Applies some filtering and e-mails log-events to an operator, not longer included in jPOS core, it&#8217;s part of the jPOS-EE mail module</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ProtectedLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Protect sensitive data from ISOMsgs in LogEvents for PCI compliance</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>FSDProtectedLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Same as <code class="literal">ProtectedLogListeer</code> for <code class="literal">FSDMsg</code> and <code class="literal">FSDISOMsg</code> instances.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SysLogListener</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Forward log events to the operating system syslog.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>RealmLogFilter</p></td><td style="" align="left" valign="top"><p>Filter log events by their realm. Enabled or disabled realms can be defined.</p></td></tr></tbody></table></div></div><br class="table-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In the jPOS-EE code base you can find some additional logger
implementations such as IRCLogListener that forwards LogEVents
to an irc channel. In addition, there&#8217;s a LogBack adaptor that
let us capture other loggers output (i.e. log4j, commons-logging,
etc.) into jPOS' log stream. This allows you to use your preferred
logger API in your code while getting the output in a centralized
jPOS file.</p></td></tr></table></div><p>LogListeners are called synchronously, so one listener has the chance to modify a given
LogEvent; for example, <code class="literal">ProtectedLogListener</code> analyzes  received <code class="literal">LogEvents</code> and <span class="strong"><strong>protects</strong></span>
important information (such as track-2 data).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="nameregistrar"></a>3.2&nbsp;NameRegistrar</h2></div></div></div><p><span class="strong"><strong>org.jpos.util.NameRegistrar</strong></span> is a very simple <span class="strong"><strong>singleton</strong></span> class that can be
used to register and locate jPOS components.</p><p>It&#8217;s nothing but a simple, well-known Map where one can easily find components
by an arbitrary name.</p><p>NameRegistrar has the following static methods:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> register (String key, Object value);
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> unregister (String key);
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> Object get (String key)
        <span class="hl-keyword">throws</span> NameRegistrar.NotFoundException;
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> Object getIfExists (String key);</pre><p>So you can write code like this:</p><pre class="programlisting">   ...
   ...
   ISOMUX mux = <span class="hl-keyword">new</span> ISOMUX (...);
   NameRegistrar.register (<span class="hl-string">"myMUX"</span>, mux);
   ...
   ...</pre><p>and elsewhere in your application you can get a reference to your MUX with code like this:</p><pre class="programlisting">     <span class="hl-keyword">try</span> {
        ISOMUX mux = (ISOMUX) NameRegistrar.get (<span class="hl-string">"myMUX"</span>);
     } <span class="hl-keyword">catch</span> (NameRegistrar.NotFoundeException e) {
        ...
        ...
     }</pre><pre class="literallayout">or</pre><pre class="programlisting">    ISOMUX mux = (ISOMUX) NameRegistrar.getIfExists (<span class="hl-string">"myMUX"</span>);
    <span class="hl-keyword">if</span> (mux != null) {
        ...
        ...
    }</pre><p>Although we can use NameRegistrar in order to register jPOS components,
sometimes it&#8217;s better to use the component&#8217;s setName(String name) method when
available.</p><p>Most components have a setName (String name) method implemented like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ISOMUX {
        ...
        ...
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setName (String name) {
            <span class="hl-keyword">this</span>.name = name;
            NameRegistrar.register (<span class="hl-string">"mux."</span>+name, <span class="hl-keyword">this</span>);
        }
        ...
        ...</pre><p>The prefix <code class="literal">"mux."</code> is used here in order to avoid a clash of names in the
registrar between different classes of components using the same name  (e.g.
<code class="literal">"mux.institutionABC"</code>  and  <code class="literal">"channel.institutionABC"</code>).</p><p>Different components use different prefixes as shown in the following table:</p><div class="table"><a name="d0e3274"></a><p class="title"><b>Table&nbsp;3.3.&nbsp;NameRegistrar&#8217;s prefix</b></p><div class="table-contents"><table summary="NameRegistrar&#8217;s prefix" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Component</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Prefix</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Getter</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ConnectionPool</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"connection.pool."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ControlPanel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"panel."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>DirPoll</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"qsp.dirpoll."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>BaseChannel</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"channel."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>BaseChannel.getChannel</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ISOMUX</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"mux."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ISOMUX.getMUX</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>QMUX</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"mux."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>QMUX.getMUX</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ISOServer</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"server."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ISOServer.getServer</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>KeyStore</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"keystore."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Logger</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"logger."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Logger.getLogger</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LogListener</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"log-listener."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PersistentEngine</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>"persistent.engine."</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>N/A</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>SMAdapter</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>"s-m-adapter."</p></td><td style="" align="left" valign="top"><p>BaseSMAdapter.getSMAdapter</p></td></tr></tbody></table></div></div><br class="table-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>While we try to keep the previous prefix table up to date, we suggest that
you double-check it against the source code if you have problems getting
references to your components.</p></td></tr></table></div><p>Using the getter (when available) lets us write code like this:</p><pre class="programlisting">     <span class="hl-keyword">try</span> {
        ISOMUX mux = ISOMUX.get (<span class="hl-string">"myMUX"</span>);
     } <span class="hl-keyword">catch</span> (NameRegistrar.NotFoundeException e) {
        ...
        ...
     }</pre><p>that will in turn call <code class="literal">NameRegistrar.get ("mux.myMUX")</code>. Later, we&#8217;ll see that
NameRegistrar is extensively used by jPOS' Q2 applications. Q2 takes care of
configuring several jPOS components for you, but your code will have to locate
them by a given name. That&#8217;s where <code class="literal">NameRegistrar</code> comes in to play.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Singletons are usually an illusion, you think there&#8217;s just one, but there might be
more than one. If you have multiple classloaders in your application you may end up with
multiple copies of a singleton, such as the NameRegistrar.</p><p>This problem does not exist if you run Q2 as a stand-alone application.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">NameRegistrar</code> is a <code class="literal">Loggeable</code> object (see <a class="xref" href="#logger" title="3.1&nbsp;jPOS' Logger">Section&nbsp;3.1, &#8220;jPOS' Logger&#8221;</a>) so its instance
(<code class="literal">NameRegistrar.getInstance()</code>) can be added to a <code class="literal">LogEvent</code> in order to assist
you during debugging sessions.</p><p>When running in a <span class="strong"><strong>Q2</strong></span> environment we recommend to deploy a <code class="literal">sysmon</code> service in
order to regularly view the NameRegistrar&#8217;s content.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configuration"></a>3.3&nbsp;Configuration</h2></div></div></div><p><span class="strong"><strong>org.jpos.core.Configuration</strong></span> is a general purpose property container
extensively used by jPOS components.</p><p>The Configuration interface looks like this:</p><pre class="programlisting">   <span class="hl-keyword">package</span> org.jpos.core;

   <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Configuration {
     <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> put (String name, Object value);
     <span class="hl-keyword">public</span> String get (String propertyName);
     <span class="hl-keyword">public</span> String get (String propertyName, String defaultValue);
     <span class="hl-keyword">public</span> String[] getAll  (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>[] getInts  (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">long</span>[] getLongs (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">double</span>[] getDoubles (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span>[] getBooleans (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getInt (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getInt (String propertyName, <span class="hl-keyword">int</span> defaultValue);
     <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getLong (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getLong (String propertyName, <span class="hl-keyword">long</span> defaultValue);
     <span class="hl-keyword">public</span> <span class="hl-keyword">double</span> getDouble (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">double</span> getDouble (String propertyName, <span class="hl-keyword">double</span> defaultValue);
     <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> getBoolean (String propertyName);
     <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> getBoolean (String propertyName, <span class="hl-keyword">boolean</span> defaultValue);
   }</pre><p>Having our own Configuration interface lets us implement it in different ways.
We have a very little class called SimpleConfiguration backed by a
java.util.Properties, but nothing prevents us from creating a more
sophisticated Configuration object capable of providing dynamic data (such as
an SQLConfiguration, JavaSpacesConfiguration and the like).</p><p>jPOS-EE implements a SysConfigConfiguration that reads objects from its <code class="literal">sysconfig</code> SQL table.</p><p>We also have a very simple interface called Configurable:</p><pre class="programlisting">   <span class="hl-keyword">package</span> org.jpos.core;

   <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Configurable {
     <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setConfiguration (Configuration cfg)
        <span class="hl-keyword">throws</span> ConfigurationException;
   }</pre><p>Later, while looking at the Q2 application we&#8217;ll see that Q2 pushes a
configuration object by calling the <code class="literal">setConfiguration</code> method on
<code class="literal">Configurable</code> objects.</p><pre class="programlisting">    <span class="hl-tag">&lt;object</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyObject"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"any Value"</span><span class="hl-tag"> /&gt;</span>
      <span class="hl-tag">&lt;property</span> <span class="hl-attribute">file</span>=<span class="hl-value">"cfg/myprops.yml"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/object&gt;</span></pre><p>Should <code class="literal">com.mycompany.MyObject</code> implement <code class="literal">Configurable</code>, Q2 would call its  <code class="literal">setConfiguration()</code> method
providing access to the underlying <code class="literal">myProperty</code> property.</p><p>It&#8217;s interesting to note that Q2 provides the ability to have array of
properties under the same name, e.g.:</p><pre class="programlisting">    <span class="hl-tag">&lt;object</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyObject"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Value A"</span><span class="hl-tag"> /&gt;</span>
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Value B"</span><span class="hl-tag"> /&gt;</span>
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Value C"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/object&gt;</span></pre><p>where one can call handy methods like  <code class="literal">String[] getAll(String)</code>.</p><p><code class="literal">setConfiguration(Configuration cfg)</code> can check the Configuration object and might
throw a <code class="literal">ConfigurationException</code> in case a required property is not present or
is invalid.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>SimpleConfiguration recognizes and de-references properties with the
format: <code class="literal">${xxx}</code> and searches for a system property, or operating system
environment variable under the <code class="literal">xxx</code> name.
As a fallback mechanism of last resort, the property can be resolved from an <span class="emphasis"><em>environment file</em></span>, in
YAML or <span class="emphasis"><em>properties</em></span> file syntax, found in the <code class="literal">cfg</code> directory (default filename <code class="literal">default.yml</code>
or <code class="literal">default.cfg</code>, which can be overridden by the <code class="literal">jpos.env</code> system property).</p><p>You can add a default value within the expression itself, using the <code class="literal">:</code> (colon) separator.
For example <code class="literal">${xxx:def_value}</code>. If the property is not found, the default value will be used.</p><p>The format <code class="literal">$sys{xxx}</code> de-references just from system properties,
<code class="literal">$env{xxx}</code> just from the operating system environment, and <code class="literal">$cfg{xxx}</code> just from the environment file (the.</p><p>In the rare case where a value with the format <code class="literal">${...}</code> is required, the
<code class="literal">$verb{${...}}</code> format (verbatim) can be used.</p><p>In addition, a property named <code class="literal">xx.yy.zz</code> can be overridden by the environment
variable <code class="literal">XX_YY_ZZ</code> (note that dots are replaced by underscore, and property
name is converted to uppercase.</p></td></tr></table></div><p>The jPOS <code class="literal">Environment</code> has a ServiceLoader based plugin mechanism that support
<code class="literal">EnvironmentProviders</code>. jPOS comes with two stock providers:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">FileEnvironmentProvider</code> (prefix <code class="literal">file::</code>).</li><li class="listitem"><code class="literal">ObfEnvironmentProvider</code> (prefix <code class="literal">obf::</code>).</li></ul></div><p>A YAML file (i.e. <code class="literal">cfg/default.yml</code>) containing an entry like this:</p><pre class="programlisting">db:
    pass: file::/var/secure/dbpass.txt</pre><p>Would obtain the value of the <code class="literal">${db.pass}</code> property from the <code class="literal">/var/secure/dbpass.txt</code> file.</p><p>Likewise, an obfuscated entry like this:</p><pre class="programlisting">db:
    pass: obf::Ir8LYtvCYsaXANchMMrBqq5Gs2DnMEstYAAAAA</pre><p>would de-obfuscate the base64 encoded secret.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Obfuscation is that, just obfuscation, not encryption.
It&#8217;s used to prevent secrets from leaking to ocassional observers and
to demonstrate the use of the EnvironmentProviders. For production
deployments, HSM based EnvironmentProvider should be used instead.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">obf</code> CLI command can be used to create these obfuscated entries.</p></td></tr></table></div><p>Since version 2.1.7, jPOS supports the <code class="literal">@Config</code> annotation that pushes configuration properties (String, int, Integer, long, Long) down to classes
instanciated through QFactory (Qbeans, Transaction Participants, etc.), i.e:</p><pre class="programlisting">  <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyClass {
      <em><span class="hl-annotation" style="color: gray">@Config("port")</span></em> <span class="hl-keyword">int</span> port;
  }</pre><p>The <span class="emphasis"><em>port</em></span> variable would be picked from:</p><pre class="programlisting">  ...
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1234"</span><span class="hl-tag"> /&gt;</span>
  ...</pre><p>from the QBean or participant configuration.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>When using multiple environments (i.e. <code class="literal">-Eprod -Enode1</code>) you can specify</p><p><code class="literal">&lt;property file="cfg/myconfig.yml" env="true" /&gt;</code></p><p>and the system will load the files <code class="literal">myconfig.yml</code>, <code class="literal">myconfig-prod.yml</code> and <code class="literal">myconfig-node1.yml</code>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="SystemMonitor"></a>3.4&nbsp;SystemMonitor</h2></div></div></div><p><span class="strong"><strong>org.jpos.util.SystemMonitor</strong></span>  is a very simple class that periodically
logs useful information such as the number of running threads, memory
usage, etc.</p><p>Its constructor looks like this:</p><pre class="programlisting">     <span class="hl-keyword">public</span> SystemMonitor (<span class="hl-keyword">int</span> sleepTime, Logger logger, String realm)</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>See
   <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/util/SystemMonitor.html" target="_top">javadocs</a>
for details.</p></td></tr></table></div><p>Using SystemMonitor is very easy. You simply have to instantiate it with code
like this:</p><pre class="programlisting">     ...
     ...
     <span class="hl-keyword">new</span> SystemMonitor (<span class="hl-number">60</span>*<span class="hl-number">60</span>*<span class="hl-number">1000L</span>, yourLogger, <span class="hl-string">"system-monitor"</span>); <span class="hl-comment">// dumps every hour</span>
     ...
     ...</pre><p>and it will dump info to your log every hour (60*60*1000 milliseconds).
The output looks like this:</p><pre class="programlisting">  <span class="hl-tag">&lt;info&gt;</span>
               OS: Mac OS X
             host: Macintosh-2.local/192.168.2.20
          version: 1.9.3-SNAPSHOT (d3c9ac3)
         instance: 38d512f6-f812-4d85-8520-cb96de2654a0
           uptime: 00:00:00.234
       processors: 2
           drift : 0
    memory(t/u/f): 85/7/78
          threads: 4
            Thread[Reference Handler,10,system]
            Thread[Finalizer,8,system]
            Thread[Signal Dispatcher,9,system]
            Thread[RMI TCP Accept-0,5,system]
            Thread[Q2-38d512f6-f812-4d85-8520-cb96de2654a0,5,main]
            Thread[DestroyJavaVM,5,main]
            Thread[Timer-0,5,main]
            Thread[SystemMonitor,5,main]
    name-registrar:
      logger.Q2.buffered: org.jpos.util.BufferedLogListener
      logger.Q2: org.jpos.util.Logger
  <span class="hl-tag">&lt;/info&gt;</span></pre><p>Most output is self-explanatory, with some abbreviations, e.g., memory <span class="emphasis"><em>t/u/f</em></span>
stands for <span class="emphasis"><em>total</em></span>, <span class="emphasis"><em>used</em></span> and <span class="emphasis"><em>free</em></span>. But there&#8217;s one, <span class="strong"><strong>drift</strong></span>, that deserves
some explanation.</p><p>In the old days of the initial JVM 1.02, where Threads were not native
operating system threads (they were called <span class="emphasis"><em>green threads</em></span>), it was very easy
for a thread to interfere with other threads in the same JVM, so calls to set
the thread priority, and even calls to <code class="literal">Thread.yield()</code> here and there in tight
loops where necessary.</p><p>In order to detect situations where something was really wrong we devised a
simple approach: the system monitor is supposed to sleep for a given period
of time, and then wake up. If we sleep for say 3600 seconds, we should be
waked up exactly 3600 later, right? When threads were cooperating that was
kind of true, we wake up just a few milliseconds later which is reasonable,
but when some threads were hogging the CPU, that wake up happens several
hundred and sometimes thousand milliseconds later. That was an indication
that one or more threads were running in a tight loop consuming too
much CPU resources and needed further investigation.</p><p>Green Threads are over, we now have great support for native threads, but
we left that <span class="emphasis"><em>drift</em></span> indicator in the SystemMonitor and interesting enough,
it&#8217;s still very useful. When the system is running under heavy load, or on
overloaded and poorly monitored virtualized environments, the drift goes
up, to several seconds.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If we have a report for a slow jPOS application, we suggest to immediately take
a look at that drift, if it looks weird, you know you need to start looking
at the whole system performance instead of just your jPOS based application.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you&#8217;re using Q2, the default configuration deploys a <code class="literal">SystemMonitor</code>
for you.</p><p>See <code class="literal">deploy/99_sysmon.xml</code></p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="profiler"></a>3.5&nbsp;Profiler</h2></div></div></div><p><span class="strong"><strong>org.jpos.util.Profiler</strong></span> is a very simple and easy to use user-space Profiler.
It leverages the Logger subsystem to provide accurate information about processing times.</p><p>These are Profiler&#8217;s public methods:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> reset();
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> checkPoint (String detail);
    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getElapsed();
    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getParcial();</pre><p>See <a class="link" href="http://www.jpos.org/doc/javadoc/org/jpos/util/Profiler.html" target="_top"> javadocs </a> for details.</p><p>Profiler implements Loggeable, so you can easily add a Profiler Object to a LogEvent
to produce convenient profiling information.</p><div class="example"><a name="d0e3758"></a><p class="title"><b>Example&nbsp;3.1.&nbsp;Profiler</b></p><div class="example-contents"><pre class="programlisting">    Profiler prof = <span class="hl-keyword">new</span> Profiler();
    LogEvent evt = <span class="hl-keyword">new</span> LogEvent (<span class="hl-keyword">this</span>, <span class="hl-string">"any-transaction"</span>, prof);

    <span class="hl-comment">// initialize message</span>
    ISOMsg m = <span class="hl-keyword">new</span> ISOMsg ();
    m.setMTI (<span class="hl-string">"1200"</span>);
    ...
    ...
    prof.checkPoint (<span class="hl-string">"initialization"</span>);

    <span class="hl-comment">// send message to remote host</span>
    ...
    ...
    ISORequest req = <span class="hl-keyword">new</span> ISORequest (m);
    mux.queue (req);
    ISOMsg response = req.getResponse (<span class="hl-number">60000</span>);
    prof.checkPoint (<span class="hl-string">"authorization"</span>);

    <span class="hl-comment">// capture data in local database</span>
    ...
    ...
    prof.checkPoint (<span class="hl-string">"capture"</span>);
    ...
    ...
    Logger.log (evt);</pre></div></div><br class="example-break"><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The "end" checkPoint is automatically computed at output time (that&#8217;s when
Logger calls its log listeners).</p></td></tr></table></div><p>The profiler output looks like this:</p><pre class="screen">      prepare: org.jpos.jcard.PrepareContext [0.2/0.2]      <a name="CO4-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
      prepare: org.jpos.jcard.CheckVersion [0.1/0.3]        <a name="CO4-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
      prepare: org.jpos.transaction.Open [1.0/1.3]
      prepare: org.jpos.jcard.Switch [0.1/1.5]
      prepare: org.jpos.jcard.NotSupported [0.1/1.7]
      prepare: org.jpos.jcard.PrepareResponse [11.2/13.0]
      prepare: org.jpos.transaction.Close [0.2/13.2]
      prepare: org.jpos.jcard.SendResponse [0.0/13.3]
      prepare: org.jpos.jcard.ProtectDebugInfo [0.1/13.4]
      prepare: org.jpos.transaction.Debug [0.0/13.5]
       commit: org.jpos.transaction.Close [1.8/15.4]
       commit: org.jpos.jcard.SendResponse [2.2/17.6]
       commit: org.jpos.jcard.ProtectDebugInfo [0.3/17.9]
       commit: org.jpos.transaction.Debug [3.9/21.9]        <a name="CO4-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
      end [1.9/23.9]                                        <a name="CO4-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Partial 0.2 milliseconds, total so far, 0.2 milliseconds.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>CheckVersion took 0.1 milliseconds, so the total so far is 0.3 milliseconds.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Total so far, 21.9ms.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO4-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>1.9ms is the time between the last checkPoint and the log time.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dirpoll"></a>3.6&nbsp;DirPoll</h2></div></div></div><p>Some jPOS-based applications have to interact with third-party legacy software
(e.g., batch files coming from acquirers, retail applications, etc). Most of
the time one can be lucky enough to deal with legacy applications capable of
sending transactions over decent protocols but sometimes you are not
that lucky and the best thing you can get is a disk-based interchange, i.e.,
they place a request in a given directory, you process that request and provide
a response.</p><p><span class="strong"><strong>org.jpos.util.DirPoll</strong></span> uses the following directory structure (whose names are
self explanatory):</p><pre class="screen">     ..../archive
     ..../request
     ..../response
     ..../tmp
     ..../run
     ..../bad</pre><p>and defines the following inner interfaces:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Processor {
        <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] process(String name, <span class="hl-keyword">byte</span>[] request)
            <span class="hl-keyword">throws</span> DirPollException;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> FileProcessor {
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> process (File name)
            <span class="hl-keyword">throws</span> DirPollException;
    }</pre><p>You can either create a Processor or a FileProcessor to handle incoming traffic.</p><p>Whenever a legacy application places a file in the <code class="literal">request</code> directory, your
Processor (or FileProcessor) gets called, giving you a chance to process the
given request and provide a response (if you&#8217;re using a Processor, the response
will be placed in the <code class="literal">response</code> directory).</p><div class="example"><a name="d0e3815"></a><p class="title"><b>Example&nbsp;3.2.&nbsp;DirPoll Processor</b></p><div class="example-contents"><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DirPollProcessor <span class="hl-keyword">implements</span> DirPoll.Processor {
        DirPollProcessor () {
            <span class="hl-keyword">super</span> ();
            DirPoll dp = <span class="hl-keyword">new</span> DirPoll ();
            dp.setLogger (logger, <span class="hl-string">"dir-poll"</span>);
            dp.setPath (<span class="hl-string">"/tmp/dirpoll"</span>);
            dp.createDirs ();
            dp.setProcessor (<span class="hl-keyword">this</span>);
            <span class="hl-keyword">new</span> Thread (dp).start ();
        }
        <span class="hl-keyword">public</span> <span class="hl-keyword">byte</span>[] process (String name, <span class="hl-keyword">byte</span>[] b) {
            <span class="hl-keyword">return</span> (<span class="hl-string">"request: "</span> + name + <span class="hl-string">" content="</span>+ <span class="hl-keyword">new</span> String (b)).getBytes();
        }
    }</pre></div></div><br class="example-break"><p>DirPoll has provisions to handle different kind of messages with different
priority based on its file extension, so you can call:</p><pre class="programlisting">    ...
    ...
    dp.addPriority (<span class="hl-string">".A"</span>);
    dp.addPriority (<span class="hl-string">".B"</span>);
    dp.addPriority (<span class="hl-string">".C"</span>);
    ...
    ...</pre><p>in order to raise ".A" priority over ".B" and ".C" requests (you can use any extension name).</p><p>Before processing a given request, <code class="literal">DirPoll</code> moves it to the <code class="literal">run</code> directory,
and then either to the <code class="literal">response</code> directory or to the <code class="literal">bad</code>  directory (in
case something goes wrong and a <code class="literal">DirPollException</code> has  been thrown).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If your application crashes, you have to take care of possible requests
left sitting in the <code class="literal">run</code> directory. It is very important that your
application writes the requests in the <code class="literal">tmp</code> directory (or any other
temporary directory in the same file system) and then moves them (after a
proper operating system close operation) to the <code class="literal">request</code> directory in order
to guarantee that once a request is present in the <code class="literal">request</code> directory, it
is ready for DirPoll to process.</p></td></tr></table></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Don&#8217;t trust your legacy application programmer. Please double check that the
previous note has been taken into account.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="threadpool"></a>3.7&nbsp;ThreadPool</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This class is going to be deprecated. Do not use in new code.</p><p>The ThreadPool is used by several jPOS components, such as the ISOServer, and it was a
good helper class 10 years ago. We will replace it by components of the Java Executors
Framework at some point.</p></td></tr></table></div><p><span class="strong"><strong>org.jpos.util.ThreadPool</strong></span>, takes care of managing a pool of threads.</p><p>Its constructor looks like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> ThreadPool (<span class="hl-keyword">int</span> initialPoolSize, <span class="hl-keyword">int</span> maxPoolSize)</pre><p>(See  <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/util/ThreadPool.html" target="_top">javadocs</a> for details).</p><p>It&#8217;s very useful to process short-lived threads, such as processing an
authorization transaction. Instead of creating a new thread per transaction,
you can create a ThreadPool at initialization time and then call its
<code class="literal">execute(Runnable r)</code> method.</p><p>The thread will be returned to the pool when your <code class="literal">run()</code> method ends, so it is
not a good idea to have long-running threads (e.g., a <code class="literal">for (;;) { &#8230;&#8203; }</code> loop) in
your Runnable.</p><p>There&#8217;s an inner interface called ThreadPool.Supervised that your Runnable can
optionally implement:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ThreadPool {
        <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Supervised {
            <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> expired ();
        }
    }</pre><p>In this case, ThreadPool will call your <code class="literal">expired()</code> method, and - if true -
will attempt to interrupt the expired thread. Note that while this does not
guarantee that your thread will gracefully end, it gives you a chance to get
out of a possible problem.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can write some <span class="emphasis"><em>self-healing</em></span> code in your <code class="literal">expired()</code> implementation, but
please make sure your code won&#8217;t block for too long. Use only if you know
what you&#8217;re doing.</p></td></tr></table></div><p>ThreadPool implements ThreadPoolMBean, which exposes the following read-only
properties:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getJobCount ();
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getPoolSize ();
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getMaxPoolSize ();
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getIdleCount();
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getPendingCount ();</pre></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_packagers"></a>4.&nbsp;Packagers</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="packagerimpl"></a>4.1&nbsp;Implementing Custom Packagers</h2></div></div></div><p>jPOS comes with several ISOPackager and ISOFieldPackager implementations that
can be used either out-of-the-box or as a reference to encode (pack) and decode
(unpack) messages that are built on the ISO-8583 standard.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>For a list of out-of-the-box packagers you may want to have a
look at the following directories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">jpos/src/main/java/org/jpos/iso/packager</code> (Java based packagers)</li><li class="listitem"><code class="literal">jpos/src/main/resources/packager</code> (GenericPackager configurations accessible as a resource)</li><li class="listitem"><code class="literal">jpos/src/dist/cfg/packager</code> (GenericPackager configurations accessible as external files)</li></ul></div></td></tr></table></div><p>Although not required, most ISOPackager implementations extend the supporting
class ISOBasePackager. This approach makes writing a custom packager a very
simple task. It&#8217;s basically just a matter of calling its
<code class="literal">public void setFieldPackager (ISOFieldPackager[] fld)</code>
method with a suitable array of ISOFieldPackagers.</p><p>Let&#8217;s look at a sample implementation:</p><div class="example"><a name="d0e3951"></a><p class="title"><b>Example&nbsp;4.1.&nbsp;ISO-8583 version 1993 packager implementation</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ISO93BPackager <span class="hl-keyword">extends</span> ISOBasePackager {
    <span class="hl-keyword">private</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">boolean</span> pad = false;
    <span class="hl-keyword">protected</span> ISOFieldPackager fld[] = {
    <span class="hl-comment">/*000*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC (  <span class="hl-number">4</span>, <span class="hl-string">"Message Type Indicator"</span>, pad),
    <span class="hl-comment">/*001*/</span> <span class="hl-keyword">new</span> IFB_BITMAP  ( <span class="hl-number">16</span>, <span class="hl-string">"Bitmap"</span>),
    <span class="hl-comment">/*002*/</span> <span class="hl-keyword">new</span> IFB_LLNUM   ( <span class="hl-number">19</span>, <span class="hl-string">"Primary Account number"</span>, pad),
    <span class="hl-comment">/*003*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC (  <span class="hl-number">6</span>, <span class="hl-string">"Processing Code"</span>, pad),
    <span class="hl-comment">/*004*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC ( <span class="hl-number">12</span>, <span class="hl-string">"Amount, Transaction"</span>, pad),
    <span class="hl-comment">/*005*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC ( <span class="hl-number">12</span>, <span class="hl-string">"Amount, Reconciliation"</span>, pad),
    <span class="hl-comment">/*006*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC ( <span class="hl-number">12</span>, <span class="hl-string">"Amount, Cardholder billing"</span>, pad),
    <span class="hl-comment">/*007*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC ( <span class="hl-number">10</span>, <span class="hl-string">"Date and time, transmission"</span>, pad),
    <span class="hl-comment">/*008*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC (  <span class="hl-number">8</span>, <span class="hl-string">"Amount, Cardholder billing fee"</span>, pad),
    <span class="hl-comment">/*009*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC (  <span class="hl-number">8</span>, <span class="hl-string">"Conversion rate, Reconciliation"</span>, pad),
    <span class="hl-comment">/*010*/</span> <span class="hl-keyword">new</span> IFB_NUMERIC (  <span class="hl-number">8</span>, <span class="hl-string">"Conversion rate, Cardholder billing"</span>, pad),
    ...
    ...
    ...
    <span class="hl-comment">/*123*/</span> <span class="hl-keyword">new</span> IFB_LLLCHAR (<span class="hl-number">999</span>, <span class="hl-string">"Reserved for private use"</span>),
    <span class="hl-comment">/*124*/</span> <span class="hl-keyword">new</span> IFB_LLLCHAR (<span class="hl-number">999</span>, <span class="hl-string">"Reserved for private use"</span>),
    <span class="hl-comment">/*125*/</span> <span class="hl-keyword">new</span> IFB_LLLCHAR (<span class="hl-number">999</span>, <span class="hl-string">"Reserved for private use"</span>),
    <span class="hl-comment">/*126*/</span> <span class="hl-keyword">new</span> IFB_LLLCHAR (<span class="hl-number">999</span>, <span class="hl-string">"Reserved for private use"</span>),
    <span class="hl-comment">/*127*/</span> <span class="hl-keyword">new</span> IFB_LLLCHAR (<span class="hl-number">999</span>, <span class="hl-string">"Reserved for private use"</span>),
    <span class="hl-comment">/*128*/</span> <span class="hl-keyword">new</span> IFB_BINARY  (  <span class="hl-number">8</span>, <span class="hl-string">"Message authentication code field"</span>)
    };
    <span class="hl-keyword">public</span> ISO93BPackager() {
        <span class="hl-keyword">super</span>();
        setFieldPackager(fld);
    }
}</pre></div></div><br class="example-break"><p>We hope you see the key idea: writing a custom packager involves diving into
your interchange specification and setting up a suitable kind of field packager
for every possible field.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="GenericPackager"></a>4.2&nbsp;GenericPackager</h2></div></div></div><p>After writing multiple ISOFieldPackager implementations, jPOS developer Eoin
Flood came up with a nice idea: writing a GenericPackager that would read an
XML configuration file and instantiate an ISOFieldPackager on-the-fly.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Because packagers are usually instantiated once during the life time of an
application, there&#8217;s no performance impact between a packager implemented
in pure Java or the GenericPackager that reads an XML only at initialization
time.</p></td></tr></table></div><p>Using this approach, the same packager we&#8217;ve seen in the previous example can
be easily configured using <code class="literal">GenericPackager</code> and a simple XML file like this:</p><div class="example"><a name="d0e3971"></a><p class="title"><b>Example&nbsp;4.2.&nbsp;ISO-8583 version 1993 packager configuration</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span>
<strong class="hl-tag" style="color: blue">&lt;!DOCTYPE isopackager PUBLIC
        "-//jPOS/jPOS Generic Packager DTD 1.0//EN"
        "http://jpos.org/dtd/generic-packager-1.0.dtd"&gt;</strong>

<span class="hl-comment">&lt;!-- ISO 8583:1993 (BINARY) field descriptions for GenericPackager --&gt;</span>

<span class="hl-tag">&lt;isopackager&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"0"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"4"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Message Type Indicator"</span>
      <span class="hl-attribute">pad</span>=<span class="hl-value">"false"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_NUMERIC"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"1"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"16"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Bitmap"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_BITMAP"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"2"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"19"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Primary Account number"</span>
      <span class="hl-attribute">pad</span>=<span class="hl-value">"false"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_LLNUM"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"3"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"6"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Processing Code"</span>
      <span class="hl-attribute">pad</span>=<span class="hl-value">"false"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_NUMERIC"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"4"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"12"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Amount, Transaction"</span>
      <span class="hl-attribute">pad</span>=<span class="hl-value">"false"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_NUMERIC"</span><span class="hl-tag">/&gt;</span>
   ...
   ...
   ...
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"126"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"999"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Reserved for private use"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_LLLCHAR"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"127"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"999"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Reserved for private use"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_LLLCHAR"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;isofield</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"128"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"8"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"Message authentication code field"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_BINARY"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/isopackager&gt;</span></pre></div></div><br class="example-break"><p>GenericPackager uses a DTD defined in <code class="literal">jpos/src/main/resources/org/jpos/iso/packager/genericpackager.dtd</code>
that looks like this:</p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;!ELEMENT isopackager (isofield+,isofieldpackager*)*&gt;
&lt;!ATTLIST isopackager maxValidField CDATA        #IMPLIED&gt;
&lt;!ATTLIST isopackager bitmapField   CDATA        #IMPLIED&gt;
&lt;!ATTLIST isopackager firstField    CDATA        #IMPLIED&gt;
&lt;!ATTLIST isopackager emitBitmap    (true|false) #IMPLIED&gt;
&lt;!ATTLIST isopackager headerLength  CDATA        #IMPLIED&gt;

&lt;!-- isofield --&gt;
&lt;!ELEMENT isofield (#PCDATA)&gt;
&lt;!ATTLIST isofield id     CDATA        #REQUIRED&gt;
&lt;!ATTLIST isofield length CDATA        #REQUIRED&gt;
&lt;!ATTLIST isofield name   CDATA        #REQUIRED&gt;
&lt;!ATTLIST isofield class  NMTOKEN      #REQUIRED&gt;
&lt;!ATTLIST isofield token  CDATA        #IMPLIED&gt;
&lt;!ATTLIST isofield pad    (true|false) #IMPLIED&gt;

&lt;!-- isofieldpackager --&gt;
&lt;!ELEMENT isofieldpackager (isofield+,isofieldpackager*)*&gt;
&lt;!ATTLIST isofieldpackager id       CDATA        #REQUIRED&gt;
&lt;!ATTLIST isofieldpackager name     CDATA        #REQUIRED&gt;
&lt;!ATTLIST isofieldpackager length   CDATA        #REQUIRED&gt;
&lt;!ATTLIST isofieldpackager class    NMTOKEN      #REQUIRED&gt;
&lt;!ATTLIST isofieldpackager token    CDATA        #IMPLIED&gt;
&lt;!ATTLIST isofieldpackager pad      (true|false) #IMPLIED&gt;
&lt;!ATTLIST isofieldpackager packager NMTOKEN      #REQUIRED&gt;
&lt;!ATTLIST isofieldpackager emitBitmap (true|false) #IMPLIED&gt;
&lt;!ATTLIST isofieldpackager maxValidField CDATA        #IMPLIED&gt;
&lt;!ATTLIST isofieldpackager bitmapField CDATA        #IMPLIED&gt;
&lt;!ATTLIST isofieldpackager firstField  CDATA        #IMPLIED&gt;
&lt;!ATTLIST isofieldpackager headerLength  CDATA        #IMPLIED&gt;</pre><p>GenericPackager&#8217;s DTD eases the configuration of nested messages
(an ISO-8583 field that is a full ISO-8583 message itself), e.g.:</p><pre class="programlisting">   ...
   ...
  <span class="hl-tag">&lt;isofieldpackager</span>
      <span class="hl-attribute">id</span>=<span class="hl-value">"127"</span>
      <span class="hl-attribute">length</span>=<span class="hl-value">"255"</span>
      <span class="hl-attribute">name</span>=<span class="hl-value">"FILE RECORS(S) ACTION/DATA"</span>
      <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_LLHBINARY"</span>
      <span class="hl-attribute">packager</span>=<span class="hl-value">"org.jpos.iso.packager.GenericSubFieldPackager"</span><span class="hl-tag">&gt;</span>
      <span class="hl-tag">&lt;isofield</span>
          <span class="hl-attribute">id</span>=<span class="hl-value">"0"</span>
          <span class="hl-attribute">length</span>=<span class="hl-value">"1"</span>
          <span class="hl-attribute">name</span>=<span class="hl-value">"FILE UPDATE COD"</span>
          <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFE_CHAR"</span><span class="hl-tag">/&gt;</span>
      <span class="hl-tag">&lt;isofield</span>
          <span class="hl-attribute">id</span>=<span class="hl-value">"1"</span>
          <span class="hl-attribute">length</span>=<span class="hl-value">"19"</span>
          <span class="hl-attribute">name</span>=<span class="hl-value">"ACCOUNT NUMBER"</span>
          <span class="hl-attribute">pad</span>=<span class="hl-value">"true"</span>
          <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_LLHNUM"</span><span class="hl-tag">/&gt;</span>
      <span class="hl-tag">&lt;isofield</span>
          <span class="hl-attribute">id</span>=<span class="hl-value">"2"</span>
          <span class="hl-attribute">length</span>=<span class="hl-value">"4"</span>
          <span class="hl-attribute">name</span>=<span class="hl-value">"PURGE DATE"</span>
          <span class="hl-attribute">pad</span>=<span class="hl-value">"true"</span>
          <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IFB_NUMERIC"</span><span class="hl-tag">/&gt;</span>
      ...
      ...
      ...
  <span class="hl-tag">&lt;/isofieldpackager&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">GenericPackager</code> uses an entity resolver that recognizes the PUBLIC DTD
in order to avoid loading it over the internet. This is particularly important
when you run your system in a DMZ with limited access to the outside world.</p><p>In order to take advantage of the entity resolver, you need to make sure
that your packager configuration starts with the following preamble:</p><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;!DOCTYPE isopackager PUBLIC
        "-//jPOS/jPOS Generic Packager DTD 1.0//EN"
        "http://jpos.org/dtd/generic-packager-1.0.dtd"&gt;</pre></td></tr></table></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_channels"></a>5.&nbsp;Channels</h1></div></div></div><p>jPOS comes with several channel implementations, most of which
are available in the <code class="literal">src/main/java/org/jpos/iso/channel</code> directory.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_tcpip_socket_based_channels"></a>5.1&nbsp;TCP/IP Socket-based channels</h2></div></div></div><p>Most TCP/IP-based channel implementations extend
<code class="literal">org.jpos.iso.BaseChannel</code> and just override the
<code class="literal">sendMessageLength</code> and <code class="literal">getMessageLength</code> methods.</p><p>Let&#8217;s have a look at <code class="literal">org.jpos.iso.channel.CSChannel</code>:
it uses a two-byte message length header sent in network
byte order (nbo) plus two bytes reserved for future use:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CSChannel <span class="hl-keyword">extends</span> BaseChannel {
    ...
    ...
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> sendMessageLength(<span class="hl-keyword">int</span> len) <span class="hl-keyword">throws</span> IOException {
        serverOut.write (len &gt;&gt; <span class="hl-number">8</span>);
        serverOut.write (len);
        serverOut.write (<span class="hl-number">0</span>);
        serverOut.write (<span class="hl-number">0</span>);
    }
    ...
    ...
    <span class="hl-keyword">protected</span> <span class="hl-keyword">int</span> getMessageLength() <span class="hl-keyword">throws</span> IOException, ISOException {
        <span class="hl-keyword">int</span> l = <span class="hl-number">0</span>;
        <span class="hl-keyword">byte</span>[] b = <span class="hl-keyword">new</span> <span class="hl-keyword">byte</span>[<span class="hl-number">4</span>];
        <span class="hl-keyword">while</span> (l == <span class="hl-number">0</span>) {
            serverIn.readFully(b,<span class="hl-number">0</span>,<span class="hl-number">4</span>);
            l = ((((<span class="hl-keyword">int</span>)b[<span class="hl-number">0</span>])&amp;<span class="hl-number">0xFF</span>) &lt;&lt; <span class="hl-number">8</span>) | (((<span class="hl-keyword">int</span>)b[<span class="hl-number">1</span>])&amp;<span class="hl-number">0xFF</span>);
            <span class="hl-keyword">if</span> (l == <span class="hl-number">0</span>) {
                serverOut.write(b);
                serverOut.flush();
            }
        }
        <span class="hl-keyword">return</span> l;
    }
}</pre><p>Here is a partial list of current channel implementations
(for a complete list, have a look at <code class="literal">jpos/src/main/java/org/jpos/iso/channel</code>):</p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Class name</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Wire protocol</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CSChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LL LL 00 00 [header] ISO-DATA
LL LL represents the [header+] ISO-DATA length in network byte order
00 00 reserved for future use
The header is optional
ISO-DATA: ISO-8583 image</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>NACChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LL LL [TPDU] ISO-DATA
LL LL represents the TPDU+ISO-DATA length  in network byte order
Optional TPDU (transport protocol data unit)
ISO-DATA: ISO-8583 image</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>NCCChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LL LL [TPDU] ISO-DATA
LL LL represents the TPDU+ISO-DATA length  in BCD (binary coded decimal)
Optional TPDU (transport protocol data unit)
ISO-DATA: ISO-8583 image</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ASCIIChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LLLL [header] ISO-DATA
      LLLL four bytes ASCII [header+] ISO-DATA length
Optional header
ISO-DATA: ISO-8583 image</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RawChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LL LL LL LL [header]  ISO-DATA
LL LL LL LL is [header+] ISO-DATA length  in network byte order</p><p>ISO-DATA: ISO-8583 image</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>VAPChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LL LL 00 00 header ISO-DATA
LL LL represents the header+ISO-DATA length  in network byte order
00 00 reserved for future use
VAP-specific header
ISO-DATA: ISO-8583 image</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PADChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>[header] ISO-DATA
Stream-based channel reads messages on-the-fly without using any kind of message boundary indicator.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X25Channel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>X25 is similar to PADChannel but uses a slightly different
 strategy. Instead of pulling an ISO-8583 from a stream, unpacking
it on the fly, X25Channel attempts to read full TCP/IP packets
by specifying a small timeout value. Whenever possible, PADChannel
seems like a better solution; however, certain X.25 packet
assembler/disassemblers sometimes send garbage over the wire
(i.e. ETXs) which might confuse PADChannel.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>XMLChannel</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Send/Receive messages in jPOS&#8217;s internal XML message representation</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>LogChannel</p></td><td style="" align="left" valign="top"><p>Similar to XMLChannel, but you can feed it a jPOS Log,
which is suitable to replay sessions</p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_ssl_channels"></a>5.2&nbsp;SSL Channels</h2></div></div></div><p>SocketFactories (like <code class="literal">ISOServer</code>), as well as most channels that inherit
from <code class="literal">BaseChannel</code> can delegate socket creation to an optional socket factory.</p><p>We have two kinds of socket factories:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">ISOClientSocketFactory</code></li><li class="listitem"><code class="literal">ISOServerSocketFactory</code></li></ul></div><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ISOClientSocketFactory {
    <span class="hl-keyword">public</span> Socket createSocket(String host, <span class="hl-keyword">int</span> port)
        <span class="hl-keyword">throws</span> IOException, ISOException;
}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ISOServerSocketFactory {
    <span class="hl-keyword">public</span> ServerSocket createServerSocket(<span class="hl-keyword">int</span> port)
        <span class="hl-keyword">throws</span> IOException, ISOException;
}</pre><p>as well as a provider that implements both of them: <code class="literal">org.jpos.iso.GenericSSLSocketFactory</code></p><p>The ChannelAdaptor accepts an optional <span class="emphasis"><em>socketFactory</em></span> property in the
channel configuration, and the QServer accepts a <span class="emphasis"><em>server-socket-factory</em></span>
child element.</p><div class="example"><a name="d0e4150"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;SocketFactory configuration in a ChannelAdaptor</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-tag">&lt;channel-adaptor</span> <span class="hl-attribute">name</span>=<span class="hl-value">'sslclient'</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.ChannelAdaptor"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;channel</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.channel.NACChannel"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span>
       <span class="hl-attribute">packager</span>=<span class="hl-value">"org.jpos.iso.packager.ISO87BPackager"</span><span class="hl-tag">&gt;</span>

  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"127.0.0.1"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10000"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"360000"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"socketFactory"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.jpos.iso.GenericSSLSocketFactory"</span><span class="hl-tag"> /&gt;</span>
 <span class="hl-tag">&lt;/channel&gt;</span>
 <span class="hl-tag">&lt;in&gt;</span>sslsend<span class="hl-tag">&lt;/in&gt;</span>
 <span class="hl-tag">&lt;out&gt;</span>sslreceive<span class="hl-tag">&lt;/out&gt;</span>
 <span class="hl-tag">&lt;reconnect-delay&gt;</span>10000<span class="hl-tag">&lt;/reconnect-delay&gt;</span>
<span class="hl-tag">&lt;/channel-adaptor&gt;</span></pre></div></div><br class="example-break"><div class="example"><a name="d0e4155"></a><p class="title"><b>Example&nbsp;5.2.&nbsp;SocketFactory configuration in a QServer</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-tag">&lt;server</span> <span class="hl-attribute">name</span>=<span class="hl-value">"server"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QServer"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">&gt;</span>5000<span class="hl-tag">&lt;/attr&gt;</span>
   <span class="hl-tag">&lt;server-socket-factory</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.GenericSSLSocketFactory"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;channel</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.channel.NACChannel"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span>
      <span class="hl-attribute">packager</span>=<span class="hl-value">"org.jpos.iso.packager.ISO87BPackager"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;/channel&gt;</span>
<span class="hl-tag">&lt;/server&gt;</span></pre></div></div><br class="example-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>For backward compatibility, we also have a <code class="literal">SunJSSESocketFactory</code> implementation
that uses <code class="literal">com.sun.net.ssl.internal.ssl.Provider</code>.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p><code class="literal">GenericSSLSocketFactory</code> honors two very important properties:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">addEnabledCipherSuite</code> and</li><li class="listitem"><code class="literal">addEnabledProtocol</code></li></ul></div><p>For PCI compliance, you want to make sure which protocols and ciphersuites you
want to enable. If these properties are not configured, all protocols and ciphersuites
available to the JVM will be enabled, something you probably don&#8217;t want.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_loopbackchannel"></a>5.3&nbsp;LoopbackChannel</h2></div></div></div><p>Loopback channel bounces all received messages using a blocking queue. It can
be used for simulation purposes. When using in combination with a suitable
ISOFilter, you can modify the outgoing or incoming (bounced) message so it
can easily simulate a response.</p><pre class="programlisting"><span class="hl-keyword">package</span> loopback;

<span class="hl-keyword">import</span> java.io.IOException;
<span class="hl-keyword">import</span> org.jpos.iso.ISOMsg;
<span class="hl-keyword">import</span> org.jpos.iso.ISOFilter;
<span class="hl-keyword">import</span> org.jpos.iso.ISOChannel;
<span class="hl-keyword">import</span> org.jpos.iso.ISOException;
<span class="hl-keyword">import</span> org.jpos.iso.channel.LoopbackChannel;
<span class="hl-keyword">import</span> org.jpos.util.LogEvent;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Test <span class="hl-keyword">implements</span> ISOFilter {
    <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">void</span> main (String[] args) {
        <span class="hl-keyword">try</span> {
            <span class="hl-keyword">new</span> Test().run();
        } <span class="hl-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run () <span class="hl-keyword">throws</span> ISOException, IOException {
        LoopbackChannel channel = <span class="hl-keyword">new</span> LoopbackChannel ();
        channel.addIncomingFilter (<span class="hl-keyword">this</span>);
        ISOMsg request  = createRequest();
        request.dump (System.out, <span class="hl-string">"request&gt;  "</span>);
        channel.send (request);
        ISOMsg response = channel.receive();
        response.dump (System.out, <span class="hl-string">"response&gt; "</span>);
    }

    <span class="hl-keyword">private</span> ISOMsg createRequest () <span class="hl-keyword">throws</span> ISOException {
        ISOMsg m = <span class="hl-keyword">new</span> ISOMsg (<span class="hl-string">"0800"</span>);
        m.set (<span class="hl-number">11</span>, <span class="hl-string">"000001"</span>);
        m.set (<span class="hl-number">41</span>, <span class="hl-string">"29110001"</span>);
        m.set (<span class="hl-number">70</span>, <span class="hl-string">"301"</span>);
        <span class="hl-keyword">return</span> m;
    }
    <span class="hl-keyword">public</span> ISOMsg filter (ISOChannel channel, ISOMsg m, LogEvent evt) {
        <span class="hl-keyword">try</span> {
            m.setResponseMTI ();
            m.set (<span class="hl-number">39</span>, <span class="hl-string">"00"</span>);
        } <span class="hl-keyword">catch</span> (ISOException e) {
            e.printStackTrace();
        }
        <span class="hl-keyword">return</span> m;
    }
}</pre><p>The previous program produces the following output:</p><pre class="screen">request&gt;  &lt;isomsg&gt;
request&gt;    &lt;field id="0" value="0800"/&gt;
request&gt;    &lt;field id="11" value="000001"/&gt;
request&gt;    &lt;field id="41" value="29110001"/&gt;
request&gt;    &lt;field id="70" value="301"/&gt;
request&gt;  &lt;/isomsg&gt;
response&gt; &lt;isomsg direction="incoming"&gt;
response&gt;   &lt;field id="0" value="0810"/&gt;
response&gt;   &lt;field id="11" value="000001"/&gt;
response&gt;   &lt;field id="39" value="00"/&gt;
response&gt;   &lt;field id="41" value="29110001"/&gt;
response&gt;   &lt;field id="70" value="301"/&gt;
response&gt; &lt;/isomsg&gt;</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>For a better way to simulate a remote host, you can have a look at the
<span class="strong"><strong>serversimulator</strong></span> module in the jPOS-EE distribution.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_channelpool"></a>5.4&nbsp;ChannelPool</h2></div></div></div><p>ChannelPool is an ISOChannel implementation that delegates channel operations
to its children channels.</p><p>It can handle several children channels, making it suitable to implement transparent failover.</p><p>By using its <code class="literal">addChannel</code> and <code class="literal">removeChannel</code> methods, you can react to network
problems on-the-fly without affecting higher-level layers of your application.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>As an alternative to the <code class="literal">ChannelPool</code>,
Q2 applications can use multiple <code class="literal">ChannelAdaptors</code>
configured with the same set of Space queues (in/out).
In addition, there&#8217;s a <code class="literal">MUXPool</code> that provides failover as
well as round-robin load balancing at the MUX level.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_channel_filters"></a>5.5&nbsp;Channel Filters</h2></div></div></div><p>Filters give the ability to alter an incoming or outgoing message.</p><p>jPOS comes with a few stock filters, mostly provided as proof-of-concept.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_md5filter"></a>5.5.1&nbsp;MD5Filter</h3></div></div></div><p>On outgoing messages, the MD5Filter computes an MD5 hash of a key plus the
content of a selected number of fields from the ISOMsg and places the hash
in fields 64 (first half) and 128 (second half).</p><p>On incoming messages, it computes the same MD5 hash and verifies they match
the one coming in fields 64 and 128.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Mentioning MD5 would probably guarantee your QSA to go ballistic. While using
MD5 is better than no message authentication at all, please consider this
filter as an example to implement MAC filters.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_channelinfofilter"></a>5.5.2&nbsp;ChannelInfoFilter</h3></div></div></div><p>In a Q2 environment where components are totally decoupled via multiplexers (MUX),
and sometimes multiplexer pools (MUXPool), a client calling <code class="literal">MUX.request(...)</code>
may not know which channel was actually used to send the message, or from which
channel a response came. <code class="literal">ChannelInfoFilter</code> can place the channel name, and
socket information in two customized fields.</p><p>Interesting enough, while ISO-8583 uses fields up to 128, you can internally use
fields beyond that (any arbitrary number greater than 128 would do) to store that
information, so you can configure your filter like this:</p><pre class="programlisting"> <span class="hl-tag">&lt;channel</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.channel.NACChannel"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span>
       <span class="hl-attribute">packager</span>=<span class="hl-value">"org.jpos.iso.packager.GenericPackager"</span><span class="hl-tag">&gt;</span>

  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"packager-config"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jar:packager/iso87ascii.xml"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"127.0.0.1"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"9001"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"360000"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;filter</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.iso.filter.ChannelInfoFilter'</span> <span class="hl-attribute">direction</span>=<span class="hl-value">'both'</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">'channel-name'</span> <span class="hl-attribute">value</span>=<span class="hl-value">'1000'</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">'socket-info'</span>  <span class="hl-attribute">value</span>=<span class="hl-value">'1001'</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/filter&gt;</span>
 <span class="hl-tag">&lt;/channel&gt;</span></pre><p>The log would show something like this:</p><pre class="programlisting">    <span class="hl-tag">&lt;isomsg&gt;</span>
      ...
      ...
      <span class="hl-tag">&lt;field</span> <span class="hl-attribute">id</span>=<span class="hl-value">"1000"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"selftest-adaptor"</span><span class="hl-tag">/&gt;</span>
      <span class="hl-tag">&lt;field</span> <span class="hl-attribute">id</span>=<span class="hl-value">"1001"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"127.0.0.1:51865 127.0.0.1:9001"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/isomsg&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_delayfilter"></a>5.5.3&nbsp;DelayFilter</h3></div></div></div><p>The DelayFilter is a demo filter that honors a <code class="literal">delay</code> property and can
be useful to delay messages as they come and go, useful for debugging/simulation
purposes.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_debugfilter"></a>5.5.4&nbsp;DebugFilter</h3></div></div></div><p>The DebugFilter adds to the log an hex representation of the binary message as
it comes and go through the wire. It&#8217;s very useful in situations where you
want to capture a message that is not properly unpacking without having to
revert to <code class="literal">tcpdump</code> or <code class="literal">nc</code>. This filter is of course a no-no in a production
environment (per PCI requirements).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_throughputcontrolfilter"></a>5.5.5&nbsp;ThroughputControlFilter</h3></div></div></div><p>The ThroughputControlFilter honors two properties:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">transactions</code> and</li><li class="listitem"><code class="literal">period</code> (in milliseconds).</li></ul></div><p>and can be used to apply back pressure to a channel sending a large number of transactions.
We can configure for example a maximum of 100 messages in a 1000 milliseconds period in
order to make sure that this particular channel won&#8217;t load the system with more than 100 TPS.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_bshfilter"></a>5.5.6&nbsp;BSHFilter</h3></div></div></div><p>The BSHFilter is one of the most useful, and one of the most abused filters. It allows you to
run a <a class="link" href="http://beanshell.org" target="_top">BeanShell</a> script that can be modified on the fly. It&#8217;s extremely
useful in situations where you need to add a field or two, or change the content of a given
field, e.g., while testing on a tight certification window.</p><p>It is not intended to be used as a way to implement your business logic, BSH code is great, but
tend to become brittle, difficult to refactor, test, you don&#8217;t have IDE support, etc.</p><p>The configuration might look like this:</p><pre class="programlisting">    <span class="hl-tag">&lt;channel</span> <span class="hl-attribute">...&gt;</span>
     <span class="hl-attribute">&lt;filter</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.bsh.BSHFilter"</span> <span class="hl-attribute">direction</span>=<span class="hl-value">"outgoing"</span><span class="hl-tag"> &gt;</span>
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"source"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"cfg/myfilter.bsh"</span><span class="hl-tag"> /&gt;</span>
     <span class="hl-tag">&lt;/filter&gt;</span>
     ...
     ...
    <span class="hl-tag">&lt;/channel&gt;</span></pre><p>Your <code class="literal">bsh</code> file will have access to the following variables:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">message</code> - the ISOMsg to be filtered</li><li class="listitem"><code class="literal">channel</code> - a reference to the ISOChannel associated with this filter</li><li class="listitem"><code class="literal">header</code>  - if a header is present (on received messages)</li><li class="listitem"><code class="literal">image</code>   - the binary image of the message (on received messages)</li><li class="listitem"><code class="literal">evt</code>     - a LogEvent that you can use to add information to the Log</li><li class="listitem"><code class="literal">cfg</code>     - a reference to the configuration object</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_additional_filters"></a>5.5.7&nbsp;Additional filters</h3></div></div></div><p>Take a look at <a class="link" href="https://github.com/jpos/jPOS/tree/master/jpos/src/main/java/org/jpos/iso/filter" target="_top">Github repository</a>
for additional samples.</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_jpos_space"></a>6.&nbsp;jPOS Space</h1></div></div></div><p>The jPOS Space is a general-purpose coordination component inspired
after <span class="strong"><strong>The Linda Coordination Language.</strong></span> <a href="#ftn.d0e4369" class="footnote" name="d0e4369"><sup class="footnote">[2]</sup></a></p><p>While jPOS&#8217;s Space <span class="strong"><strong>is not</strong></span> a Linda implementation, we highly recommend learning about
<span class="strong"><strong>Linda</strong></span> in order to better understand our Space component and motivation.</p><p>You can think about jPOS&#8217;s Space component as being like a Map where its
entries are lists of objects and its operations are fully synchronized.</p><p>There are three basic operations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">void out (Object key, Object value)</code> Puts an object into the space. If an
object under the given key already exists, the object is queued at the end of
a list under that name.</li><li class="listitem"><code class="literal">Object rd (Object key)</code>
Reads an object from the space under the given key. Blocks until an entry is present.</li><li class="listitem"><code class="literal">Object in (Object key)</code>
Take the object off the queue. Block until the object under the given key is present.</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>We picked those cryptic operation names after the Linda Coordination Language
basic operations, but could have used easier to remember names such as:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>write</strong></span> instead of <span class="emphasis"><em>out</em></span></li><li class="listitem"><span class="strong"><strong>read</strong></span> instead of just <span class="emphasis"><em>rd</em></span></li><li class="listitem"><span class="strong"><strong>take</strong></span> instead of <span class="emphasis"><em>in</em></span></li></ul></div></td></tr></table></div><p>After two consecutive <span class="emphasis"><em>out</em></span> operations using the same <span class="emphasis"><em>key</em></span> value, the
Space would look like this (first entry is printed as a blue circle while
the second one is red):</p><p><span class="inlinemediaobject"><img src="images/space-out.jpg" alt="SpaceOut"></span></p><p>Then an <span class="emphasis"><em>rd</em></span> operation would return the first entry (the blue one), without
removing it from the space. The space remains with two entries for that particular
key.
<span class="inlinemediaobject"><img src="images/space-rd.jpg" alt="SpaceOut"></span></p><p>The <span class="emphasis"><em>in</em></span> operation on the other hand, takes the first entry (the blue one) off the
Space, leaving the red one.</p><p><span class="inlinemediaobject"><img src="images/space-in.jpg" alt="SpaceOut"></span></p><p>At this point, a new <span class="emphasis"><em>rd</em></span> operation will return the second entry (the red one)
and an <span class="emphasis"><em>in</em></span> operation would return the red one as well, leaving the space empty
(further <span class="emphasis"><em>rd</em></span> or <span class="emphasis"><em>in</em></span> operations on that particular key will block.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="space_interface"></a>6.1&nbsp;Space interface</h2></div></div></div><p>In addition to those three basic operations, <code class="literal">org.jpos.space.Space</code> adds a few
handy methods:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">void out (K key, V value, long timeout)</code>
Place an object into the space using an expiration timeout.
The entry is automatically removed upon expiration.</li><li class="listitem"><code class="literal">V rd (K key, long timeout)</code>
Wait a maximum of <code class="literal">timeout</code> milliseconds for a given entry; otherwise, return null.</li><li class="listitem"><code class="literal">V in (K key, long timeout)</code>
Wait a maximum of <code class="literal">timeout</code> milliseconds for a given entry, and takes it; otherwise, return null.</li><li class="listitem"><code class="literal">V rdp (K key)</code>
Read an entry if it exists (<span class="emphasis"><em>p</em></span> for <span class="emphasis"><em>probe</em></span>).</li><li class="listitem"><code class="literal">V inp (K key)</code>
Take an entry if it exists (again, <span class="emphasis"><em>p</em></span> for <span class="emphasis"><em>probe</em></span>).</li><li class="listitem"><code class="literal">void nrd (K key)</code>
Block while key is present in the space. The operation name comes after <span class="emphasis"><em>not read</em></span>.</li><li class="listitem"><code class="literal">V nrd (K key, long timeout)</code>
Block up to timeout milliseconds while key is present in the space.
If timeout is reached and key is still present, returns its value (as in <span class="emphasis"><em>rdp</em></span>).</li><li class="listitem"><code class="literal">void push (K key, V value)</code>
Same as <code class="literal">out</code> but the entry is placed at the head of the queue (like a Stack&#8217;s push operation).</li><li class="listitem"><code class="literal">void push (K key, V value, long timeout)</code>
Same as the previous <code class="literal">push</code> operation with a timeout in millis.</li><li class="listitem"><code class="literal">public void put (K key, V value)</code>
Like a <code class="literal">Map.put</code> operation, a <code class="literal">Space.put</code> wipes all entries that may exist under a given
key and puts just this one.</li><li class="listitem"><code class="literal">public void put (K key, V value, long timeout)</code>
Same as previous one, but with a timeout.</li></ul></div><p>See <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/space/Space.html" target="_top">Javadoc</a> for full details and
additional helper methods (such as the handy <code class="literal">existAny(K[] keys</code>).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>While <code class="literal">org.jpos.space.Space</code> supports <span class="quote">&#8220;<span class="quote">generics</span>&#8221;</span>, current implementations
does not guarantee object type.
Use with care as an unexpected <code class="literal">ClassCastException</code> can occurr.</p></td></tr></table></div><p>The Space interface is small enough to show here:</p><pre class="programlisting"><span class="hl-keyword">package</span> org.jpos.space;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Space&lt;K,V&gt; {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> out (K key, V value);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> out (K key, V value, <span class="hl-keyword">long</span> timeout);
    <span class="hl-keyword">public</span> V in  (Object key);
    <span class="hl-keyword">public</span> V rd  (Object key);
    <span class="hl-keyword">public</span> V in  (Object key, <span class="hl-keyword">long</span> timeout);
    <span class="hl-keyword">public</span> V rd  (Object key, <span class="hl-keyword">long</span> timeout);
    <span class="hl-keyword">public</span> V inp (Object key);
    <span class="hl-keyword">public</span> V rdp (Object key);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> push (K key, V value);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> push (K key, V value, <span class="hl-keyword">long</span> timeout);
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> existAny (K[] keys);
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> existAny (K[] keys, <span class="hl-keyword">long</span> timeout);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> put (K key, V value);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> put (K key, V value, <span class="hl-keyword">long</span> timeout);
}</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="local_space_interface"></a>6.2&nbsp;Local Space interface</h2></div></div></div><p>The <code class="literal">Space</code> implementation is designed to be easy to implement under
different scenarios, such as persistent spaces, remote spaces, replicated
spaces.</p><p>The <code class="literal">LocalSpace</code> interface enhances the <code class="literal">Space</code> interface in situations where
the implementation runs in a single JVM, such as the <code class="literal">TSpace</code> implementation.</p><p>The additional methods include:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> LocalSpace {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addListener (Object key, SpaceListener listener);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> addListener (Object key, SpaceListener listener, <span class="hl-keyword">long</span> timeout);
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> removeListener (Object key, SpaceListener listener);
}</pre><p>as well as some miscellaneous methods that could be expensive to transmit over the wire and were left out in the base <code class="literal">Space</code> implementation.</p><pre class="programlisting">    <span class="hl-keyword">public</span> Set getKeySet ();
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> size (Object key);</pre><p>The <code class="literal">SpaceListener</code> implementation looks like this:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> SpaceListener {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> notify (Object key, Object value);
}</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>With the <code class="literal">LocalSpace</code> we can create event-driven consumers that allows us to
reduce the number of threads. A good example is the thread-less lightweight
<code class="literal">QMUX</code> implementation.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="space_factory"></a>6.3&nbsp;Space Factory</h2></div></div></div><p>jPOS comes with several space implementations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>TSpace</strong></span> : An in-memory space <a href="#ftn.d0e4660" class="footnote" name="d0e4660"><sup class="footnote">[3]</sup></a></li><li class="listitem"><span class="strong"><strong>JDBMSpace</strong></span> : a persistent JDBM based space implementation</li><li class="listitem"><span class="strong"><strong>JESpace</strong></span> : a persistent Berkeley DB Java Edition based implementation</li></ul></div><p>that can be instantiated using the SpaceFactory.</p><p>Although most Space implementations have either public constructors or factory
methods that can be used to create instances of their respective classes, we
highly recommend using the  <code class="literal">SpaceFactory</code> as the entry point for space
creation or to obtain references to spaces that were previously created.</p><div class="example"><a name="d0e4680"></a><p class="title"><b>Example&nbsp;6.1.&nbsp;Using the SpaceFactory</b></p><div class="example-contents"><pre class="programlisting">   <span class="hl-keyword">import</span> org.jpos.space.Space;
   <span class="hl-keyword">import</span> org.jpos.space.SpaceFactory;

   Space sp = SpaceFactory.getSpace();</pre></div></div><br class="example-break"><p>The previous example returns a reference to the default space, which happens to
be a TSpace implementation registered with the name <code class="literal">default</code>. It&#8217;s the same as
calling:</p><pre class="programlisting">   Space sp = SpaceFactory.getSpace(<span class="hl-string">"tspace"</span>);</pre><p>&#8230;&#8203;which is also the same as calling:</p><pre class="programlisting">   Space sp = SpaceFactory.getSpace(<span class="hl-string">"tspace:default"</span>);</pre><p>SpaceFactory decodes a space name based on the space implementation type,
followed by an optional name and optional parameter(s):
<code class="literal">spacetype\[:spacename\[:spaceparam}}</code></p><div class="table"><a name="d0e4700"></a><p class="title"><b>Table&nbsp;6.1.&nbsp;Space Names</b></p><div class="table-contents"><table summary="Space Names" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Type</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Implementation</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>tspace</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Creates or returns a reference to a previously-created instance of <code class="literal">TSpace</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>jdbm</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Creates or returns a reference to a previously-created instance of
<code class="literal">JDBMSpace</code>. This name accepts an optional
parameter (after the Space name) which is a path to the persistent
store, e.g., <code class="literal">jdbm:myspace:/tmp/myspace</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>je</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Creates or returns a reference to a previously-created instance of
<code class="literal">JESpace</code>. This name accepts an optional parameter (after the Space name)
which is a path to the persistent store, e.g., <code class="literal">jdbm:myspace:/tmp/myjespace</code>.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>spacelet</p></td><td style="" align="left" valign="top"><p>Returns a reference to a previously-created instance of <code class="literal">SpaceLet</code></p></td></tr></tbody></table></div></div><br class="table-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Some components communicate through a <span class="strong"><strong>default space</strong></span> that may change
over time, so it is very important to <code class="literal">SpaceFactory.getSpace()</code> instead
of instantiating your own. In previous versions, the default space was
<code class="literal">transient:default</code>, and now is <code class="literal">tspace:default</code> but this may change
in future versions of jPOS as new Space implementations become available.</p><p>By sticking to <code class="literal">SpaceFactory.getSpace()</code> jPOS will give you always the
default space for the version you&#8217;re using.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tspace"></a>6.4&nbsp;TSpace</h2></div></div></div><p>TSpace replaces the old <span class="emphasis"><em>TransientSpace</em></span> as the new default in-memory Space used by jPOS components.</p><p>It&#8217;s the space you get when you call <code class="literal">SpaceFactory.getSpace()</code> and can be also instantiated using the <code class="literal">tspace:xxx</code> name (i.e. <code class="literal">SpaceFactory.getSpace("tspace:myspace")</code>).</p><p>TSpace implements the LocalSpace interface (see next <a class="xref" href="#local_space_interface" title="6.2&nbsp;Local Space interface">Section&nbsp;6.2, &#8220;Local Space interface&#8221;</a>).</p><div class="example"><a name="d0e4800"></a><p class="title"><b>Example&nbsp;6.2.&nbsp;Sample TSpace use</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-keyword">import</span> org.jpos.space.Space;
<span class="hl-keyword">import</span> org.jpos.space.SpaceFactory;

Space sp = SpaceFactory.getSpace();
sp.out(<span class="hl-string">"A"</span>, <span class="hl-string">"The quick brown fox jumped over the lazy dog"</span>);
System.out.println (sp.rdp (<span class="hl-string">"A"</span>));</pre></div></div><br class="example-break"></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="jdbm_space"></a>6.5&nbsp;JDBMSpace</h2></div></div></div><p>JDBMSpace is a persistent space based on the popular <a class="link" href="http://jdbm.sourceforge.net/" target="_top">jDBM</a> key-value lightweight database.</p><p>It uses the SpaceFactory prefix <code class="literal">jdbm</code> that must be followed by a name, and an optional path, i.e.:</p><pre class="programlisting">Space sp = SpaceFactory.getSpace(<span class="hl-string">"jdbm:myspace"</span>);</pre><p>or</p><pre class="programlisting">Space sp = SpaceFactory.getSpace(<span class="hl-string">"jdbm:myspace:data/myspace"</span>);</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>JDBMSpace is good and we&#8217;ve used it for a long time in production
systems, but now there&#8217;s a new faster and more reliable implementation,
the <code class="literal">JESpace</code> (see <a class="xref" href="#je_space" title="6.6&nbsp;JESpace">Section&nbsp;6.6, &#8220;JESpace&#8221;</a>) based on Berkeley DB Java Edition.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="je_space"></a>6.6&nbsp;JESpace</h2></div></div></div><p>JESpace is a persistent space based on Berkeley DB Java Edition.</p><p>It uses the SpaceFactory prefix <code class="literal">je</code> that must be followed by a name, and an optional path, i.e.:</p><pre class="programlisting">Space sp = SpaceFactory(<span class="hl-string">"je:myspace"</span>);</pre><p>or</p><pre class="programlisting">Space sp = SpaceFactory(<span class="hl-string">"je:myspace:data/myspace"</span>);</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="space_interceptor"></a>6.7&nbsp;SpaceInterceptor</h2></div></div></div><p>SpaceInterceptor implements the <code class="literal">Space</code> interface and can be used to intercept
calls to a given Space without having to extend its implementation
(See <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/space/SpaceInterceptor.html" target="_top">Javadoc</a>
for full details).</p><p>Using a <code class="literal">SpaceInterceptor</code>, the developer can override specific methods in
order to perform additional tasks.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="space_tap"></a>6.8&nbsp;SpaceTap</h2></div></div></div><p>SpaceTap is a <code class="literal">SpaceListener</code> that can be used to monitor a given LocalSpace
for new entries under a given key.</p><p>Once a SpaceTap is created, it register itself as a listener in the
source LocalSpace and copies all new entries to a destination space.</p><p><b>Space Tap.&nbsp;</b><span class="inlinemediaobject"><img src="images/SpaceTap.jpg" alt="SpaceTap"></span></p><p>If you have a source LocalSpace <code class="literal">ssp</code> and a destination LocalSpace <code class="literal">dsp</code> and
you want to monitor an entry called "ERRORS", we can use code like this:</p><pre class="programlisting">   SpaceTap spt = <span class="hl-keyword">new</span> SpaceTap (ssp, dsp, <span class="hl-string">"ERRORS"</span>, <span class="hl-string">"ERRORS.COPY"</span>, <span class="hl-number">5000L</span>);</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If your "source" space and "destination" space are the same, you can use
the shorter constructor:</p><pre class="programlisting">   SpaceTap (LocalSpace ssp, Object key, Object tapKey, <span class="hl-keyword">long</span> timeout);</pre></td></tr></table></div><p>The SpaceTap can be used for system monitoring purposes as it provides a
non-intrusive way to "tap" any given space queue.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="space_util"></a>6.9&nbsp;SpaceUtil</h2></div></div></div><p>In <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/space/SpaceUtil.html" target="_top">SpaceUtil</a>
we put together general purpose helper methods that can be used with any
Space implementation.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong><code class="literal">inpAll</code></strong></span>
pulls all entries under a given key and return them in an array.</li><li class="listitem"><span class="strong"><strong><code class="literal">wipe</code></strong></span>
remove all entries under a given key</li><li class="listitem"><span class="strong"><strong><code class="literal">nextLong</code></strong></span>
When used in combination with a persistent Space (such as <code class="literal">JDBMSpace</code>
or <code class="literal">JESpace</code>), this method can be used to easily implement sequencers,
e.g.:</li></ul></div><pre class="programlisting"><span class="hl-keyword">import</span> org.jpos.space.*;
Space sp = SpaceFactory.getSpace(<span class="hl-string">"je:sequencers"</span>);
<span class="hl-keyword">long</span> l = SpaceUtil.nextLong(sp, <span class="hl-string">"traceno"</span>);</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Regularly monitor this class, as we may add new helper methods in the future.</p></td></tr></table></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d0e4369" class="footnote"><p><a href="#d0e4369" class="simpara"><sup class="simpara">[2] </sup></a>See <a class="link" href="http://www.cs.yale.edu/Linda/linda-lang.html" target="_top">http://www.cs.yale.edu/Linda/linda-lang.html</a></p></div><div id="ftn.d0e4660" class="footnote"><p><a href="#d0e4660" class="simpara"><sup class="simpara">[3] </sup></a>TSpace implements LocalSpace</p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_q2"></a>7.&nbsp;Q2</h1></div></div></div><p>In jPOS versions earlier than 1.5.0, the <code class="literal">main</code> for the jPOS application
was a component called <span class="strong"><strong>QSP</strong></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The term <span class="strong"><strong>QSP</strong></span> comes after the hamradio Q-signal codes and
it means "Relay message for free". Because jPOS was used to
<span class="emphasis"><em>relay messages</em></span>, and it is free software, in the deep nerdy
mind of the author, the term <span class="strong"><strong>QSP</strong></span> made sense
<a href="#ftn.d0e4962" class="footnote" name="d0e4962"><sup class="footnote">[4]</sup></a>.</p><p>That&#8217;s one of the reasons you&#8217;ll see so many _Q_s in the code
(QServer, QMUX, Q2 &#8230;&#8203;).</p></td></tr></table></div><p>After deploying QSP in several mission-critical applications, we found that
including all the components in a single [huge] XML configuration file
was not a good idea.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Although several QSP components supported some limited ReConfiguration,
many others didn&#8217;t. As a result, major changes usually involved restarting
the application (a very costly operation in a 24/7 system).</li><li class="listitem">If for some reason, the changes involved went beyond just tweaking a
configuration file and required additional changes in a supporting
jar file, the application had to be restarted (QSP didn&#8217;t support
dynamic classloading).</li><li class="listitem">Having a single big configuration file has proven to be error-prone.
Although initially intended to be accessible to system operators,
changing QSP files on critical systems became an  <span class="emphasis"><em>art</em></span> reserved for
experienced operators.</li></ul></div><p>Therefore, we&#8217;ve decided to use a simpler approach: A new container (called Q2,
short for QSP version 2) with a file per component and a very simple lifecycle
to ease the implementation of such components, called <span class="strong"><strong>QBeans</strong></span> (Q2 Beans).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>We use the terms <span class="strong"><strong>QBeans</strong></span>
and <span class="strong"><strong>Q2 service</strong></span> interchangeable.</p></td></tr></table></div><p>QBeans are MBeans (see JMX specs) that implement the Q2&#8217;s lifecycle
(init/start/stop/destroy) set of operations. Q2 takes care of
registering them with the system&#8217;s MBeanServer.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="running_Q2"></a>7.1&nbsp;Running Q2</h2></div></div></div><p>Running Q2 is as simple as calling <code class="literal">java -jar jpos.jar</code>, provided
the jPOS dependencies are available in the <code class="literal">lib</code> directory.</p><p>The reason why this works without setting a specific CLASSPATH is because
we have configured the build system to produce a suitable MANIFEST.MF
that contains the following relevant parts:</p><pre class="programlisting">...
...
Main-Class: org.jpos.q2.Q2
Class-Path: lib/jdom-1.1.3.jar lib/jdbm-1.0.jar lib/je-4.1.10.jar lib/
 commons-cli-1.2.jar lib/jline-1.0.jar lib/bsh-2.0b5.jar lib/javatuple
  s-1.2.jar lib/xercesImpl-2.10.0.jar lib/org.osgi.core-4.3.1.jar lib/x
   ml-apis-1.4.01.jar
...
...</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can of course use the more convenient <code class="literal">bin/q2</code> script (or <code class="literal">bin\q2.bat</code> in Windows),
but you don&#8217;t have to worry about setting up a classpath if the <code class="literal">lib</code> directory relative
to your current working directory has the appropriate support files.</p></td></tr></table></div><p>Q2 accepts several command line switches; for a complete list,
use <code class="literal">--help</code>, e.g.:</p><pre class="screen">bin/q2 --help

usage: Q2
 -C,--config &lt;arg&gt;                 Configuration bundle
 -c,--command &lt;arg&gt;                Command to execute
 -d,--deploydir &lt;arg&gt;              Deployment directory
 -e,--encrypt &lt;arg&gt;                Encrypt configuration bundle
 -h,--help                         Usage information
 -i,--cli                          Command Line Interface
 -n,--name &lt;arg&gt;                   Optional name (defaults to 'Q2')
 -O,--osgi                         Start experimental OSGi framework
                                   server
 -p,--pid-file &lt;arg&gt;               Store project's pid
 -r,--recursive                    Deploy subdirectories recursively
 -s,--ssh                          Enable SSH server
 -sa,--ssh-authorized-keys &lt;arg&gt;   Path to authorized key file (defaults
                                   to 'cfg/authorized_keys')
 -sh,--ssh-host-key-file &lt;arg&gt;     ssh host key file, defaults to
                                   'cfg/hostkeys.ser'
 -sp,--ssh-port &lt;arg&gt;              ssh port (defaults to 2222)
 -su,--ssh-user &lt;arg&gt;              ssh user (defaults to 'admin')
 -v,--version                      Q2's version</pre><p>Q2 has a reasonable set of defaults so you usually don&#8217;t have to use
any argument when calling it. A simple call to <code class="literal">bin/q2</code> should look
like this:</p><pre class="screen">&lt;log realm="Q2.system" at="2016-10-16T20:19:41.174"&gt;
  &lt;info&gt;
    Q2 started, deployDir=/Users/apr/git/jpos/jpos/build/install/jpos/deploy
  &lt;/info&gt;
&lt;/log&gt;</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Please pay attention to the <code class="literal">deployDir</code> shown in the previous log
message. In this case, it reads
<code class="literal">/home/jpos/git/jpos/jpos/build/install/jpos/deploy</code></p><p>You can override the default deploy directory using the <code class="literal">--deploydir</code>
(or just <code class="literal">-d</code>) option when calling Q2.</p><p>In this particular case, we are running off the <code class="literal">build/install/jpos</code>
directory, because we called <code class="literal">gradle installApp</code> which is handy for
local tests.</p></td></tr></table></div><p>At start up time, Q2 scans the <code class="literal">deploy</code> directory looking for
<span class="strong"><strong>deployment descriptors</strong></span> (that we also call <span class="strong"><strong>QBean descriptors</strong></span>).
Those are tiny XML files that are used to start and configure Q2&#8217;s
services.</p><p>The directory is sorted in alphabetical order, providing an easy way
to start services in an ordered way.</p><p>Q2 needs a logger, so the first thing it looks for is a logger configuration,
which has a well known QBean descriptor name: <span class="strong"><strong>00_logger.xml</strong></span>. This is
the only special name used by Q2, and is required to provide some
visibility into the start-up process. If there&#8217;s no <code class="literal">00_logger.xml</code>
defining the <span class="strong"><strong>Q2</strong></span> logger, Q2 creates one on the fly using a
<span class="strong"><strong>SimpleLogListener</strong></span> that outputs log events to <code class="literal">stdout</code>.</p><p>Having no <code class="literal">00_logger.xml</code> file in the <code class="literal">deploy</code> directory is similar
to having one with just the following configuration:</p><pre class="programlisting"><span class="hl-tag">&lt;logger</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.SimpleLogListener"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/logger&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The default jPOS distribution has two pre-configured files
in the deploy directory:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">00_logger.xml</code></li><li class="listitem"><code class="literal">99_sysmon.xml</code></li></ul></div><p>Sysmon starts the jPOS <span class="strong"><strong>SystemMonitor</strong></span> that outputs useful
system health information every hour which is good to keep handy
in production systems.</p><p>Please note that when using the <code class="literal">--cli</code> command line option that starts the jPOS
command line interface, the default deploy directory is <code class="literal">deploy-cli</code> instead of
<code class="literal">deploy</code>. This is to prevent starting services (such as as logger, system monitor)
typically used in jPOS applications. You can of course use the <code class="literal">--deploydir</code>
command line option and point it back to the default <code class="literal">deploy</code> directory.</p><p>The <span class="strong"><strong>CLI</strong></span> can also be accessed via SSH using the <code class="literal">--ssh</code> command line option
(in that case, the default deploy directory doesn&#8217;t change).</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_command_line_options"></a>7.1.1&nbsp;Command line options</h3></div></div></div><p>The <code class="literal">--help</code> command line option is self-explanatory,
it shows the list of available options. Same goes for <code class="literal">--version</code>
it gives you output like this:</p><pre class="screen">$ bin/q2 --version

jPOS 2.0.9-SNAPSHOT master/1592701 (2016-10-16 20:17:56 ART)
...
...</pre><p>followed by the jPOS license in use (see <a class="link" href="#appendix_license" title="Appendix&nbsp;B.&nbsp;License">license</a> for details).</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="cli_commands"></a><code class="literal">--cli</code></h4></div></div></div><p>CLI stands for jPOS Command Line Interface. When calling <code class="literal">bin/q2 --cli</code> you
should see a prompt like this:</p><pre class="screen">$ bin/q2 --cli

q2&gt;</pre><p>Typing <span class="emphasis"><em>tab</em></span> will give you the list of available commands, e.g.:</p><pre class="screen">clr                echo               help               logger_benchmark
shownr             smconsole          tmmon              version
date               env                install            man
shutdown           sysmon             tzcheck            deploy
exit               license            mem                sleep
tail               uptime</pre><p>The <span class="emphasis"><em>man</em></span> command can be used to get information about a given command,
i.e.:</p><pre class="screen">q2&gt; man clr

Clear screen</pre><p>Commands can be separated by a semi-colon, so you can&#8201;&#8212;&#8201;just for fun&#8201;&#8212;&#8201;type</p><pre class="screen">q2&gt; clr; echo Hello; sleep 5; echo jPOS</pre><p>CLI commands are very easy to write, they just have
to implement the <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/q2/CLICommand.html" target="_top">CLICommand</a>
interface.</p><p>Just to give you an example, the <code class="literal">sleep</code> command is implemented like this:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SLEEP <span class="hl-keyword">implements</span> CLICommand {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> exec(CLIContext cli, String[] args) <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">if</span> (args.length &gt; <span class="hl-number">1</span>) {
            Thread.sleep(Long.parseLong(args[<span class="hl-number">1</span>]) * <span class="hl-number">1000</span>);
        }
        <span class="hl-keyword">else</span> {
            cli.println(<span class="hl-string">"Usage: sleep number-of-seconds"</span>);
        }
    }
}</pre><p>As mentioned above, when you type <span class="emphasis"><em>tab</em></span>, jPOS gives you a list of
commands. This may change in the future (as we move to OSGi and perhaps
its console service) but right now, we have an easy way to detect CLI
commands: <span class="strong"><strong>they live in the <code class="literal">org.jpos.q2.cli</code> package</strong></span>.</p><p>If you navigate to
<a class="link" href="https://github.com/jpos/jPOS/tree/master/jpos/src/main/java/org/jpos/q2/cli" target="_top">jpos/src/main/java/org/jpos/q2/cli</a>
you&#8217;ll see files like:</p><pre class="screen">CLR.java
COPYRIGHT.java
DATE.java
ECHO.java
HELP.java
INSTALL.java
LICENSE.java
MAN.java
MEM.java
SHOWNR.java
SHUTDOWN.java
SLEEP.java
SMCONSOLE.java
SYSMON.java
TAIL.java
TMMON.java
UPTIME.java
VERSION.java</pre><p>The command <code class="literal">HELP</code> reads the manual pages for a given command from a resource
named after the command and ending with the <span class="emphasis"><em>.man</em></span> extension, so if you
navigate to
<a class="link" href="https://github.com/jpos/jPOS/tree/master/jpos/src/main/resources/org/jpos/q2/cli" target="_top">resources</a>
directory, you&#8217;ll see files like:</p><pre class="screen">CLR.man
INSTALL.man
MEM.man
SHOWNR.man
SHUTDOWN.man
SMCONSOLE.man
TAIL.man
TMMON.man</pre><p>Containing the help text for some commands.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>CLI commands become more interesting when combined with the ability
to "connect" to a JVM running Q2 from a remote location, i.e. using
the <code class="literal">--ssh</code> command line option.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>CLI commands use <code class="literal">jLine3</code> that supports tab completion and
basic edit capabilities using the cursor, similar to those
of <code class="literal">readline</code>. Try to type <span class="emphasis"><em>tab</em></span> while typing a command,
<code class="literal">jLine</code> will complete it for you.</p></td></tr></table></div><p>Some CLI commands are just little proof-of-concept commands that we wrote
while coding the CLI subsystem in order to test it, but a few deserve
some additional comments:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>shownr</strong></span> will give you a useful dump of the <code class="literal">NameRegistrar</code></li><li class="listitem"><span class="strong"><strong>sysmon</strong></span> will give you output similar to the <code class="literal">SystemMonitor</code></li><li class="listitem"><span class="strong"><strong>tail</strong></span>, similar to the Unix command <span class="emphasis"><em>tail</em></span> allows you to monitor
the output of a jPOS logger in real-time.</li><li class="listitem"><span class="strong"><strong>tmmon</strong></span> allows you to monitor the TransactionManager in real-time.</li><li class="listitem"><span class="strong"><strong>smconsole</strong></span> is a wrapper around the old jPOS security console that
allows you to call it from the jPOS jar so that you don&#8217;t have to
setup the full classpath.</li><li class="listitem"><span class="strong"><strong>install</strong></span> extracts sample QBean descriptors from jars in the classpath
and place them in the <span class="emphasis"><em>deploy</em></span> directory</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The last command <span class="emphasis"><em>install</em></span> deserves further comment. In jPOS-EE we
build applications off multiple little <span class="emphasis"><em>modules</em></span> that are distributed
via a Maven repository. Some of those require some configuration files
that are usually placed in the <code class="literal">META-INF/q2/installs</code> directory.</p><p>If you look inside the jPOS jar, you&#8217;ll see that the <code class="literal">META-INF/q2/installs</code>
directory contain sample <code class="literal">deploy/00_logger.xml</code> and <code class="literal">deploy/99_sysmon.xml</code>
that could be easily extracted using the aforementioned <code class="literal">install</code> command.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_command_arg"></a><code class="literal">--command &lt;arg&gt;</code></h4></div></div></div><p>Can be used to run a CLI command from the command line, e.g.:</p><pre class="screen">bin/q2 --command "install --force"</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_deploydir_arg"></a><code class="literal">--deploydir &lt;arg&gt;</code></h4></div></div></div><p>If you want to use a deploy directory other than the default <code class="literal">deploy</code>
you can use this <code class="literal">deploydir</code> option. This can be useful to run different
environments (i.e. <code class="literal">deploy_prod</code> versus <code class="literal">deploy_test</code>).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_recursive"></a><code class="literal">--recursive</code></h4></div></div></div><p>This allows you to put some order and hierarchy into your deploy
directory if it becomes too big. You can create sub directories
to group together deployment descriptors associated with different
subsystems.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_config_arg"></a><code class="literal">--config &lt;arg&gt;</code></h4></div></div></div><p>During the migration from <code class="literal">QSP</code> to <code class="literal">Q2</code>, jPOS users were used to
the monolithic <code class="literal">QSP</code> single XML file and while most users
appreciated the value of the fine grained file-per-service
configuration, a few others requested to keep the ability to run
off a single configuration file.</p><p>To create a single config file, you can concatenate together multiple
Q2 descriptors and wrap them with an outer root XML element. The
name of the outer element is not defined, you can use anything you
like, i.e: <code class="literal">&lt;q2&gt;</code> or <code class="literal">&lt;bundle&gt;</code> or any other name.</p><p>Here is a sample config:</p><pre class="programlisting"><span class="hl-tag">&lt;q2&gt;</span>
  <span class="hl-tag">&lt;logger</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.qbean.LoggerAdaptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.SimpleLogListener"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/logger&gt;</span>

  <span class="hl-tag">&lt;sysmon</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sleepTime"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Long"</span><span class="hl-tag">&gt;</span>3600000<span class="hl-tag">&lt;/attr&gt;</span>
   <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"detailRequired"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Boolean"</span><span class="hl-tag">&gt;</span>true<span class="hl-tag">&lt;/attr&gt;</span>
  <span class="hl-tag">&lt;/sysmon&gt;</span>
<span class="hl-tag">&lt;/q2&gt;</span></pre><p>Running <code class="literal">bin/q2 --config your-config-file.xml</code> will basically
extract each descriptor out of the config file and place it in
the <code class="literal">deploy</code> directory before actually starting Q2.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_encrypt_arg"></a><code class="literal">--encrypt &lt;arg&gt;</code></h4></div></div></div><p>There are situations where you want to hide some service
configuration from an occasional lurker. You can encrypt
it using this command. The encryption key can be changed,
but it ultimately is stored inside the program, so this is
not very secure, but it&#8217;s good enough to keep an operator
from looking at your QBean descriptors.</p><p>The technique to encrypt a service is similar to the one used
in the previous command <code class="literal">--config</code>, you create an XML file
with the services you want to encrypt, wrapped by an outer
XML root element (again, with any name you want) and call
<code class="literal">bin/q2 --encrypt file-to-encrypt.xml</code></p><p>If we call <code class="literal">bin/q2 --encrypt /tmp/sample.xml</code> the system will
start, but if you look at the <code class="literal">deploy</code> directory, you&#8217;ll see
that the files that describe the logger and sysmon QBeans
now look like this:</p><pre class="programlisting"><span class="hl-tag">&lt;protected-qbean&gt;</span>
  <span class="hl-tag">&lt;data&gt;</span>6E6A0A545209A80B4AC2735F3DA72..............
  ....065345C9CC6FEAE4186D1AE8D4D4B2E54FEA1AB4777B3<span class="hl-tag">&lt;/data&gt;</span>
<span class="hl-tag">&lt;/protected-qbean&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Please consider this a small protection against an occasional observer.</p></td></tr></table></div></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="embedding_Q2"></a>7.2&nbsp;Embedding Q2</h2></div></div></div><p>While we usually start Q2 from the command line (using the <code class="literal">bin/q2</code> or
<code class="literal">bin/q2.bat</code> script), Q2 can be instantiated and started from a Java
application using code like this:</p><pre class="programlisting"><span class="hl-keyword">import</span> org.jpos.q2.Q2;
...
...
Q2 q2 = <span class="hl-keyword">new</span> Q2(<span class="hl-string">"path/to/your/deploy/directory"</span>);
q2.start();
...
...</pre><p>You can stop Q2 by calling <code class="literal">q2.stop()</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="q2_shutdown"></a>7.3&nbsp;Shutting down Q2</h2></div></div></div><p>If we recall <a class="xref" href="#writing_first_script" title="7.4&nbsp;Writing your first Q2 Script">Section&nbsp;7.4, &#8220;Writing your first Q2 Script&#8221;</a>, we have a <code class="literal">QFactory.properties</code> file
with some mappings, including a <code class="literal">shutdown</code> mapping:</p><pre class="screen">shutdown=org.jpos.q2.qbean.Shutdown</pre><p>So shutting down Q2 is as easy as deploying a QBean&#8201;&#8212;&#8201;let&#8217;s call it
<code class="literal">shutdown.xml</code>&#8201;&#8212;&#8201;with content like this:</p><pre class="programlisting">    <span class="hl-tag">&lt;shutdown /&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The name <code class="literal">shutdown.xml</code> can of course be any other name you want.</p></td></tr></table></div><p>The shutdown QBean is implemented like this:</p><pre class="programlisting">    <span class="hl-keyword">package</span> org.jpos.q2.qbean;
    <span class="hl-keyword">import</span> org.jpos.q2.QBeanSupport;
    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Shutdown <span class="hl-keyword">extends</span> QBeanSupport {
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> startService() {
            getServer().shutdown ();                                 <a name="CO5-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
        }
    }</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO5-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>This <code class="literal">getServer()</code> method gives us a reference to the Q2 server.
It works because <code class="literal">Shutdown</code> extends <code class="literal">QBeanSupport</code> which in turn
implements the method <code class="literal">setServer(Q2)</code> called by <code class="literal">Q2</code> via
reflection as described in <a class="xref" href="#qbean_support" title="7.6&nbsp;QBeanSupport">Section&nbsp;7.6, &#8220;QBeanSupport&#8221;</a>.</p></td></tr></table></div><p>By deploying the <code class="literal">shutdown</code> QBean you have a clean way to stop a given
Q2 instance without knowing its process ID.</p><p>jPOS provides a <code class="literal">bin/stop</code> script implemented like this:</p><pre class="screen">#!/bin/sh

echo Stopping Q2
echo '&lt;shutdown/&gt;' &gt; `dirname $0`/../deploy/shutdown.xml</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p><code class="literal">bin/start</code> which in turn calls <code class="literal">bin/q2</code> removes <code class="literal">deploy/shutdown.xml</code>
before starting. If you use this shutdown technique using a shutdown name
other than <code class="literal">shutdown.xml</code> and your find yourself in a situation where Q2
starts and then immediately stops, check the <code class="literal">deploy</code> directory for services
deploying the Shutdown service.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="writing_first_script"></a>7.4&nbsp;Writing your first Q2 Script</h2></div></div></div><p>Once you have your Q2 running and checking the <code class="literal">deploy</code> directory for new
QBean descriptors (XML files) as well as the <code class="literal">deploy/lib</code> directory for new
<code class="literal">jars</code>, you can try to deploy a QBean.</p><p>Just to test the waters, we&#8217;ll show you how to deploy a <code class="literal">BeanShell</code>
<a href="#ftn.d0e5543" class="footnote" name="d0e5543"><sup class="footnote">[5]</sup></a> based QBean.</p><p>Use your preferred text editor to write an XML file like this:</p><pre class="programlisting"><span class="hl-tag">&lt;script&gt;</span>
  log.info ("Hello jPOS!");
<span class="hl-tag">&lt;/script&gt;</span></pre><p>Let&#8217;s call it <code class="literal">90_hello_jpos.xml</code> and save it in a temporary directory.</p><p>Now copy that file to your <code class="literal">deploy</code> directory and you should see output
like this:</p><pre class="programlisting"><span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"Q2.system"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sat Oct 19 20:15:48 UYST 2013.237"</span> <span class="hl-attribute">lifespan</span>=<span class="hl-value">"150ms"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    deploy: /home/jpos/jpos/build/install/jpos/deploy/90_hello_jpos.xml
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span>
<span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"script"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sat Oct 19 20:15:48 UYST 2013.244"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    Hello jPOS!
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span></pre><p>That little script is equivalent to:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'script'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.q2.qbean.BSH'</span> <span class="hl-attribute">logger</span>=<span class="hl-value">'Q2'</span><span class="hl-tag">&gt;</span>
  log.info ("Hello jPOS!");
<span class="hl-tag">&lt;/qbean&gt;</span></pre><p>The reasons this works without specifying the class name, logger name are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">If there&#8217;s no <code class="literal">name</code> attribute, Q2 uses the root XML element name as
the bean name, in this case <span class="emphasis"><em>script</em></span>.</li><li class="listitem">If there&#8217;s no <code class="literal">logger</code> attribute, Q2 assigns the default logger name <code class="literal">Q2</code>.</li><li class="listitem">If there&#8217;s no <code class="literal">class</code> attribute, the root element name is used to find
a resource with the mapping. The resource is placed in the
<a class="link" href="https://github.com/jpos/jPOS/blob/master/jpos/src/main/resources/org/jpos/q2/QFactory.properties#L3" target="_top"><code class="literal">QFactory.properties</code></a></li></ul></div><p>As of this writing mapping, <code class="literal">QFactory.properties</code> looks like this:</p><pre class="screen">logger=org.jpos.q2.qbean.LoggerAdaptor
shutdown=org.jpos.q2.qbean.Shutdown
script=org.jpos.q2.qbean.BSH
jython=org.jpos.q2.qbean.Jython
spacelet=org.jpos.q2.qbean.SpaceLet
sysmon=org.jpos.q2.qbean.SystemMonitor
txnmgr=org.jpos.transaction.TransactionManager
transaction-manager=org.jpos.transaction.TransactionManager
qmux=org.jpos.q2.iso.QMUX
channel-adaptor=org.jpos.q2.iso.ChannelAdaptor
qexec=org.jpos.q2.qbean.QExec</pre><p>that explains the reason why you can write <code class="literal">&lt;txnmgr&gt;&#8230;&#8203;&lt;/txnmgr&gt;</code> or
<code class="literal">&lt;qmux&gt;&#8230;&#8203;&lt;/qmux&gt;</code> without specifying a <code class="literal">class</code> attribute.</p><p>The previous BeanShell based QBean is very useful to run quick tests or
hot fixes to a running jPOS system. Sometimes the Java code written
inside the <code class="literal">&lt;script&gt;&#8230;&#8203;&lt;/script&gt;</code> XML elements need to use some XML
reserved characters (like <span class="emphasis"><em>&lt;</em></span> or <span class="emphasis"><em>&gt;</em></span>). The easiest way to achieve that
is to use a <code class="literal">CDATA</code> block, like this:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'script'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.q2.qbean.BSH'</span> <span class="hl-attribute">logger</span>=<span class="hl-value">'Q2'</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;![CDATA[</span> <a name="CO6-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
  log.info ("Hello jPOS!");
]]&gt;<span class="hl-tag">&lt;/qbean&gt;</span>                                                              <a name="CO6-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Note the <code class="literal">&lt;![CDATA[ start</code></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO6-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>And its end <code class="literal">]]&gt;</code></p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="qtest"></a>7.5&nbsp;QTest - a sample QBean</h2></div></div></div><p>Here is sample code for a simple test QBean. We&#8217;ll call it <code class="literal">QTest</code>:</p><pre class="programlisting"><span class="hl-keyword">package</span> org.jpos.qtest;

<span class="hl-keyword">import</span> org.jpos.iso.ISOUtil;
<span class="hl-keyword">import</span> org.jpos.q2.Q2;
<span class="hl-keyword">import</span> org.jpos.q2.QBean;
<span class="hl-keyword">import</span> org.jpos.util.Log;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> QTest <span class="hl-keyword">implements</span> QBean, Runnable {
    <span class="hl-keyword">volatile</span> <span class="hl-keyword">int</span> state;
    <span class="hl-keyword">long</span> tickInterval = <span class="hl-number">1000</span>;                                <a name="CO7-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    Log log;

    <span class="hl-keyword">public</span> QTest () {
        <span class="hl-keyword">super</span>();
        state = -<span class="hl-number">1</span>;
        log = Log.getLog(Q2.LOGGER_NAME, <span class="hl-string">"qtest"</span>);           <a name="CO7-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
        log.info (<span class="hl-string">"constructor"</span>);
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init () {
        log.info(<span class="hl-string">"init"</span>);
        state = STARTING;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> start() {
        log.info (<span class="hl-string">"start"</span>);
        state = STARTED;
        <span class="hl-keyword">new</span> Thread(<span class="hl-keyword">this</span>).start();
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> stop () {
        log.info (<span class="hl-string">"stop"</span>);
        state = STOPPING;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> destroy () {
        log.info (<span class="hl-string">"destroy"</span>);
        state = STOPPED;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTickInterval (<span class="hl-keyword">long</span> tickInterval) {
        <span class="hl-keyword">this</span>.tickInterval = tickInterval;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getTickInterval () {
        <span class="hl-keyword">return</span> tickInterval;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run () {
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> tickCount=<span class="hl-number">0</span>; running (); tickCount++) {
            log.info (<span class="hl-string">"tick "</span> + tickCount);
            ISOUtil.sleep (tickInterval);
        }
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getState () {
        <span class="hl-keyword">return</span> state;
    }
    <span class="hl-keyword">public</span> String getStateAsString () {
        <span class="hl-keyword">return</span> state &gt;= <span class="hl-number">0</span> ? stateString[state] : <span class="hl-string">"Unknown"</span>;
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> running() {
        <span class="hl-keyword">return</span> state == QBean.STARTING || state == QBean.STARTED;
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>tickInterval is a custom attribute of this QBean</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO7-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>in this example, we use the general purpose Q2 logger</p></td></tr></table></div><h4><a name="_building_qtest"></a>Building QTest</h4><p>The easiest way to play with jPOS is to use the <a class="link" href="https://github.com/jpos/jPOS-template" target="_top">jPOS Template</a> project.</p><p>Open a terminal (or Command window if you&#8217;re on Windows), move to a temporary
directory and type:</p><pre class="screen">git clone git@github.com:jpos/jPOS-template.git qtest

---[ output should look like this ]---
Cloning into 'qtest'...
remote: Counting objects: 165, done.
remote: Compressing objects: 100% (70/70), done.
remote: Total 165 (delta 82), reused 162 (delta 81)
Receiving objects: 100% (165/165), 87.34 KiB | 101 KiB/s, done.
Resolving deltas: 100% (82/82), done.</pre><p>Then <code class="literal">cd</code> to your newly created <code class="literal">qtest</code> directory and try:</p><pre class="screen">mkdir -p src/main/java/org/jpos/qtest</pre><p>Copy and paste the previous code in a file named <code class="literal">QTest.java</code>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>For your convenience, you can download the sources for <code class="literal">QTest</code>
and <code class="literal">QTestMBean</code> classes from <a class="link" href="http://us.jpos.org/examples/qtest-1.0.0.jar" target="_top">jPOS examples</a>.</p></td></tr></table></div><p>Now create an XML file, (let&#8217;s call it <code class="literal">90_qtest.xml</code>) like this in the <code class="literal">src/dist/deploy</code> directory:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.qtest.QTest'</span><span class="hl-tag"> /&gt;</span></pre><p>Now run <code class="literal">gradle installApp</code> or its handy abbreviation <code class="literal">gradle iA</code>
(see <a class="xref" href="#building" title="1.7&nbsp;Building jPOS">Section&nbsp;1.7, &#8220;Building jPOS&#8221;</a> for additional information about how to run Gradle or
 its wrapper <code class="literal">gradlew</code> or <code class="literal">gradlew.bat</code>).</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you have <code class="literal">Gradle</code> installed, you should be able to run the
previous command. Otherwise, there&#8217;s a handy <code class="literal">gradlew</code>
(and <code class="literal">gradelw.bat</code> if you&#8217;re on Windows).</p></td></tr></table></div><p>This is not going to work, but it&#8217;s worth to run it and see the error
so you can understand how Q2 loads its QBeans, which are actually
<a class="link" href="http://docs.oracle.com/javase/tutorial/jmx/mbeans/" target="_top">JMX MBeans</a>.</p><p>The <code class="literal">gradle installApp</code> command should have created a jPOS application
in the <code class="literal">build/install/qtest</code> directory, so you can navigate there
(<code class="literal">cd buildl/install/qtest</code>) and call <code class="literal">bin/q2</code> (or <code class="literal">bin\q2.bat</code> if
you are on Windows).</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you don&#8217;t want to navigate to the <code class="literal">build/install/qtest</code> directory,
you can call <code class="literal">gradle run</code> in the top level directory of the project
or module. This is of course a bad idea for production as you would
be loading Gradle in memory for no reason.</p></td></tr></table></div><p>After running it, you should see output like this:</p><pre class="programlisting"><span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"Q2.system"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:16:47 UYST 2013.61"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;warn&gt;</span>
  Tidying build/install/qtest/deploy/90_qtest.xml out of the            <a name="CO8-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
  way, by adding .BAD
 <span class="hl-tag">&lt;/warn&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span>

<span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"Q2.system"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:16:47 UYST 2013.62"</span> <span class="hl-attribute">lifespan</span>=<span class="hl-value">"5ms"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;info&gt;</span>
  deploy: /private/tmp/test/qtest/build/install/qtest/deploy/90_qtest.xml
  <span class="hl-tag">&lt;exception</span> <span class="hl-attribute">name</span>=<span class="hl-value">"MBean class org.jpos.test.QTest does not implement   </span><a name="CO8-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
DynamicMBean, and neither follows the Standard MBean conventions
(javax.management.NotCompliantMBeanException: Class org.jpos.test.QTest
is not a JMX compliant Standard MBean) ...
  ...
  ...
 <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Q2 detects that there&#8217;s a problem with this QBean. In order to
prevent the problem from happening again, it renames it to an
extension other than <code class="literal">.xml</code>, and as an eye-catcher, it calls it
<code class="literal">.BAD</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO8-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>The reason for the error is shown below: <code class="literal">QTest</code> is a not compliant
MBean and can&#8217;t be loaded+.</p></td></tr></table></div><p>Q2 uses a JMX MbeanServer to create instances of QBeans, and JMX expects
to pick some information about these classes using and interface named
after the class name and ending with <code class="literal">MBean</code>.</p><p>So if we are loading a class called <code class="literal">org.jpos.test.QTest</code>, the JMX MBeanServer
will attempt to load an interface called <code class="literal">org.jpos.test.QTestMBean</code> first,
if it&#8217;s not there, it won&#8217;t load your QBean.</p><p>Now let&#8217;s create that simple MBean file and place it in
<code class="literal">src/main/java/org/jpos/test/QTestMBean.java</code>.
It looks like this:</p><pre class="programlisting"><span class="hl-keyword">package</span> org.jpos.qtest;

<span class="hl-keyword">import</span> org.jpos.q2.QBean;

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> QTestMBean <span class="hl-keyword">extends</span> QBean {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTickInterval(<span class="hl-keyword">long</span> tickInterval) ;
    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getTickInterval() ;
}</pre><p>In addition, we need to change our <code class="literal">QTest</code> so that it <code class="literal">implements QTestMBean</code>.
Because <code class="literal">QTestMBean</code> extends <code class="literal">QBean</code>, we can change:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> QTest <span class="hl-keyword">implements</span> QBean, Runnable {
 ...
 ...
}</pre><p>so that it reads</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> QTest <span class="hl-keyword">implements</span> QTestMBean, Runnable {
 ...
 ...
}</pre><p>Now if you run <code class="literal">build/install/qtest/bin/q2</code> you&#8217;ll see messages like:</p><pre class="programlisting"><span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"qtest"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:51:27 UYST 2013.28"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    init
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span>
<span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"qtest"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:51:27 UYST 2013.35"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    start
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span>
<span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"qtest"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:51:27 UYST 2013.37"</span> <span class="hl-attribute">lifespan</span>=<span class="hl-value">"1ms"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    tick 0
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span>
...
...
<span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"qtest"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:51:28 UYST 2013.38"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    tick 1
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span>
...
...
<span class="hl-tag">&lt;log</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"qtest"</span> <span class="hl-attribute">at</span>=<span class="hl-value">"Sun Oct 20 16:51:29 UYST 2013.40"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;info&gt;</span>
    tick 2
  <span class="hl-tag">&lt;/info&gt;</span>
<span class="hl-tag">&lt;/log&gt;</span></pre><p>Approximately every second we see a <span class="emphasis"><em>tick</em></span> message, issues by our little
<code class="literal">run()</code> method:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run () {
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> tickCount=<span class="hl-number">0</span>; running (); tickCount++) {
            log.info (<span class="hl-string">"tick "</span> + tickCount);
            ISOUtil.sleep (tickInterval);
        }
    }</pre><p>While Q2 is running and <span class="emphasis"><em>ticking</em></span>, you can launch <code class="literal">jconsole</code>, connect
to the running process and navigate to the <code class="literal">QTest</code> QBean attributes to
see the <code class="literal">tickInterval</code>. You are free to change it to another value and
that will change the behavior of the running QTest QBean.</p><p>The screen will look something like this:</p><p><span class="inlinemediaobject"><img src="images/qtest_interval_jconsole.png" alt="QTest/jConsole"></span></p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you are running Q2 using the <code class="literal">gradle run</code> tasks, you&#8217;ll find out
you won&#8217;t get to see the Q2 MBean under the MBeans tabs, you&#8217;ll see
just the system MBeans.</p><p>The reason for this is that <code class="literal">com.sun.management.jmxremote</code> option
is not set by default. If you&#8217;re running the <code class="literal">bin/q2</code> script, there&#8217;s
a <code class="literal">-Dcom.sun.management.jmxremote</code> in the JVM invocation and that&#8217;s the
reason the Q2 MBeans can be managed.</p></td></tr></table></div><h4><a name="_push_configuration_setting_qbean_attributes"></a>PUSH configuration - Setting QBean attributes</h4><p>In the same way you can use <code class="literal">jconsole</code> to tweak the QBean attributes
defined in the MBean, you can use the XML <span class="emphasis"><em>attr</em></span> element in the
QBean descriptor. Q2 will use the MBeanServer to send them via JMX.</p><p>So you can change the <code class="literal">90_qtest.xml</code> file (in the <code class="literal">src/dist/deploy</code>)
directory to look like this:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.qtest.QTest'</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"tickInterval"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Long"</span><span class="hl-tag">&gt;</span>5000<span class="hl-tag">&lt;/attr&gt;</span>
<span class="hl-tag">&lt;/qbean&gt;</span></pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If no <span class="emphasis"><em>type</em></span> attribute, the default is <span class="emphasis"><em>java.lang.String</em></span>.
<code class="literal">java.lang.Long</code> can be abbreviated as just <code class="literal">long</code>, same goes
for <code class="literal">int</code> (<code class="literal">java.lang.Integer) and +boolean</code> (<code class="literal">java.lang.Boolean</code>)</p></td></tr></table></div><h4><a name="_pull_configuration_implementing_configurable"></a>PULL configuration - implementing Configurable</h4><p>Pushing configuration using attributes provides a lot of runtime
flexibility, but requires a lot of boilerplate code with the MBean
interfaces. Sometimes it&#8217;s easier to just implement the very simple
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/core/Configurable.html" target="_top">Configurable</a>
interface and adding a few child <code class="literal">property</code> elements in the QBean
descriptor.</p><p>Let&#8217;s change our QTest class to read like this:</p><pre class="programlisting"><span class="hl-keyword">package</span> org.jpos.test;

<span class="hl-keyword">import</span> org.jpos.core.Configurable;
<span class="hl-keyword">import</span> org.jpos.core.Configuration;
<span class="hl-keyword">import</span> org.jpos.iso.ISOUtil;
<span class="hl-keyword">import</span> org.jpos.q2.Q2;
<span class="hl-keyword">import</span> org.jpos.q2.QBean;
<span class="hl-keyword">import</span> org.jpos.util.Log;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> QTest <span class="hl-keyword">implements</span> QTestMBean, Runnable, Configurable {          <a name="CO9-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-keyword">volatile</span> <span class="hl-keyword">int</span> state;
    <span class="hl-keyword">long</span> tickInterval = <span class="hl-number">1000</span>;
    Log log;
    <span class="hl-keyword">boolean</span> debug;                                                          <a name="CO9-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>

    <span class="hl-keyword">public</span> QTest () {
        <span class="hl-keyword">super</span>();
        state = -<span class="hl-number">1</span>;
        log = Log.getLog(Q2.LOGGER_NAME, <span class="hl-string">"qtest"</span>);
        log (<span class="hl-string">"constructor"</span>);
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init () {
        log (<span class="hl-string">"init"</span>);
        state = STARTING;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> start() {
        log (<span class="hl-string">"start"</span>);
        state = STARTED;
        <span class="hl-keyword">new</span> Thread(<span class="hl-keyword">this</span>).start();
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> stop () {
        log (<span class="hl-string">"stop"</span>);
        state = STOPPING;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> destroy () {
        log (<span class="hl-string">"destroy"</span>);
        state = STOPPED;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTickInterval (<span class="hl-keyword">long</span> tickInterval) {
        <span class="hl-keyword">this</span>.tickInterval = tickInterval;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">long</span> getTickInterval () {
        <span class="hl-keyword">return</span> tickInterval;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run () {
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> tickCount=<span class="hl-number">0</span>; running (); tickCount++) {
            log.info (<span class="hl-string">"tick "</span> + tickCount);
            ISOUtil.sleep (tickInterval);
        }
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getState () {
        <span class="hl-keyword">return</span> state;
    }
    <span class="hl-keyword">public</span> String getStateAsString () {
        <span class="hl-keyword">return</span> state &gt;= <span class="hl-number">0</span> ? stateString[state] : <span class="hl-string">"Unknown"</span>;
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setConfiguration (Configuration cfg) {                      <a name="CO9-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
        debug = cfg.getBoolean(<span class="hl-string">"debug"</span>, true);
    }

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> running() {
        <span class="hl-keyword">return</span> state == QBean.STARTING || state == QBean.STARTED;
    }
    <span class="hl-keyword">private</span> <span class="hl-keyword">void</span> log (String message) {
        <span class="hl-keyword">if</span> (debug)                                                          <a name="CO9-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
            log (message);
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Implement <code class="literal">Configurable</code></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>add a new <span class="emphasis"><em>debug</em></span> boolean</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Actual implementation of the <code class="literal">Configurable</code> interface, picks the <code class="literal">debug</code>
property from the XML configuration, defaulting to <code class="literal">true</code></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO9-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Honor the debug property.</p></td></tr></table></div><p>Now the <code class="literal">src/dist/deploy/90_qtest.xml</code> file would look like this:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.test.QTest'</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"debug"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/qbean&gt;</span></pre><p>If you want to set your properties in a separate file, you could
<code class="literal">&lt;property file="xxx" /&gt; instead of +&lt;property name="xx" value="yy" /&gt;</code>,
i.e:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.test.QTest'</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">file</span>=<span class="hl-value">"cfg/myconfig.cfg"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/qbean&gt;</span></pre><p>and then add a file <code class="literal">src/dist/cfg/myconfig.cfg</code>, e.g.:</p><pre class="screen">debug=false</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If the file name ends in <code class="literal">.yml</code>, Q2 handles it as a YAML file.</p></td></tr></table></div><p>The files in the <code class="literal">src/dist</code> directory get copied to <code class="literal">build/install</code> when
we call <code class="literal">gradle installApp</code> or to the <code class="literal">build/distributions</code> when we call
<code class="literal">gradle dist</code> and are subject to property expansion.</p><p>So if instead of writing <code class="literal">debug=false</code>, you put <code class="literal">debug=@debug@</code> (same goes if you use <code class="literal">&lt;property name="debug" value="@debug@" /&gt;</code>), and you add a compile-time
property called <code class="literal">debug</code> to your compile <span class="emphasis"><em>target</em></span>, Gradle will propertly
replace it when copying it to the destination directory.</p><p>In order to test this lets change the file in <code class="literal">src/dist/deploy/90_qtest.xml</code>
to read like this:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.test.QTest'</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"debug"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"@debug@"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/qbean&gt;</span></pre><p>And add a top level file called <code class="literal">devel.properties</code> with a line like this:</p><pre class="screen">debug=yes</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Yes, Q2 understand <span class="emphasis"><em>yes</em></span> and <span class="emphasis"><em>no</em></span> in addition to <span class="emphasis"><em>true</em></span> and <span class="emphasis"><em>false</em></span></p></td></tr></table></div><p>When you call <code class="literal">gradle installApp</code>, the destination file in
<code class="literal">build/install/qtest/deploy/90_qtest.xml</code> will have a <code class="literal">yes</code> instead of
the <code class="literal">@debug@</code> token.</p><p><code class="literal">devel</code> is the default Gradle target defined by jPOS and that&#8217;s the
reason it reads the <code class="literal">devel.properties</code> file. But you can override the
target using the <code class="literal">-Ptarget=xxx</code> parameter, so you can for example
create a file called <code class="literal">prod.properties</code> where <code class="literal">debug=no</code> and then
call <code class="literal">gradle -Ptarget=prod clean installApp</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Please note we&#8217;ve added <code class="literal">clean</code> as part of the build, reason is because
the source file <code class="literal">src/dist/deploy/90_qtest.xml</code> didn&#8217;t change, and the
destination file <code class="literal">build/install/qtest/deploy/90_qtest.xml</code> was created
in the previous step (with the default <code class="literal">devel</code> target), Gradle assumes
the file is up-to-date and do not attempt to re-generate it.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you prefer to have more control over the XML inside your QBeans,
like the one we use in the ChannelAdaptor, QMUX or the TransactionManager
where we have child elements with their own hierarchy (like <span class="emphasis"><em>filters</em></span>,
<span class="emphasis"><em>participants</em></span>, <span class="emphasis"><em>queues</em></span>), you can implement <code class="literal">org.jpos.core.XmlConfigurable</code>
instead of <code class="literal">Configuration</code> so that instead of a flat <code class="literal">Configuration</code>
object, you receive an <code class="literal">org.jdom.Element</code> that you can use to interpret
your own configuration.</p></td></tr></table></div><h4><a name="_honoring_the_logger_and_realm_attributes"></a>Honoring the <span class="emphasis"><em>logger</em></span> and <span class="emphasis"><em>realm</em></span> attributes</h4><p>Q2 uses reflection to find out if a QBean has a method with the
following signature: <code class="literal">void setLogger (String loggerName)</code>, and
and optional <code class="literal">void setRealm (String realm)</code>.</p><p>We can take advantage of that feature by adding
the following code to our QTest file:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setLogger (String loggerName) {
        log = Log.getLog (loggerName, getClass().getName());
        setModified (true);
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setRealm (String realm) {
        <span class="hl-keyword">if</span> (log != null)
            log.setRealm (realm);
    }</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you are starting to get worried about the large number
of options you have when implementing a QBean, don&#8217;t worry,
there&#8217;s a handy support class called <code class="literal">QBeanSupport</code> that you
can extend in order to take advantage of all these features
without having to write a lot of boilerplate code. We&#8217;ll show
you how to use it shortly, but if you want to understand how
Q2 works, we suggest you follow this lengthly step-by-step
explanation.</p></td></tr></table></div><h4><a name="_getting_a_reference_to_the_q2_server"></a>Getting a reference to the Q2 server</h4><p>If your QBean needs a reference to the Q2 server, it can implement the
<code class="literal">setServer(Q2 server)</code> method. Q2 will push a reference to itself at
configuration file.</p><h4><a name="_getting_a_reference_to_the_xml_element_representing_the_qbean_descriptor"></a>Getting a reference to the XML element representing the QBean descriptor</h4><p>If your QBean has a method with the signature <code class="literal">void setPersist(Element e)</code>,
Q2 will push the Element representing the QBean descriptor. This feature
allows a QBean to implement the <code class="literal">QPersist</code> interface, that looks like this:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> QPersist {
    <span class="hl-keyword">public</span> Element getPersist ();
    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> isModified ();
}</pre><p>If your <code class="literal">QBean</code> implements <code class="literal">QPersist</code> and its <code class="literal">isModified()</code>
returns <code class="literal">true</code>, then Q2 will call its <code class="literal">getPersist()</code> to get a new
QBean descriptor and will store it in the <code class="literal">deploy</code> directory.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>This feature is rarely used in jPOS applications, but it&#8217;s there just
in case you want to experiment with it. In our previous <code class="literal">jconsole</code> example,
a change to the <code class="literal">tickInterval</code> done via JMX could be stored in the
<code class="literal">90_qtest.xml</code> file automatically, so it can be honored on the next
restart.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The name <span class="emphasis"><em>persist</em></span> here is a really bad name, something like
<code class="literal">getXmlDescriptor()</code> could have been better.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="qbean_support"></a>7.6&nbsp;QBeanSupport</h2></div></div></div><p>All the details described in our first implementation of <code class="literal">QTest</code> can be
simplified by just extending <a class="link" href="https://github.com/jpos/jPOS/blob/master/jpos/src/main/java/org/jpos/q2/QBeanSupport.java" target="_top">QBeanSupport</a>.</p><p><code class="literal">QBeanSupport</code> implement the <code class="literal">QBean</code> life-cycle methods <code class="literal">init()</code>, <code class="literal">start()</code>,
<code class="literal">stop()</code> and <code class="literal">destroy()</code> and call the protected:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">initService</li><li class="listitem">startService</li><li class="listitem">stopService</li><li class="listitem">destroyService</li></ul></div><p>providing suitable default implementations for those. These methods are
implemented like this:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> init () {
        <span class="hl-keyword">if</span> (state == -<span class="hl-number">1</span>) {
            setModified (false);
            <span class="hl-keyword">try</span> {
                initService();
                state = QBean.STOPPED;
            } <span class="hl-keyword">catch</span> (Throwable t) {
                log.warn (<span class="hl-string">"init"</span>, t);
            }
        }
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">synchronized</span> <span class="hl-keyword">void</span> start() {
        <span class="hl-keyword">if</span> (state != QBean.DESTROYED &amp;&amp;
            state != QBean.STOPPED   &amp;&amp;
            state != QBean.FAILED)
           <span class="hl-keyword">return</span>;

        <span class="hl-keyword">this</span>.state = QBean.STARTING;

        <span class="hl-keyword">try</span> {
           startService();
        } <span class="hl-keyword">catch</span> (Throwable t) {
           state = QBean.FAILED;
           log.warn (<span class="hl-string">"start"</span>, t);
           <span class="hl-keyword">return</span>;
        }
        state = QBean.STARTED;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">synchronized</span> <span class="hl-keyword">void</span> stop () {
        <span class="hl-keyword">if</span> (state != QBean.STARTED)
           <span class="hl-keyword">return</span>;
        state = QBean.STOPPING;
        <span class="hl-keyword">try</span> {
           stopService();
        } <span class="hl-keyword">catch</span> (Throwable t) {
           state = QBean.FAILED;
           log.warn (<span class="hl-string">"stop"</span>, t);
           <span class="hl-keyword">return</span>;
        }
        state = QBean.STOPPED;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> destroy () {
        <span class="hl-keyword">if</span> (state == QBean.DESTROYED)
           <span class="hl-keyword">return</span>;
        <span class="hl-keyword">if</span> (state != QBean.STOPPED)
           stop();

        <span class="hl-keyword">if</span> (scheduledThreadPoolExecutor != null) {
            scheduledThreadPoolExecutor.shutdown();
            scheduledThreadPoolExecutor = null;
        }
        <span class="hl-keyword">try</span> {
           destroyService();
        }
        <span class="hl-keyword">catch</span> (Throwable t) {
           log.warn (<span class="hl-string">"destroy"</span>, t);
        }
        state = QBean.DESTROYED;
    }</pre><p>You can see that they track and validate the state of the QBean,
catch exceptions providing reasonable logging, etc.</p><p>In addition, <code class="literal">QBeanSupport</code> implements <code class="literal">Configurable</code> and exposes
a <code class="literal">public Configuration getConfiguration()</code> method. It has a <code class="literal">setServer(Q2)</code>
method so your implementation can call <code class="literal">getServer()</code> to get a reference
to the Q2 system.</p><p>It also implements a <code class="literal">boolean running()</code> method so that your QBean
can check if the QBean is still running and get out of a running loop.</p><p><code class="literal">QBeanSupport</code> provides a handy <code class="literal">QBeanSupportMBean</code> so if your QBean
does not expose any JMX attribute, you don&#8217;t even have to write an
<code class="literal">xxxMBean</code> interface.</p><p>Our <code class="literal">Qtest</code> implementation could look like this:</p><pre class="programlisting"><span class="hl-keyword">package</span> org.jpos.test;

<span class="hl-keyword">import</span> org.jpos.iso.ISOUtil;
<span class="hl-keyword">import</span> org.jpos.q2.QBeanSupport;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> QTest <span class="hl-keyword">extends</span> QBeanSupport <span class="hl-keyword">implements</span> Runnable {
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> startService() {
        <span class="hl-keyword">new</span> Thread(<span class="hl-keyword">this</span>).start();
    }
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> run () {
        <span class="hl-keyword">for</span> (<span class="hl-keyword">int</span> tickCount=<span class="hl-number">0</span>; running (); tickCount++) {
            log.info (<span class="hl-string">"tick "</span> + tickCount);
            ISOUtil.sleep (cfg.getLong(<span class="hl-string">"tickInterval"</span>, <span class="hl-number">1000L</span>));   <a name="CO10-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
        }
    }
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO10-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>In this case, we are pulling the tickInterval from a <span class="emphasis"><em>property</em></span> with
a default to 1 second. We can off course add a <code class="literal">tickInterval</code>
attribute and expose it in a <code class="literal">QTestMBean</code> interface as described in
the previous section.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="dynamic_classloading"></a>7.7&nbsp;Dynamic classloading</h2></div></div></div><p>In most applications, the business logic and packagers are available in
the classpath, but there are situations where you need to apply a hot
patch such as adding a new field packager, or an ISO filter, so we
have provided this dynamic class loading capabilities.</p><p>If you know OSGi you can laugh as much as we do with our limited
poor-man implementation, it has many drawbacks that we&#8217;ll explain
below, but if you need to apply a hot patch until you can bounce the
system and restart with a new build, you can appreciate that our
dynamic classloading has some use.</p><p>In addition to the <code class="literal">deploy</code> directory that Q2 monitors to see changes
in the deployed services, it also monitors the timestamp of the
<code class="literal">deploy/lib</code> directory, and if changed, it scans all jars in there
and add them to the URL classloader of the MBeanServer, used by
Q2 to instantiate its QBeans.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The previous paragraph basically tells you all you need to know about
jPOS' Q2 dynamic classloading. If you read it again, and understand
every word, then you can skip to the next section. If you have doubts,
we&#8217;ll try to clarify them below.</p></td></tr></table></div><p>Let&#8217;s try a simple example. If you start Q2 in say the <code class="literal">/opt/local/jpos</code>
directory, it will be monitoring the <code class="literal">/opt/local/jpos/deploy</code> directory
for QBean descriptors and the <code class="literal">/opt/local/jpos/deploy/lib</code> for jars
to be added to the classpath.</p><p>At start up the output will look like this:</p><pre class="screen">&lt;log realm="Q2.system"&gt;
  &lt;info&gt;
    Q2 started, deployDir=/opt/local/jpos/deploy
    ...
    ...
  &lt;/info&gt;
&lt;/log&gt;</pre><p>If while Q2 is running you create a <code class="literal">lib</code> directory inside <code class="literal">deploy</code>,
you&#8217;ll see a message like this:</p><pre class="screen">&lt;log realm="Q2.system"&gt;
  &lt;info&gt;
    new classloader [58f0fa12] has been created
  &lt;/info&gt;
&lt;/log&gt;</pre><p>If you then place a jar inside that new <code class="literal">lib</code> directory, <span class="strong"><strong>and you touch</strong></span>
<code class="literal">lib</code> directory so that it changes its timestamp, you&#8217;ll see once again
the message indicating that a new classloader has been created, but this
time, it will contain your new jar.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If the <code class="literal">deploy/lib</code> directory is available, with jars in it,
at Q2 start up time, it will of course be picked up.</p></td></tr></table></div><p>The <span class="emphasis"><em>and you touch</em></span> part mentioned above is important, because Q2 doesn&#8217;t
monitor the jars inside the lib directory, it monitors the timestamp
of the <code class="literal">deploy/lib</code> directory itself. This gives us some kind of poor
man ability to deploy several jars in an atomic way (to manually solve
dependencies).</p><p>So now that the new jar is available in the classpath, you can deploy
your QBean by adding its xml QBean descriptor in the <code class="literal">deploy</code> dir.</p><h4><a name="_dynamically_deploying_qtest"></a>Dynamically deploying QTest</h4><p>If you&#8217;ve followed the instructions in <a class="xref" href="#qtest" title="7.5&nbsp;QTest - a sample QBean">Section&nbsp;7.5, &#8220;QTest - a sample QBean&#8221;</a>, you can copy
<code class="literal">build/libs/qtest-1.0.0.jar</code> generated using <code class="literal">gradle jar</code> into
another jPOS Q2 system (i.e. you could use the default jPOS distro
clone) and follow the previous instructions to run it.</p><p>In addition to that, Q2 support remote dynamic classloading, so instead
of placing your jar in the <code class="literal">deploy/lib</code>, you could load it from a remote
URL.</p><p>For your convenience, we&#8217;ve placed a compiled version of qtest in the
following URL: <code class="literal"><a class="link" href="http://us.jpos.org/private/qtest-1.0.0.jar" target="_top">http://us.jpos.org/private/qtest-1.0.0.jar</a></code>, so you
can deploy in any Q2 system the following QBean:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.qtest.QTest'</span> <span class="hl-attribute">logger</span>=<span class="hl-value">'Q2'</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;classpath&gt;</span>
    <span class="hl-tag">&lt;url&gt;</span>http://us.jpos.org/examples/qtest-1.0.0.jar<span class="hl-tag">&lt;/url&gt;</span>
  <span class="hl-tag">&lt;/classpath&gt;</span>
<span class="hl-tag">&lt;/qbean&gt;</span></pre><p>A QBean can download its supporting classes from multiple URLs, the
previous example could read:</p><pre class="programlisting"><span class="hl-tag">&lt;qbean</span> <span class="hl-attribute">name</span>=<span class="hl-value">'qtest'</span> <span class="hl-attribute">class</span>=<span class="hl-value">'org.jpos.qtest.QTest'</span> <span class="hl-attribute">logger</span>=<span class="hl-value">'Q2'</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;classpath&gt;</span>
    <span class="hl-tag">&lt;url&gt;</span>http://us.jpos.org/examples/qtest-1.0.0.jar<span class="hl-tag">&lt;/url&gt;</span>
    <span class="hl-tag">&lt;url&gt;</span>http://myhost.mydomain.com/another-dependency.jar<span class="hl-tag">&lt;/url&gt;</span>
    ...
  <span class="hl-tag">&lt;/classpath&gt;</span>
<span class="hl-tag">&lt;/qbean&gt;</span></pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>jPOS applications are usually mission critical and highly
sensitive, so in most situations, it&#8217;s not a very good idea to
download the implementation from remote sites.</p><p>But on a local DMZ where you have many nodes using the same code,
it can come very handy to use this feature and download code from
a local artifact server.</p></td></tr></table></div></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d0e4962" class="footnote"><p><a href="#d0e4962" class="simpara"><sup class="simpara">[4] </sup></a><a class="link" href="http://en.wikipedia.org/wiki/Q_code" target="_top">http://en.wikipedia.org/wiki/Q_code</a></p></div><div id="ftn.d0e5543" class="footnote"><p><a href="#d0e5543" class="simpara"><sup class="simpara">[5] </sup></a><a class="link" href="http://beanshell.org/" target="_top">http://beanshell.org/</a></p></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_q2_jpos_services"></a>8.&nbsp;Q2 jPOS Services</h1></div></div></div><p>Before Q2, in the old QSP days, we had a limited set of services
that were migrated to Q2, usually using <span class="emphasis"><em>adaptors</em></span>.</p><p>So the old QSP <code class="literal">channel</code> has now the corresponding <code class="literal">channel-adaptor</code> service,
<code class="literal">dirpoll</code> has a <code class="literal">dirpoll-adaptor</code>, the <code class="literal">security</code> module has a
<code class="literal">SMAdaptor</code> and <code class="literal">KeyStoreAdaptor</code> and so on.</p><p>We document in this chapter these adaptors, along with new services that
have been implemented only in Q2.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="channel_adaptor"></a>8.1&nbsp;ChannelAdaptor</h2></div></div></div><p>When jPOS acts as client from a TCP/IP standpoint, you&#8217;d most likely use
the <code class="literal">ChannelAdaptor</code> service to manage the low level socket connection.</p><p>The <code class="literal">ChannelAdaptor</code> uses the Space to communicate with other jPOS
components, basically through two <span class="emphasis"><em>Space queues</em></span>, one for <span class="strong"><strong>input</strong></span>
and the other one for <span class="strong"><strong>output</strong></span>.</p><p><span class="inlinemediaobject"><img src="images/channel_adaptor.png" alt="ChannelAdaptor"></span></p><p>The <span class="emphasis"><em>in</em></span> and <span class="emphasis"><em>out</em></span> naming convention is easy to remember if
we think of them as <span class="strong"><strong>seen from the component&#8217;s perspective</strong></span>.</p><p>So ChannelAdaptor is monitoring its input (<span class="emphasis"><em>in</em></span>) queue for messages
that are to be sent to the remote host, and places messages received
from the remote host in its output (<span class="emphasis"><em>out</em></span>) queue.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Most of the time, you won&#8217;t have to deal with these queues,
you&#8217;ll just deal with the API provided by higher level components
like <span class="strong"><strong>QMUX</strong></span>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_qbean_descriptor"></a>8.1.1&nbsp;QBean descriptor</h3></div></div></div><p>As described in <a class="xref" href="#running_Q2" title="7.1&nbsp;Running Q2">Section&nbsp;7.1, &#8220;Running Q2&#8221;</a>, Q2 sorts the XML descriptors
available in the <code class="literal">deploy</code> directory alphabetically, as an easy
way to orderly start services.</p><p>We usually use the prefix <span class="strong"><strong>10_</strong></span> for channels, so that when
other components (such as MUXes that use the prefix <span class="emphasis"><em>20_</em></span>) start,
they can use them right away on the first attempt.</p><p>So a reasonable name for a channel descriptor can be something like
<code class="literal">10_xxx_channel.xml</code>.</p><pre class="screen">&lt;channel-adaptor name='your-channel' logger="Q2"&gt;         <a name="CO11-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
 &lt;channel class="org.jpos.iso.channel.NACChannel"
       packager="org.jpos.iso.packager.GenericPackager"   <a name="CO11-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
       header="6000000000"&gt;                               <a name="CO11-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
  &lt;property name="packager-config"                        <a name="CO11-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
           value="jar:packager/iso87binary.xml" /&gt;
  &lt;property name="host" value="127.0.0.1" /&gt;              <a name="CO11-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
  &lt;property name="port" value="8001" /&gt;
  &lt;property name="timeout" value="300000" /&gt;              <a name="CO11-6"></a><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span>
  &lt;filter                                                 <a name="CO11-7"></a><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span>
      class="org.jpos.iso.filter.YourIncomingFilter"
      direction="incoming" /&gt;
  &lt;filter
      class="org.jpos.iso.filter.YourOutgoingFilter"
      direction="outgoing" /&gt;
 &lt;/channel&gt;
 &lt;in&gt;your-channel-send&lt;/in&gt;                               <a name="CO11-8"></a><span><img src="images/icons/callouts/8.png" alt="8" border="0"></span>
 &lt;out&gt;your-channel-receive&lt;/out&gt;                          <a name="CO11-9"></a><span><img src="images/icons/callouts/9.png" alt="9" border="0"></span>
 &lt;reconnect-delay&gt;10000&lt;/reconnect-delay&gt;                 <a name="CO11-10"></a><span><img src="images/icons/callouts/10.png" alt="10" border="0"></span>
&lt;/channel-adaptor&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>The element name <code class="literal">channel-adaptor</code> is defined in <code class="literal">QFactory.properties</code>
(see <a class="xref" href="#writing_first_script" title="7.4&nbsp;Writing your first Q2 Script">Section&nbsp;7.4, &#8220;Writing your first Q2 Script&#8221;</a>) and implies that the class to
be instantiated is <code class="literal">org.jpos.q2.iso.ChannelAdaptor</code>. You can
of course use another root element name and add the <code class="literal">class</code>
attribute if you wish.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>In this example we use the <code class="literal">GenericPackager</code> which is the most
flexible one, but of course, you can use any other custom
packager or some of the stock packagers such as <code class="literal">XMLPackager</code>
or <code class="literal">XML2003Packager</code>. For a complete list of available
packagers see <a class="link" href="https://github.com/jpos/jPOS/tree/master/jpos/src/main/java/org/jpos/iso/packager" target="_top">https://github.com/jpos/jPOS/tree/master/jpos/src/main/java/org/jpos/iso/packager</a></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Although not defined in the <code class="literal">ISOChannel</code> interface, most channels
have a <code class="literal">setHeader(String)</code> method. If the <code class="literal">header</code> attribute is
present in the child <code class="literal">channel</code> element, ChannelAdaptor will use
reflection to call it. How this string is interpreted is specific
to each channel implementation, in this case, <code class="literal">NACChannel</code> assumes
it&#8217;s getting an hex string.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>The <code class="literal">Configuration</code> object is available to the packager, provided
it implements the <code class="literal">Configurable</code> interface as it is the case of
the <code class="literal">GenericPackager</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>The <code class="literal">Configuration</code> object is also available to the channel
implementation (in this case <code class="literal">NACChannel</code> which happens to
implement the <code class="literal">Configurable</code> interface). The host and port
properties in this case are self explanatory, they point
to the remote host.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-6"><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left"><p>Channel level timeout in milliseconds. If the channel does not
receive any traffic in the configured timeout, it will disconnect.
Having a channel level timeout as described here is
<span class="strong"><strong>highly recommended</strong></span>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-7"><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left"><p>The <code class="literal">channel</code> element can have multiple optional <code class="literal">filter</code>
child elements (see <a class="xref" href="#isofilter" title="Filtered Channels">the section called &#8220;Filtered Channels&#8221;</a>). The <code class="literal">direction</code> attribute
is optional, if not present (or if its value is <code class="literal">both</code>),
the filter is configured to process both incoming as well
as outgoing messages.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-8"><span><img src="images/icons/callouts/8.png" alt="8" border="0"></span></a> </p></td><td valign="top" align="left"><p>Space queue used to receive messages to be transmitted to the
remote endpoint.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-9"><span><img src="images/icons/callouts/9.png" alt="9" border="0"></span></a> </p></td><td valign="top" align="left"><p>Messages received from the remote endpoint are placed in
this queue.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO11-10"><span><img src="images/icons/callouts/10.png" alt="10" border="0"></span></a> </p></td><td valign="top" align="left"><p>If the connection to the remote host breaks, ChannelAdaptor
    will try to reconnect after a reasonable delay, expressed
    in millis. If this element is not present, a default of
    10 seconds (10000ms) will be used.
=== SSL connections</p></td></tr></table></div><p>Most channel implementations accept a socket factory, that can be
configured by adding the properties <code class="literal">socketFactory</code> with additional
optional configuration properties required by its implementation.</p><p>In case of the provided <code class="literal">org.jpos.iso.SunJSSESocketFactory</code>, the additional
properties are <code class="literal">storepassword</code>, <code class="literal">keypassword</code> and <code class="literal">keystore</code>.</p><p>The configuration would look like this:</p><pre class="screen"> &lt;property name="socketFactory" value="org.jpos.iso.GenericSSLSocketFactory" /&gt;
 &lt;property name="storepassword" value="password" /&gt;
 &lt;property name="keypassword"   value="password" /&gt;
 &lt;property name="keystore" value="cfg/mykeystore.ks" /&gt;</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Please note that these properties are specific to the channel, so they go
inside the <span class="emphasis"><em>channel</em></span> element, not the outer <span class="emphasis"><em>channel-adaptor</em></span> element.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_handling_alternate_connections"></a>8.1.2&nbsp;Handling alternate connections</h3></div></div></div><p>This is not a feature of the ChannelAdaptor but a feature of BaseChannel,
a support class inherited by most channel implementations (but not all of
them, so please check). Channel implementations extending BaseChannel can
take advantage of the <code class="literal">alternate-host</code> with its companion <code class="literal">alternate-port</code>
configuration property. There can be many of those, but the number of
instances have to match (i.e. if you have 4 <code class="literal">alternate-host</code> definitions,
you need to have 4 <code class="literal">alternate-port</code> definitions).</p><p>When ChannelAdaptor calls the <code class="literal">connect</code> method in the underlying channel,
BaseChannel will attempt a connection to the main host/port. If that
fails, it will attempt the alternate hosts list.</p><p>The configuration looks like this:</p><pre class="screen">&lt;channel-adaptor name='your-channel' logger="Q2"&gt;
 &lt;channel class="org.jpos.iso.channel.NACChannel"
    ....
    ....
    &lt;property name="alternate-host" value="192.168.1.2" /&gt;
    &lt;property name="alternate-host" value="192.168.1.3" /&gt;
    &lt;property name="alternate-host" value="192.168.1.4" /&gt;
    &lt;property name="alternate-host" value="192.168.1.5" /&gt;
    &lt;property name="alternate-port" value="1000" /&gt;
    &lt;property name="alternate-port" value="1000" /&gt;
    &lt;property name="alternate-port" value="1000" /&gt;
    &lt;property name="alternate-port" value="1000" /&gt;
    ....
    ....
 &lt;/channel&gt;
&lt;/channel-adaptor&gt;</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Same as with the previous SSL socket factory, these properties are
specific to the channel, so they go inside the <span class="emphasis"><em>channel</em></span> element, not
the outer <span class="emphasis"><em>channel-adaptor</em></span> element.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_channel_timeout_keep_alive_connection_timeout"></a>8.1.3&nbsp;Channel timeout, keep-alive, connection-timeout</h3></div></div></div><p>We strongly recommend that you add a channel-level timeout (expressed in
milliseconds). There are many situations where a network connection can
go wrong (i.e. an intermediate firewall may timeout an inactive socket
connection without notify the endpoint). If you know that your link has
to have traffic at least say every minute (i.e. because you&#8217;re sending
network management 800-class messages back and forth), we recommend that
you set a timeout for say 70 or 80 seconds.</p><p>You can increase that value, but making it very big will have a negative impact
in your application that will learn that a channel is not usable only by the
time it needs to send a real authorization message, causing a reconnection
at that time, instead of ahead of time, while it was idle.</p><p>Setting the keep-alive (<code class="literal">true/false</code>) would set the low level <code class="literal">SO_KEEPALIVE</code>
flag at the socket level for situations where no network management messages
are exchanged.</p><p>The <code class="literal">connection-timeout</code> property can be used to set a smaller timeout at
connect time, this is useful when combined with the <code class="literal">alternate-host</code> and
<code class="literal">alternate-port</code> set of properties.</p><pre class="screen">&lt;channel-adaptor name='your-channel' logger="Q2"&gt;
 &lt;channel class="org.jpos.iso.channel.NACChannel"
    ....
    ....
    &lt;property name="connection-timeout" value="15000" /&gt;  &lt;!-- 15 seconds --&gt;
    &lt;property name="timeout" value="300000" /&gt;            &lt;!-- five minutes --&gt;
    &lt;property name="keep-alive" value="true" /&gt;
    ....
    ....
 &lt;/channel&gt;
&lt;/channel-adaptor&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="one_shot_channel_adaptor"></a>8.2&nbsp;OneShotChannelAdaptor</h2></div></div></div><p>Most host-to-host ISO-8583 links use persistent connections, and that&#8217;s the
reason we have to multiplex the messages using a MUX, but for situations
where the host expects a single transaction per socket connection, we
have the <code class="literal">OneShotChannelAdaptor</code>.</p><p>The configuration and behavior is very similar to the <code class="literal">ChannelAdaptor</code> (see <a class="xref" href="#channel_adaptor" title="8.1&nbsp;ChannelAdaptor">Section&nbsp;8.1, &#8220;ChannelAdaptor&#8221;</a>),
you just need to change the class name in the qbean descriptor.</p><p>It supports the following attributes:</p><div class="table"><a name="d0e6794"></a><p class="title"><b>Table&nbsp;8.1.&nbsp;OneShotChannelAdaptor Attributes.</b></p><div class="table-contents"><table summary="OneShotChannelAdaptor Attributes." style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Attribute</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>in</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Input queue</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>out</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Output queue</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>space</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Optional space name, defaults to system&#8217;s default space</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>max-connections</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Maximum number of simultaneous connections to the remote host, defaults to 1</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>max-connect-attempts</p></td><td style="" align="left" valign="top"><p>Maximum number of connections attempts for a single transaction, defaults to 15</p></td></tr></tbody></table></div></div><br class="table-break"><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_qbean_descriptor_2"></a>8.2.1&nbsp;QBean descriptor</h3></div></div></div><pre class="screen">&lt;qbean name='your-channel' logger="Q2"&gt;
  class="org.jpos.q2.iso.OneShotChannelAdaptor"           <a name="CO12-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
 &lt;channel class="org.jpos.iso.channel.NACChannel"
       packager="org.jpos.iso.packager.GenericPackager"
       header="6000000000"&gt;
  &lt;property name="packager-config"
           value="jar:packager/iso87binary.xml" /&gt;
  &lt;property name="host" value="127.0.0.1" /&gt;
  &lt;property name="port" value="8001" /&gt;
  &lt;filter
      class="org.jpos.iso.filter.YourIncomingFilter"
      direction="incoming" /&gt;
  &lt;filter
      class="org.jpos.iso.filter.YourOutgoingFilter"
      direction="outgoing" /&gt;
 &lt;/channel&gt;
 &lt;in&gt;your-channel-send&lt;/in&gt;                               <a name="CO12-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
 &lt;out&gt;your-channel-receive&lt;/out&gt;                          <a name="CO12-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
 &lt;max-connections&gt;5&lt;/max-connections&gt;                     <a name="CO12-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
 &lt;max-connect-attempts&gt;3&lt;/max-connect-attempts&gt;           <a name="CO12-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
&lt;/qbean&gt;</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Please note we specify a class here.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Space queue used to receive messages to be transmitted to the
remote endpoint.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Messages received from the remote endpoint are placed in
this queue.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Overrides default max-connections (currently 1)</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO12-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>Overrides default max-connect-attempts (currently 15)</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>In addition to <code class="literal">org.jpos.q2.iso.OneShotChannelAdaptor</code> there&#8217;s
a new experimental <code class="literal">org.jpos.q2.iso.OneShotChannelAdaptorMK2</code> with
the same functionality and a new implementation.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="qmux"></a>8.3&nbsp;QMUX</h2></div></div></div><p><span class="strong"><strong>QMUX</strong></span> is a modern and very simple, yet powerful, Q2 service
that implements the
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/iso/MUX.html" target="_top">MUX</a>
interface as described in <a class="xref" href="#multiplexing_with_mux" title="2.2.6&nbsp;Multiplexing an ISOChannel with a MUX">Section&nbsp;2.2.6, &#8220;Multiplexing an ISOChannel with a MUX&#8221;</a>.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Users of the old <span class="strong"><strong>ISOMUX</strong></span>, which is still available in the
<code class="literal">compat_1_5_2</code> module are encouraged to upgrade to this new
service.</p></td></tr></table></div><p>QMUX uses the Space in order to communicate with the underlying channels; this
strategy brings into play a whole new set of deployment options, including the
ability to multiplex several channels for redundancy/load-balancing. These
channels doesn&#8217;t even have to run on the same machine. They could use
distributed/remote space implementations. The new space-based code doesn&#8217;t
require an extra thread, something very useful in systems where a large number
of MUXes are required.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_qbean_descriptor_3"></a>8.3.1&nbsp;QBean descriptor</h3></div></div></div><p>A QMUX configuration looks like this:</p><pre class="programlisting"><span class="hl-tag">&lt;mux</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QMUX"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mymux"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;in&gt;</span>your-channel-receive<span class="hl-tag">&lt;/in&gt;</span>                               <a name="CO13-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
 <span class="hl-tag">&lt;out&gt;</span>your-channel-send<span class="hl-tag">&lt;/out&gt;</span>                                <a name="CO13-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
 <span class="hl-tag">&lt;ready&gt;</span>your-channel.ready<span class="hl-tag">&lt;/ready&gt;</span>                           <a name="CO13-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
<span class="hl-tag">&lt;/mux&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>The MUX <code class="literal">&lt;in&gt;</code> queue has to be named after the ChannelAdaptor&#8217;s <code class="literal">&lt;out&gt;</code>
queue.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>In the same way, the MUX&#8217;s <code class="literal">&lt;out&gt;</code> queue needs to match the
ChannelAdaptor&#8217;s <code class="literal">&lt;in&gt;</code> queue.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO13-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>In order to provide a usable <code class="literal">MUX.isConnected()</code> method, the MUX needs to
have a way to know if the underlying channel, loosely connected through
the <code class="literal">in/out</code> queues is actually connected. The channel adaptor sets an
entry in the space named after the channel&#8217;s name with the extension
<code class="literal">.ready</code> as true when connected, so the optional <code class="literal">ready</code> element
has to match that name. If a <code class="literal">&lt;ready&gt;</code> element isn&#8217;t present,
<code class="literal">MUX.isConnected()</code> will always return true.</p></td></tr></table></div><p><span class="inlinemediaobject"><img src="images/qmux.png" alt="QMUX"></span></p><p>QMUX is registered in the NameRegistrar under the name provided in the qbean
configuration file using the <code class="literal">"mux."</code> prefix, ("mux.mymux" in our example)
so that other components can get a reference, cast it to MUX and use its:</p><p>In order to handle messages arriving to QMUX that do not match a response
QMUX is waiting for, we can attach one or more <code class="literal">ISORequestListeners</code>.</p><p>The XML configuration looks like this:</p><pre class="programlisting"><span class="hl-tag">&lt;mux</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QMUX"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mymux"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;in&gt;</span>your-channel-receive<span class="hl-tag">&lt;/in&gt;</span>
 <span class="hl-tag">&lt;out&gt;</span>your-channel-send<span class="hl-tag">&lt;/out&gt;</span>
 <span class="hl-tag">&lt;ready&gt;</span>your-channel.ready<span class="hl-tag">&lt;/ready&gt;</span>
 <span class="hl-tag">&lt;request-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"my.request.listener"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"myrealm"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myproperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"abc"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myotherproperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"xyz"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">file</span>=<span class="hl-value">"cfg/myprop.cfg"</span><span class="hl-tag"> /&gt;</span>
 <span class="hl-tag">&lt;/request-listener&gt;</span>
<span class="hl-tag">&lt;/mux&gt;</span></pre><p>As an alternative (or in addition to the request listeners), we can
define an <code class="literal">unhandled</code> queue. If messages arrive to QMUX and QMUX isn&#8217;t
waiting for it, it gets placed in the <code class="literal">unhandled</code> queue.</p><p>The configuration looks like this:</p><pre class="programlisting"><span class="hl-tag">&lt;mux</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QMUX"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mymux"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;in&gt;</span>your-channel-receive<span class="hl-tag">&lt;/in&gt;</span>
 <span class="hl-tag">&lt;out&gt;</span>your-channel-send<span class="hl-tag">&lt;/out&gt;</span>
 <span class="hl-tag">&lt;ready&gt;</span>your-channel.ready<span class="hl-tag">&lt;/ready&gt;</span>
 <span class="hl-tag">&lt;unhandled&gt;</span>myunhandledqueue<span class="hl-tag">&lt;/unhandled&gt;</span>
<span class="hl-tag">&lt;/mux&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>In order for this mechanism to work, a separate jPOS service
should be waiting for messages arriving to the <code class="literal">unhandled</code> queue.</p><p>In order to prevent a situation where a QMUX is configured to push
messages to an <code class="literal">unhandled</code> queue and no service is listening to
those messages, a 120 seconds timeout is used. So messages will
be present for just 120 seconds. This little protection is intended
to avoid out of memory issues.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mti_mapping_and_default_key"></a>8.3.2&nbsp;MTI mapping and default key</h3></div></div></div><p>QMUX use the MTI as well as fields <span class="emphasis"><em>41</em></span> and <span class="emphasis"><em>11</em></span> as its default key.</p><p>That default can be changed using the <code class="literal"><span class="emphasis"><em>&lt;key&gt;&#8230;&#8203;&lt;/key&gt;</em></span></code> elements in
the QMUX configuration, i.e.:</p><pre class="programlisting"><span class="hl-tag">&lt;mux</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QMUX"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mymux"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;key&gt;</span>42 41 11<span class="hl-tag">&lt;/key&gt;</span>                                             <a name="CO14-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
 <span class="hl-tag">&lt;key</span> <span class="hl-attribute">mti</span>=<span class="hl-value">"0800"</span><span class="hl-tag">&gt;</span>41<span class="hl-tag">&lt;/key&gt;</span>                                        <a name="CO14-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
 <span class="hl-tag">&lt;in&gt;</span>your-channel-receive<span class="hl-tag">&lt;/in&gt;</span>
 <span class="hl-tag">&lt;out&gt;</span>your-channel-send<span class="hl-tag">&lt;/out&gt;</span>
 <span class="hl-tag">&lt;ready&gt;</span>your-channel.ready<span class="hl-tag">&lt;/ready&gt;</span>
 <span class="hl-tag">&lt;unhandled&gt;</span>myunhandledqueue<span class="hl-tag">&lt;/unhandled&gt;</span>
<span class="hl-tag">&lt;/mux&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>overrides default key.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO14-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>overrides default key for 0800 messages.</p></td></tr></table></div><p>In addition to the fields defined in the <code class="literal"><span class="emphasis"><em>&lt;key&gt;</em></span></code> element, QMUX maps each
digit of the MTI to use as a key part in order to avoid mixing for instance
a response for a 100-class message such as a <code class="literal">0100</code> with a reversal
response. The reason for this additional mapping is because most reversals
share the same STAN (field 11) with the original authorization.</p><p>Each of the three digits of the MTI gets mapped using the following
default values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">0123456789</code></li><li class="listitem"><code class="literal">0123456789</code></li><li class="listitem"><code class="literal">0022446789</code></li></ul></div><p>The value <code class="literal">0123456789</code> means no special handling is required, a
value of <span class="emphasis"><em>0</em></span> in the first position of the MTI i.e. the first <span class="emphasis"><em>0</em></span>
in a <span class="emphasis"><em>0100</em></span> message) will expect a <span class="emphasis"><em>0</em></span> in that very same position
in the response. The first position represents the ISO-8583 version
number (see <a class="xref" href="#iso8583" title="2.1&nbsp;An ISO-8583 primer">Section&nbsp;2.1, &#8220;An ISO-8583 primer&#8221;</a>), so if we send a 1987 message, we expect
a 1987 response.</p><p>Same goes for the second position, if we send a <span class="emphasis"><em>0100</em></span> we expect a <span class="emphasis"><em>0110</em></span>,
and that&#8217;s what the <span class="emphasis"><em><code class="literal">0123456789</code></em></span> mapping does, it actually takes no
action.</p><p>For the third position, we use the default value <code class="literal">0022446789</code>.
That means that a <span class="emphasis"><em>1</em></span> in the third position (i.e. a <span class="emphasis"><em>0110</em></span>) will
be considered a <span class="emphasis"><em>0</em></span> when creating the MTI key part, so that a
<span class="emphasis"><em>0110</em></span> response will match the original <span class="emphasis"><em>0100</em></span>.</p><p>These mappings can be changed using the <code class="literal"><span class="emphasis"><em>&lt;mtimapping&gt;</em></span></code> element
in the QMUX configuration. The default values would be represented
as:</p><pre class="programlisting"><span class="hl-tag">&lt;mux</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QMUX"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mymux"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;mtimapping&gt;</span>0123456789 0123456789 0022446789<span class="hl-tag">&lt;/mtimapping&gt;</span>
 ...
 ...
<span class="hl-tag">&lt;/mux&gt;</span></pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="qserver"></a>8.4&nbsp;QServer</h2></div></div></div><p><span class="strong"><strong>QServer</strong></span> is an adapter around <code class="literal">ISOServer</code> (see <a class="xref" href="#isoserver" title="2.2.5&nbsp;Accepting connections with ISOServer">Section&nbsp;2.2.5, &#8220;Accepting connections with ISOServer&#8221;</a>) that
interacts with other Q2 components, such as QMUX, using the Space
by defining <code class="literal">in</code> and <code class="literal">out</code> queues, pretty much like the <code class="literal">ChannelAdaptor</code>
does.</p><p>Despite the fact that QServer will act as a server from a TCP/IP
standpoint, and it will listen to a configurable port, it can
still be used to initiate transactions to the remote endpoint.</p><p>When acting as a server (from a transaction standpoint), the
QServer is typically configured to forward transactions to
a set of request listeners, but that&#8217;s not mandatory. It is
possible to use <code class="literal">in/out</code> Space based queues and <span class="strong"><strong>connect</strong></span>
QServer to other components, such as QMUX (see <a class="xref" href="#qmux" title="8.3&nbsp;QMUX">Section&nbsp;8.3, &#8220;QMUX&#8221;</a>).</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_qbean_descriptor_4"></a>8.4.1&nbsp;QBean descriptor</h3></div></div></div><p>A QServer configuration looks like this:</p><pre class="programlisting"><span class="hl-tag">&lt;qserver</span> <span class="hl-attribute">name</span>=<span class="hl-value">"xml-server"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>                      <a name="CO15-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">&gt;</span>8000<span class="hl-tag">&lt;/attr&gt;</span>     <a name="CO15-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
  <span class="hl-tag">&lt;channel</span> <span class="hl-attribute">name</span>=<span class="hl-value">"xml.channel"</span>
           <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.channel.XMLChannel"</span>
           <span class="hl-attribute">packager</span>=<span class="hl-value">"org.jpos.iso.packager.XMLPackager"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;/channel&gt;</span>
  <span class="hl-tag">&lt;request-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"my.request.Listener"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"my-property"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"ABC"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"my-other-property"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"XYZ"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/request-listener&gt;</span>
<span class="hl-tag">&lt;/qserver&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p><code class="literal">qserver</code> is defined in <code class="literal">QFactory.properties</code> and defaults
to class <code class="literal">org.jpos.q2.iso.QServer</code></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO15-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p><code class="literal">port</code> is a JMX attribute honored by <code class="literal">QServer</code>. Other configuration
options are pulled using a <code class="literal">Configuration</code> object.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">qserver</code> element has been recently added to QFactory (&gt;1.9.7);
when running older versions, the QBean descriptor has to include
the <code class="literal">class="org.jpos.q2.iso.QServer"</code> attribute.</p></td></tr></table></div><p>QServer is registered in the <code class="literal">NameRegistrar</code> under the name provided in
the qbean descriptor (<span class="strong"><strong>"xml-server"</strong></span> in the previous example). In addition,
the underlying <code class="literal">ISOServer</code>&#8201;&#8212;&#8201;instantiated by <code class="literal">QServer</code>&#8201;&#8212;&#8201;will register itself
with the <code class="literal">NameRegistrar</code> using a prefix <code class="literal">"server."</code>, so in the previous
example, <code class="literal">xml-server</code> will be a reference to the <code class="literal">QServer</code> object,
and <code class="literal">server.xml-server</code> will have a reference to the <code class="literal">ISOServer</code> object.</p><p>The Channel definition used by <code class="literal">QServer</code> is the same as the one
used by the <code class="literal">ChannelAdaptor</code>, where you can configure SSL support,
packager-level logging, etc. Please read <a class="xref" href="#channel_adaptor" title="8.1&nbsp;ChannelAdaptor">Section&nbsp;8.1, &#8220;ChannelAdaptor&#8221;</a> for
details.</p><p>The request listeners are the same as those used by <code class="literal">QMUX</code>
(see <a class="xref" href="#qmux" title="8.3&nbsp;QMUX">Section&nbsp;8.3, &#8220;QMUX&#8221;</a> for details). A <code class="literal">QServer</code> using a request
listener would look like this:</p><pre class="programlisting"><span class="hl-tag">&lt;server</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jcard-server"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.q2.iso.QServer"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">&gt;</span>8001<span class="hl-tag">&lt;/attr&gt;</span>
  <span class="hl-tag">&lt;channel</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jcard.channel"</span>
           <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.channel.CSChannel"</span>
           <span class="hl-attribute">packager</span>=<span class="hl-value">"org.jpos.iso.packager.GenericPackager"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"packager-config"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"cfg/jcard.xml"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"300000"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/channel&gt;</span>
  <span class="hl-tag">&lt;request-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.jcard.Dispatcher"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span>
                    <span class="hl-attribute">realm</span>=<span class="hl-value">"incoming-request-listener"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span>  <span class="hl-attribute">value</span>=<span class="hl-value">"org.jpos.jcard.Incoming_"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60000"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"space"</span>   <span class="hl-attribute">value</span>=<span class="hl-value">"tspace:default"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span>   <span class="hl-attribute">value</span>=<span class="hl-value">"JCARD.TXN"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"station"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"JCARD"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/request-listener&gt;</span>
<span class="hl-tag">&lt;/server&gt;</span></pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can of course define multiple request listeners, but we typically
have just one that pushes the messages to the TransactionManager where
the business logic can be implemented.</p></td></tr></table></div><p>In situations where the system needs to initiate transactions to the
remote host, <code class="literal">in</code> and <code class="literal">out</code> queues can be configured like in
the <code class="literal">ChannelAdaptor</code>. These names (<code class="literal">in/out</code>) are seen from <code class="literal">QServer&#8217;s</code>
perspective. Because a QServer can accept multiple simultaneous connections in
different sockets, an outgoing message needs to select which socket to use. When using
this <code class="literal">in/out</code> communication queues, QServer selects the latest
socket (using the <code class="literal">ISOServer.getLastConnectedISOChannel())</code> method. It is also possible to use
<code class="literal">send-request</code> property to send messages to all connected clients in round-robin fashion.
(see <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/q2/iso/QServer.html" target="_top">QServer</a>).</p><p>The configuration looks like this:</p><pre class="programlisting"><span class="hl-tag">&lt;qserver</span> <span class="hl-attribute">name</span>=<span class="hl-value">"jcard-server"</span>  <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">&gt;</span>8001<span class="hl-tag">&lt;/attr&gt;</span>
  ...
  ...
  <span class="hl-tag">&lt;in&gt;</span>your-server-receive<span class="hl-tag">&lt;/in&gt;</span>
  <span class="hl-tag">&lt;out&gt;</span>your-server-send<span class="hl-tag">&lt;/out&gt;</span>
  <span class="hl-tag">&lt;ready&gt;</span>your-server.ready<span class="hl-tag">&lt;/ready&gt;</span>
  <span class="hl-comment">&lt;!--&lt;send-request&gt;LAST&lt;/send-request&gt;--&gt;</span> <span class="hl-comment">&lt;!--default last connected --&gt;</span>
  <span class="hl-tag">&lt;send-request&gt;</span>RR<span class="hl-tag">&lt;/send-request&gt;</span> <span class="hl-comment">&lt;!-- round-robin --&gt;</span>
<span class="hl-tag">&lt;/qserver&gt;</span></pre><p><code class="literal">QServer</code> can accept multiple simultaneous sockets (default 100) that
can be configured using the JMX attributes <code class="literal">minSessions</code> and <code class="literal">maxSessions</code>,
i.e:</p><pre class="programlisting">  <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"minSessions"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">&gt;</span>10<span class="hl-tag">&lt;/attr&gt;</span>
  <span class="hl-tag">&lt;attr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxSessions"</span> <span class="hl-attribute">type</span>=<span class="hl-value">"java.lang.Integer"</span><span class="hl-tag">&gt;</span>250<span class="hl-tag">&lt;/attr&gt;</span></pre><p>In addition, it can check the client&#8217;s IP address against <span class="strong"><strong>"allow"</strong></span>
and <span class="strong"><strong>"deny"</strong></span> IP addresses (including suffix wildcards) and drop the
connection if it&#8217;s not one of the allowed IP addresses. Here&#8217;s an example:</p><pre class="programlisting">  ...
  ...
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"allow"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"192.168.1.1"</span><span class="hl-tag"> /&gt;</span> <a name="CO16-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"allow"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"192.168.1.2"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"allow"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"10.0.0.10"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"deny"</span>  <span class="hl-attribute">value</span>=<span class="hl-value">"10.0.*"</span><span class="hl-tag"> /&gt;</span>      <a name="CO16-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
  ...
  ...</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>The first three IPs are <span class="emphasis"><em>explicitly allowed</em></span>, even though the third one&#8230;&#8203;</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO16-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>&#8230;&#8203;belongs to an IP range that is denied.</p></td></tr></table></div><p>Some considerations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Explicit IPs (i.e., those without wildcards) will be checked and honored first.
Then, the wildcard expressions will be checked, starting with the wildcard <code class="literal">"deny"</code> set,
and following with the wildcard <code class="literal">"allow"</code> set.</li><li class="listitem">If only <code class="literal">"allow"</code> expressions are used, the default policy will be to <span class="emphasis"><em>deny unmatching</em></span> IPs.</li><li class="listitem">If only <code class="literal">"deny"</code> expressions are used, the default policy will be to <span class="emphasis"><em>allow unmatching</em></span> IPs.</li><li class="listitem">For <span class="emphasis"><em>mixed</em></span> permissions (both, <code class="literal">"allow"</code> and <code class="literal">"deny"</code> present), the default policy will be to
<span class="emphasis"><em>deny unmatching</em></span> IPs.</li><li class="listitem">Use caution when using mixed permissions and wildcards. Due to the order of evaluation and
default policies, some combinations may, at best, be redundant or unnecessary. At worst, they may
make no sense at all (even denying connections from valid IPs).</li></ul></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png"></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>The IP validation via the <code class="literal">allow</code> and <code class="literal">deny</code> set of properties,
while very handy, should not to be used as a replacement
for proper firewall rules.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="logger-adaptor"></a>8.5&nbsp;LoggerAdaptor</h2></div></div></div><p>This service provides an easy way of declaring a logger (see <a class="xref" href="#logger" title="3.1&nbsp;jPOS' Logger">Section&nbsp;3.1, &#8220;jPOS' Logger&#8221;</a>) for the application. It creates a <code class="literal">Logger</code> instance and regiters it in <code class="literal">NameRegistrar,</code> so it can be referenced from other deploy descriptors or code.</p><p>As mentioned in <a class="xref" href="#running_Q2" title="7.1&nbsp;Running Q2">Section&nbsp;7.1, &#8220;Running Q2&#8221;</a>, a default logger is created if no <code class="literal">00_logger.xml</code> is present. That is the simplest logger definition, with the exception of one that has no log listener at all.</p><p>Let&#8217;s revisit it:</p><pre class="programlisting"><span class="hl-tag">&lt;logger</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span> <a name="CO17-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.SimpleLogListener"</span><span class="hl-tag"> /&gt;</span> <a name="CO17-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
<span class="hl-tag">&lt;/logger&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>In absence of a <code class="literal">class</code> attributes <code class="literal">Q2</code> maps <code class="literal">logger</code> root elements to <code class="literal">org.jpos.q2.qbean.LoggerAdaptor</code>, <code class="literal">QFactory</code> takes the mapping from the resource <a class="link" href="https://github.com/jpos/jPOS/blob/master/jpos/src/main/resources/org/jpos/q2/QFactory.properties#L1" target="_top"><code class="literal">QFactory.properties</code></a></p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO17-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>This is the simplest <code class="literal">LogListener</code> definition you can see, it just dumps all events to <code class="literal">System.out</code>, more details in the next subsection.</p></td></tr></table></div><p>The following subsections mention some log listeners included in the jPOS distribution. They just describe the items that can be configured by deploy descriptors, but some of them have additional capabilities that can be configured programmatically. Or less commonly used properties that can be read from the source code or javadoc.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_simpleloglistener"></a>8.5.1&nbsp;SimpleLogListener</h3></div></div></div><p>This log listener dumps all events to standard output.</p><p>It can have an inner <code class="literal">writer</code> element that can modify how the elements are written to the output stream. See <a class="link" href="https://github.com/jpos/jPOS/blob/master/jpos/src/main/java/org/jpos/util/MappingLogEventWriter.java#L42" target="_top"><code class="literal">MappingLogEventWriter.java</code></a> for an example.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_rotateloglistener"></a>8.5.2&nbsp;RotateLogListener</h3></div></div></div><p>This log listener writes output to a rotating file. It extends <code class="literal">SimpleLogListener</code>, so it inherits its configuration capabilities plus the ones needed to configure its specific purpose.</p><p>Its configuration looks like this:</p><pre class="programlisting">  <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.RotateLogListener"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"file"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"log/q2.log"</span><span class="hl-tag"> /&gt;</span>     <a name="CO18-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"window"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"86400"</span><span class="hl-tag"> /&gt;</span>        <a name="CO18-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"copies"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"90"</span><span class="hl-tag"> /&gt;</span>           <a name="CO18-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxsize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"100000000"</span><span class="hl-tag"> /&gt;</span>   <a name="CO18-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;proeprty</span> <span class="hl-attribute">name</span>=<span class="hl-value">"rotate-on-startup"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"false"</span><span class="hl-tag">/&gt;</span> <a name="CO18-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
  <span class="hl-tag">&lt;/log-listener&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>The location base path, where it will write the output.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>How often to rotate in seconds, defaults to <code class="literal">0</code> which has a special meaning of never to rotate by time.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>How many copies to maintain, defaults to <code class="literal">0</code> which has a special meaning of maintaining a single copy.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Maximum size in bytes it lets the log file to grow. If the log file becomes greater than that, it automatically rotates it.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO18-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>Automatically rotate on start up?, defaults to false.</p></td></tr></table></div><p>The rotation procedure goes by renaming each copy by increasing its suffix, and <code class="literal">.1</code> is appended to the base file, the one given by the <code class="literal">file</code> property. When one copy reaches the <code class="literal">maxsize</code> limit it is eliminated.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">RotateLogListener</code> tracks the window, it is not based in the file modification timestamp, so if the application restarts, the time rests and the rotation procedure does not happen until the window time passes since then. Unless of course <code class="literal">rotate-on-startup</code> is set to <code class="literal">true</code> and in that case it rotates immediately.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_dailyloglistener"></a>8.5.3&nbsp;DailyLogListener</h3></div></div></div><p>Rotates the log files daily or ata a given rudimentary schedule, with the ability of compressing old logs. It also extends <code class="literal">RotateLogListener</code>, so it shares some of its properties, and some other have slightly different meaning.</p><p>As usual, we illustrate the usage by example. For properties commented as optional, the example shows its default values.</p><pre class="programlisting">  <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.DailyLogListener"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"window"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"86400"</span><span class="hl-tag"> /&gt;</span>                <span class="hl-comment">&lt;!-- optional, defaults to one day --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"log/q2"</span><span class="hl-tag"> /&gt;</span>               <span class="hl-comment">&lt;!-- mandatory --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".log"</span><span class="hl-tag">/&gt;</span>                  <span class="hl-comment">&lt;!-- optional --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"date-format"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"-yyyy-MM-dd-HH"</span><span class="hl-tag">/&gt;</span>   <span class="hl-comment">&lt;!-- optional --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"compression-format"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"gzip"</span><span class="hl-tag">/&gt;</span>      <span class="hl-comment">&lt;!-- optional --&gt;</span> <a name="CO19-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"compressed-suffix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".gz"</span><span class="hl-tag">/&gt;</span>        <span class="hl-comment">&lt;!-- optional --&gt;</span> <a name="CO19-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxsize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"-1"</span><span class="hl-tag">/&gt;</span>                   <span class="hl-comment">&lt;!-- optional --&gt;</span> <a name="CO19-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"compression-buffer-size"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"131072"</span><span class="hl-tag">/&gt;</span>   <span class="hl-comment">&lt;!--optional --&gt;</span> <a name="CO19-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"first-rotate-time"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"00:00:00"</span><span class="hl-tag">/&gt;</span>   <span class="hl-comment">&lt;!-- optional --&gt;</span> <a name="CO19-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"first-rotate-date"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"current date"</span><span class="hl-tag">/&gt;</span>      <span class="hl-comment">&lt;!-- optional --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxage"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0"</span><span class="hl-tag">/&gt;</span>                     <span class="hl-comment">&lt;!-- optional --&gt;</span> <a name="CO19-6"></a><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"delete-regex"</span> <span class="hl-attribute">value</span>=<span class="hl-value">".."</span><span class="hl-tag">/&gt;</span>              <span class="hl-comment">&lt;!-- optional --&gt;</span> <a name="CO19-7"></a><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span>
  <span class="hl-tag">&lt;/log-listener&gt;</span>
<span class="hl-tag">&lt;/logger&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Valid values: <code class="literal">gzip</code>, <code class="literal">zip</code> and none.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Defaults to <code class="literal">.zip</code> for zip, <code class="literal">.gz</code> for gzip, and nothing for no compression.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Almost equals to <code class="literal">RotateLogListener</code>, except for <code class="literal">0</code> (the default) or negative values mean no limit. If the size exceeds this value the file is compressed, and
successive copies will have ".(count)" appended before the suffix.
Unlike <code class="literal">RotateLogListener</code> older copies have lower numbers.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Low level parameter, which determines the size of the
buffer used to read from the uncompressed file, defaults to
128*1024 = 128 KB. Use bigger values in machines with a lot of
memory and if the application produces big log files in the given window.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p><code class="literal">first-rotate-time</code> and <code class="literal">first-rotate-date</code> determines the first rotation,
successive rotations will take place when determined by this two
parameters plus multiples of window, the defaults are 00:00:00 and today
and the formats are HH:mm:ss and yyyy-MM-dd respectively. The later only makes sense if you want to rotate on a period greater (and multiple of) a day, like weekly or monthly.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-6"><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left"><p>Max age of log files, the log listener deletes files older than this property in seconds. It calculates the age from file attributes in the file system and deletes all that match a delete regular expression.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO19-7"><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left"><p>Regular expression that files need to match to be deleted by age. The default is the concatenation of:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">^</code>, match from the start</li><li class="listitem">The filename part of the prefix, <code class="literal">q2</code> in the example.</li><li class="listitem"><code class="literal">.+</code> one or more characters.</li><li class="listitem">suffix, in the example <code class="literal">.log</code></li><li class="listitem">compressed suffix</li><li class="listitem"><p class="simpara"><code class="literal">$</code> must end with the suffix.</p><p class="simpara">It only deletes files in the same directory as the base log file.</p></li></ul></div></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="ProtectedLogListener"></a>8.5.4&nbsp;ProtectedLogListener</h3></div></div></div><p>A filter log listener that protects the content of sensitive data, it does not actually log anything to a file o stream but just modify the log events, for the next log listener in line.</p><p>Since it doesn&#8217;t make sense to be used on its own, in the example we show how it is meant to be used in combination with output log listeners. Properties not set, default to empty string, i.e. empty set of fields. Subelements can be protected as well by passing them in the path form, e.g. <code class="literal">49.2</code></p><pre class="programlisting"><span class="hl-tag">&lt;logger</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.SimpleLogListener"</span><span class="hl-tag">/&gt;</span>       <a name="CO20-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
  <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.ProtectedLogListener"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"protect"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2 35 45 49.2 55"</span><span class="hl-tag"> /&gt;</span>         <a name="CO20-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"wipe"</span>    <span class="hl-attribute">value</span>=<span class="hl-value">"48"</span><span class="hl-tag"> /&gt;</span>                      <a name="CO20-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
  <span class="hl-tag">&lt;/log-listener&gt;</span>
  <span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.RotateLogListener"</span><span class="hl-tag">&gt;</span>        <a name="CO20-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"file"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"log/q2.log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"window"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"86400"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"copies"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxsize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"1000000"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;/log-listener&gt;</span>
<span class="hl-tag">&lt;/logger&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Standard output isn&#8217;t protected because it is placed before the <code class="literal">ProtectedLogListener</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Fields to protect, separated by spaces, its sensitive parts are repleced by underscores (<code class="literal">_</code>), <a class="link" href="https://github.com/jpos/jPOS/blob/master/jpos/src/main/java/org/jpos/iso/ISOUtil.java#L903" target="_top"><code class="literal">ISOUtil.protect()</code></a> determines which positions need to be replaced, for example:
<code class="literal">"40000101010001"</code> is converted to <code class="literal">"400001____0001"</code>.
<code class="literal">"40000101010001=020128375"</code> is converted to <code class="literal">"400001____0001=0201_____"</code>.
<code class="literal">"40000101010001D020128375" is converted to "400001____0001D0201_____"</code>.
<code class="literal">"123"</code> is converted to <code class="literal">"___"</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Fields to wipe out, they are just replaced by constants, <code class="literal">[WIPE]</code> replaces a string field, and bytes <code class="literal">AA55AA55</code> (hex representation) replaces any other kind of field, including composite fields but designed to replace binary ones.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO20-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Files written by the <code class="literal">RotateLogListener</code> will have all given fields protected, since it is after the <code class="literal">ProtectedLogListener</code>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_fsdprotectedloglistener"></a>8.5.5&nbsp;FSDProtectedLogListener</h3></div></div></div><p>This log listener performs the same task as <code class="literal">ProtectedLogListener</code> but for <code class="literal">FSDMsg</code> and <code class="literal">FSDISOMsg</code> instances. And since its usage is the same, we just focus on its configuration part.</p><p>In this case the fields reference <code class="literal">FSDMsg</code> fields, and for <code class="literal">FSDISOMsg</code> instances its inner <code class="literal">FSDMsg</code> fields.</p><pre class="programlisting"><span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.FSDProtectedLogListener"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"protect"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2 35 pan track2"</span><span class="hl-tag"> /&gt;</span>             <a name="CO21-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"wipe"</span>    <span class="hl-attribute">value</span>=<span class="hl-value">"pin 52"</span><span class="hl-tag"> /&gt;</span>                      <a name="CO21-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"truncate"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"field1:100 field2:50"</span><span class="hl-tag"> /&gt;</span>       <a name="CO21-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
<span class="hl-tag">&lt;/log-listener&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Fields to protect, see <a class="xref" href="#ProtectedLogListener" title="8.5.4&nbsp;ProtectedLogListener">Section&nbsp;8.5.4, &#8220;ProtectedLogListener&#8221;</a> for more details.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Fields to wipe out.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>In addition, this log listener also can truncate fields, this property specifies the fields and the lengths to which the log listener will truncate them separated by a colon.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_sysloglistener"></a>8.5.6&nbsp;SysLogListener</h3></div></div></div><p>The <code class="literal">SysLoglistener</code> sends the events to the system log concentrator (aka syslog), see <a class="link" href="https://www.ietf.org/rfc/rfc3164.txt" target="_top">https://www.ietf.org/rfc/rfc3164.txt</a>.</p><pre class="programlisting"><span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.SysLogListener"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"facility"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"16"</span><span class="hl-tag"> /&gt;</span>         <a name="CO22-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"severity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"6"</span><span class="hl-tag"> /&gt;</span>          <a name="CO22-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"host"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"localhost"</span><span class="hl-tag">/&gt;</span>       <a name="CO22-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"port"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"514"</span><span class="hl-tag">/&gt;</span>             <a name="CO22-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"tags"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"audit, syslog"</span><span class="hl-tag"> /&gt;</span>  <a name="CO22-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"prefix"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"[jPOS]"</span><span class="hl-tag"> /&gt;</span>       <a name="CO22-6"></a><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"syslog.facility"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"21"</span><span class="hl-tag"> /&gt;</span>  <a name="CO22-7"></a><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"syslog.severity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"audit.facility"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"21"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"audit.severity"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"4"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/log-listener&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Default facility, used if it is not defined for a tag. Optional, defaults to <code class="literal">16</code>, local use 0.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Default severity, used if it is not defined for a tag. Optional, defaults to <code class="literal">6</code>, Informational.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Host to send the log events to. Optional, defaults to <code class="literal">localhost</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Port to connect to send the log events on the host. Optional, defaults to 514.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>The log listener will only send the log events with its tags listed here. Optional, defaults to <code class="literal">"audit, syslog"</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-6"><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left"><p>An optional prefix to prepend to the message to be sent, if not defined, nothing is prepended.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO22-7"><span><img src="images/icons/callouts/7.png" alt="7" border="0"></span></a> </p></td><td valign="top" align="left"><p>Each tag can be mapped to a different facility and severity.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_realmlogfilter"></a>8.5.7&nbsp;RealmLogFilter</h3></div></div></div><p>Filters LogEvents by their realm.</p><p>RealmLogFilter is a filter for log events, as with the protected log listeners it should be defined <span class="emphasis"><em>before</em></span> other standard LogListeners such as SimpleLogListener or RotateLogListener that write the output to the place we want to avoid logging filtered events.</p><pre class="programlisting"><span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.RealmLogFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"dump-interval"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"60000"</span><span class="hl-tag">/&gt;</span>      <a name="CO23-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
    <span class="hl-tag">&lt;enabled&gt;</span>                                           <a name="CO23-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
        Q2.system
        my-realm
    <span class="hl-tag">&lt;/enabled&gt;</span>
<span class="hl-tag">&lt;/log-listener&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Those realms that had events but were filtered will be saved. These are logged at an  interval defined by the <code class="literal">dump-interval</code> property in a tag. Once logged, these filtered realms are reset. This property is optional and it defautls to <code class="literal">0</code> which means never to log missed realms.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO23-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>If <code class="literal">enabled</code> tag is present, then the log listener will filter all realms not defined there. If this tag is present the <code class="literal">disabled</code> tag is ignroed. In this example only log events with realms <code class="literal">Q2.system</code> or <code class="literal">my-realm</code> are going to be passed on to the next log listener.</p></td></tr></table></div><pre class="programlisting"><span class="hl-tag">&lt;log-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.util.RealmLogFilter"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;disabled&gt;</span>                                          <a name="CO24-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
        filtered-realm-1
        filtered-realm-2
    <span class="hl-tag">&lt;/disabled&gt;</span>
<span class="hl-tag">&lt;/log-listener&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO24-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>If <code class="literal">enabled</code> tag is not present and <code class="literal">disabled</code> tag is, then only events with realms matching one of the defined here are filtered out, and all the other are passed to the next log listener. In this example it would not pass log events with realm <code class="literal">filtered-realm-1</code> or <code class="literal">fitlered-realm-2</code> to the next log listener.</p></td></tr></table></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_transactionmanager"></a>9.&nbsp;TransactionManager</h1></div></div></div><p>The TransactionManager (also called <span class="emphasis"><em>TM</em></span> in this document) is just another Q2
Service, but it is such an important component in most jPOS based applications
that it stands out, deserving its own chapter.</p><p>jPOS is typically used to implement mission-critical applications that
have to carefully deal with error conditions.</p><p>When you access a web page and a transient network error occurs,
you just hit the <span class="strong"><strong>reload</strong></span> button on your browser. By contrast, a complex
financial transaction involves a lot of activities such as contacting remote
hosts, notifying risk management systems, placing holds in cardholder&#8217;s credit
accounts, database logging, etc.</p><p>So, if something goes wrong or your system just dies due to a power failure,
it&#8217;s more complicated than simply hitting the <span class="strong"><strong>reload</strong></span> button: you have to reverse
the impact of whatever actions had been taken up to the failure point.</p><p>The <code class="literal">org.jpos.transaction</code> package - along with the Q2-based <span class="strong"><strong>TransactionManager</strong></span>
implementation - provides a framework and set of components that can assist dealing
with the previous scenario. This combination also fosters code reuse and
<span class="emphasis"><em>componentization</em></span>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This doesn&#8217;t mean a jPOS based application needs to use the TransactionManager.
It&#8217;s proven, it&#8217;s fast, it&#8217;s reliable, we are aware of use cases where the TM is used to
process millions of transactions per day, we @jposconsulting use it in most of
our applications, but it&#8217;s up to you to use it or not.</p></td></tr></table></div><p>The key class is the
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/TransactionParticipant.html" target="_top">TransactionParticipant</a>
that exposes the following interface:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionParticipant <span class="hl-keyword">extends</span> TransactionConstants {
        <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>  prepare (<span class="hl-keyword">long</span> id, Serializable context);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> commit  (<span class="hl-keyword">long</span> id, Serializable context);
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> abort   (<span class="hl-keyword">long</span> id, Serializable context);
    }


   <span class="hl-comment">// the TransactionConstants interface provides the following definitions:</span>

    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionConstants {
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> ABORTED  = <span class="hl-number">0</span>;
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> PREPARED = <span class="hl-number">1</span>;
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> RETRY    = <span class="hl-number">2</span>;
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> PAUSE    = <span class="hl-number">4</span>;
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> NO_JOIN  = <span class="hl-number">0x40</span>;
        <span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> READONLY = <span class="hl-number">0x80</span>;
    }</pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>As of jPOS 2.1.0 the <code class="literal">commit</code> and <code class="literal">abort</code> methods have default
implementations so they don&#8217;t have to be called in situations
where <code class="literal">prepare</code> returns the <code class="literal">NO_JOIN</code> modifier.</p></td></tr></table></div><p>The TransactionManager implementation <span class="emphasis"><em>drives</em></span> the transaction by calling all of its
participants' <code class="literal">prepare</code> method. If all of them return <code class="literal">PREPARED</code> (indicating that
they are ready to proceed with the transaction), then the transaction moves
to the <span class="emphasis"><em>COMMITTING</em></span> phase, at which point the TransactionManager will call all of the
participants' <code class="literal">commit</code> method.</p><p>If one of the participants' <code class="literal">prepare</code> method returns <code class="literal">ABORTED</code>, then the transaction
moves into an <span class="emphasis"><em>ABORTING</em></span> phase, and all the participants previously called to get
prepared will get a call to their <code class="literal">abort</code> method.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_transactionconstants"></a>9.1&nbsp;TransactionConstants</h2></div></div></div><div class="table"><a name="d0e7961"></a><p class="title"><b>Table&nbsp;9.1.&nbsp;TransactionConstants</b></p><div class="table-contents"><table summary="TransactionConstants" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Value</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ABORTED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The participant is not prepared. Transaction should be aborted.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PREPARED</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>1</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The participant is prepared to commit the transaction, provided
  all other participants down the list return PREPARED too.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>RETRY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>2</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The transaction will be retried after a short period of time
  defined by the <code class="literal">retry-timeout</code> TransactionManager
  property (which defaults to 5 seconds).
  This can be used in situations where a transient error has been
  detected (such as a link down situation or a transient database issue).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PAUSE</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>4</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The transaction will be paused and will be resumed
in the following situations:</p>
<p>a) Some external thread calls <code class="literal">resume</code> in the transaction&#8217;s Context
  (provided the Context implements the <code class="literal">Pausable</code> interface)</p>
<p>b) A timeout specified by the Context&#8217;s Pausable interface occurs</p>
<p>c) A default timeout specified by the TransactionManager&#8217;s <code class="literal">pause-timeout</code> property
  (which defaults to five minutes)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>NO_JOIN</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0x40</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This modifier is a hint to the TransactionManager to let it know
  that it is not required to call this participant&#8217;s
  <code class="literal">commit</code> or <code class="literal">abort</code> methods once the committing or aborting
  phase of the transaction is reached.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>READONLY</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>0x80</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>This modifier is a hint to the TransactionManager to let it know
  that this participant has not modified any persistent information
  in the context, so saving a snapshot of the context is not required.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>FAIL</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>0xC0</p></td><td style="" align="left" valign="top"><p>Handy constant equals to <code class="literal">ABORTED | READONLY | NO_JOIN</code></p></td></tr></tbody></table></div></div><br class="table-break"><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Despite the fact that a participant may indicate that it doesn&#8217;t want to
JOIN a given transaction (by using the <code class="literal">NO_JOIN</code> run-time modifier),
under certain recovery situations the TransactionManager
may still call its <code class="literal">commit</code> or <code class="literal">abort</code> method, so the participant developer
should be prepared to receive a <code class="literal">commit</code> or <code class="literal">abort</code> call for an
unknown transaction. The code should check the <code class="literal">long id</code>
and / or <code class="literal">Serializable context</code> in order to figure out what to do. That
said, most participants returning <code class="literal">NO_JOIN</code> actually have empty <code class="literal">commit()</code>
and <code class="literal">abort()</code> callbacks.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_transaction_context"></a>9.2&nbsp;Transaction Context</h2></div></div></div><p>The only constraint imposed on a Context implementation is that it has
to implement the <code class="literal">java.io.Serializable</code> interface. That&#8217;s
because the TransactionManager has to write <code class="literal">snapshots</code>
of it at different check points.</p><p>You can use any <code class="literal">Serializable</code> object, either a
custom object such as an application-specific <span class="emphasis"><em>Bean</em></span>,
or a general-purpose object such as a <code class="literal">java.util.Map</code>
implementation (e.g., a <code class="literal">Hashmap</code>).</p><p>But we found it very useful to use a general-purpose context holding
two maps, a regular (persistent) map and a transient one, so that
one can store serializable data that can be automatically persisted
by the TransactionManager (for recovery purposes) as well as <span class="emphasis"><em>live</em></span>
references (such as a TCP/IP socket or a JDBC connection).</p><p>So there&#8217;s a general purpose
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/Context.html" target="_top">Context</a>
reference implementation that in addition implements the
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/Pausable.html" target="_top">Pausable</a>
interface, required if you plan to use transaction continuations (<code class="literal">PAUSE</code>
modifier).</p><p>This Context reference implementation has two kind of <span class="emphasis"><em>put</em></span> operations:</p><pre class="programlisting">     <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> put (Object key, Object value)</pre><p>and</p><pre class="programlisting">     <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> put (Object key, Object value, <span class="hl-keyword">boolean</span> persist)</pre><p>When using the latter, if <code class="literal">persist == true</code>, then the object can
get automatically persisted by the TransactionManager (if configured to
do so, using the <code class="literal">persistent-space</code> property).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_context_recovery_interface"></a>9.3&nbsp;Context Recovery Interface</h2></div></div></div><p>In the previous section, we described a Transaction Context holding two maps: a
<span class="emphasis"><em>transient</em></span> map and a <span class="emphasis"><em>persistent</em></span> one.</p><p>In situations where the TransactionManager dies (e.g., during a power failure), a transaction could
have been in its preparing, committing or aborting phase.</p><p>Either the commit or abort methods will be called on all participants, but
before that happens, the TransactionManager gives the developer the
opportunity to let the participants know that we are not dealing with a
normal commit/abort but a recovery situation.</p><p>The developer may choose to implement the
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/ContextRecovery.html" target="_top">ContextRecovery</a>
interface:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ContextRecovery {
    <span class="hl-keyword">public</span> Serializable recover (<span class="hl-keyword">long</span> id, Serializable context, <span class="hl-keyword">boolean</span> commit); <a name="CO25-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
}</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO25-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>the <code class="literal">commit</code> boolean parameter indicates whether the transaction is going to commit or abort.</p></td></tr></table></div><p>The TransactionManager provides the opportunity to build up the transient part
of the Context (e.g., re-establishing a JDBC connection, re-fetching a database
record based on some persistent ID number , etc.).</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>While many participants can implement this interface, it is reasonable to have a single
one, similar to the initial <code class="literal">PrepareContext</code>, that can put a recovery flag in the Context,
re-establish JDBC connections, etc.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_assembly_line"></a>9.4&nbsp;Assembly Line</h2></div></div></div><p>It&#8217;s easier to understand the TM if we imagine an <span class="strong"><strong>assembly line</strong></span>.</p><p>Here is an example of a typical transaction (in this case taken from
the jCard system):</p><p>The TransactionManager encourages and allows developers to write reusable
and configurable components called <span class="emphasis"><em>Participants</em></span>. Here is a short
description of a typical Balance Inquiry transaction, splitted into many
small (easy to develop, easy to reuse, easy to maintain) participants:</p><div class="table"><a name="d0e8223"></a><p class="title"><b>Table&nbsp;9.2.&nbsp;AssemblyLine</b></p><div class="table-contents"><table summary="AssemblyLine" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Name</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PrepareContext</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We prepare the context with some handy objects, such
 as a transaction <code class="literal">TIMESTAMP</code>, a <code class="literal">Profiler</code> and optional
 user specific data required by all participants down
 the execution line.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CheckVersion</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We usually receive messages using a specific version. In this case,
 jCard uses the <a class="link" href="http://jpos.org/doc/jPOS-CMF.pdf" target="_top">jPOS-CMF</a> which
 has a specific field indicating the interchange version. This participant
 just check that and early aborts the transaction if it doesn&#8217;t match our
 expectations</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Open</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If version is OK, we probably want to log the message in a database.
 The <code class="literal">Open</code> participant gets a JDBC connection and starts a JDBC Transaction.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Switch</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We&#8217;ll explain later the <code class="literal">GroupSelectors</code> that allows us to put together
 groups of participants in the XML configuration. In this example, the
 selector returns a String with the following content:
    <code class="literal">"balanceinquiry prepareresponse logit close sendresponse"</code>
 indicating that the TM needs to execute the participants defined
 in those groups.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CheckFields</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Different transactions require the presence of different ISO8583 fields
 in the incoming message. Some are mandatory, some are optional, this
 reusable participant takes care of that. For example, in the case of
 a balance inquiry, we want to make sure that we have fields that allows
 us to identify the card, transaction amount, etc.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CreateTranLog</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If we reach this participant it means the incoming message is kinda OK,
 it has the proper version, it has the required mandatory fields, so we
 create a TranLog record. This is specific to jCard, but your implementation
 is likely to require some kind of transaction log record.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CheckCard</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>In order to compute the balance of a given account, we first need to locate
 the card. This involves getting the card by different means, could be track1
 data, track2 data, token, etc. The <code class="literal">CheckCard</code> participant takes care of that,
 and will place a handy Card object in the Context using a well known constant
 name (in the case of jCard, that constant is called <code class="literal">CARD</code> and is defined in
 the <code class="literal">org.jpos.ee.Constants</code> interface, but you can define it elsewhere, probably
 in an <code class="literal">enum</code>).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CheckTerminal</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We need to check that the client terminal is valid, active, and perhaps check
 its capabilities in order to provide responses in different formats (i.e. for
 printing purposes)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>CheckAcquirer</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We need to know the acquirer, perhaps to validate fees involved in this
 transaction.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SelectAccount</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We know the Card, so we know the CardHolder, depending on the transaction type
 and processing code, we may choose a different account (i.e. checking versus
 saving)</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ComputeBalances</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Now we know the account, so we compute its balances (available, accounting)
 and place it in the Context</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>PrepareResponse</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>We have the balances in the Context in <code class="literal">BigDecimal</code> objects under well
 known contant keys (i.e. <code class="literal">AVAILABLE_BALANCE</code>, <code class="literal">ACCOUNTING_BALANCE</code>), but
 we need to place those in the ISO8583 response, probably in field 54 (additional
 amounts).</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>LogIt</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Remember we&#8217;ve created a <code class="literal">TranLog</code> record in the <code class="literal">CreateTranLog</code> participant above,
 now we need to pick some of the data we have been gathering in the Context and
 place it there, so that it gets persisted in a database row.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Close</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Before we send a response, we need to commit the JDBC transaction and return the
 JDBC session to the pool.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>SendResponse</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Now we send the response back to the network</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ProtectDebugInfo</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The following participant (<span class="emphasis"><em>Debug</em></span>) dumps the Context&#8217;s content to the jPOS log,
 something very useful for debugging purposes, but there&#8217;s some sensitive data
 in the Context, so this little participant take care of masking it.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Debug</p></td><td style="" align="left" valign="top"><p>Dumps the Context to the jPOS log.</p></td></tr></tbody></table></div></div><br class="table-break"><p>Here is the sample log:</p><pre class="screen">     prepare: org.jpos.jcard.PrepareContext NO_JOIN
     prepare: org.jpos.jcard.CheckVersion READONLY NO_JOIN
     prepare: org.jpos.transaction.Open READONLY NO_JOIN
     prepare: org.jpos.jcard.Switch READONLY NO_JOIN
    selector: balanceinquiry prepareresponse logit close sendresponse
     prepare: org.jpos.jcard.CheckFields NO_JOIN
     prepare: org.jpos.jcard.CreateTranLog NO_JOIN
     prepare: org.jpos.jcard.CheckCard NO_JOIN
     prepare: org.jpos.jcard.CheckTerminal NO_JOIN
     prepare: org.jpos.jcard.CheckAcquirer NO_JOIN
     prepare: org.jpos.jcard.SelectAccount NO_JOIN
     prepare: org.jpos.jcard.ComputeBalances NO_JOIN
     prepare: org.jpos.jcard.PrepareResponse NO_JOIN
     prepare: org.jpos.jcard.LogIt READONLY NO_JOIN
     prepare: org.jpos.transaction.Close READONLY
     prepare: org.jpos.jcard.SendResponse READONLY
     prepare: org.jpos.jcard.ProtectDebugInfo READONLY
     prepare: org.jpos.transaction.Debug READONLY
      commit: org.jpos.transaction.Close
      commit: org.jpos.jcard.SendResponse
      commit: org.jpos.jcard.ProtectDebugInfo
      commit: org.jpos.transaction.Debug</pre><p>In a blue sky scenario like the previous one, the TM calls all participant&#8217;s
<code class="literal">prepare</code> method, which return PREPARED, and then the <code class="literal">commit</code> method on
those that have joined the transaction (by not returning the <code class="literal">NO_JOIN</code>
modifier).</p><p>Here is a diagram for a situation where all participants return just <code class="literal">PREPARED</code>
(meaning they DO want to join the transaction, so commit gets called).</p><p><span class="inlinemediaobject"><img src="images/tm_prepared.png" alt="PREPARED"></span></p><p>When a participant adds the <code class="literal">NO_JOIN</code> modifier (by returning
<code class="literal">PREPARED | NO_JOIN</code>), then the TM skips calling that participant&#8217;s
<code class="literal">commit</code> method as shown in the following diagram.</p><p><span class="inlinemediaobject"><img src="images/tm_no_join.png" alt="PREPARED | NO_JOIN"></span></p><p>If a participant returns <code class="literal">ABORT</code>, then the TM calls the <code class="literal">abort</code> operation
in those participants already called that where <code class="literal">PREPARED</code> and did not return
the <code class="literal">NO_JOIN</code> modifier so that they can take corrective action if required.</p><p><span class="inlinemediaobject"><img src="images/tm_abort.png" alt="ABORTED"></span></p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_abortparticipant"></a>9.5&nbsp;AbortParticipant</h2></div></div></div><p>Imagine you have a list of participants that define a transaction, for example:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">ValidateMessage</code> (sanity checks)</li><li class="listitem"><code class="literal">FetchData</code> (i.e. get Terminal/Merchant info from database)</li><li class="listitem"><code class="literal">QueryRemoteHost</code></li><li class="listitem"><code class="literal">LogTransaction</code></li><li class="listitem"><code class="literal">SendResponse</code></li></ul></div><p>If everything goes okay and all participants return <code class="literal">PREPARED</code>, then you&#8217;ll have
no problem reaching the last set of participants. By contrast, if for some
reason a given participant fails (e.g., imagine <code class="literal">FetchData</code> fails), then the
remaining participants down the list (in our example, FetchData through
<code class="literal">SendResponse</code>) won&#8217;t get called because the transaction manager will initiate
the aborting procedure (which will call abort(id,context) only on the
previously-called participants, i.e., only on ValidateMessage in our example).</p><p>In the previous example, while it&#8217;s okay to ignore a call to the
<code class="literal">QueryRemoteHost</code> participant, you may still want to send a response
back to the client, or even log the transaction, so you do want to call
<code class="literal">SendResponse</code>.</p><p>The
<a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/AbortParticipant.html" target="_top">AbortParticipant</a>
is designed to solve this problem:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AbortParticipant <span class="hl-keyword">extends</span> TransactionParticipant {
    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>  prepareForAbort (<span class="hl-keyword">long</span> id, Serializable context);
}</pre><p>Participants implementing the <code class="literal">AbortParticipant</code> will get called even if the transaction
is bound to abort.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If we use this technique to implement a <code class="literal">SendResponse</code> participant, as an additional
protection it is a good idea to verify that we are not approving a transaction.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>As of jPOS 2.1.0 the <code class="literal">prepareForAbort</code> has a default implementation that
calls the TransactionParticipant&#8217;s <code class="literal">prepare</code> method.</p></td></tr></table></div><p>If you see the previous diagram, when participant 3 returns <code class="literal">ABORTED</code>, the last
participant doesn&#8217;t get called. If participant number four implements this
<code class="literal">AbortParticipant</code> interface, the diagram would look like this:</p><p><span class="inlinemediaobject"><img src="images/tm_abort_participant.png" alt="AbortParticipant"></span></p><p>At <code class="literal">prepareForAbort()</code> time, returning <code class="literal">PREPARED</code>, or <code class="literal">ABORTED</code>, is quite the same.
A <code class="literal">PREPARED</code> wouldn&#8217;t affect the flow of the transaction, it&#8217;s still in its <code class="literal">ABORT</code> track.
But the <code class="literal">NO_JOIN</code> modifier could be useful if you&#8217;re doing nothing in your <code class="literal">abort()</code> callback.
It&#8217;s an indication to the TM that it doesn&#8217;t need to call abort.
The difference is minimal, calling a dummy <code class="literal">abort()</code> method that does nothing is quite fast,
but the TM still needs to register that it needs to call that participant, and it records histograms, profiler, etc.
So <code class="literal">NO_JOIN</code> is a good thing to consider returning.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_groupselector"></a>9.6&nbsp;GroupSelector</h2></div></div></div><p>Having a configuration like this:</p><pre class="programlisting">  <span class="hl-tag">&lt;txnmgr</span> <span class="hl-attribute">...&gt;</span>
   <span class="hl-attribute">&lt;participant</span> <span class="hl-attribute">A</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">B</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">C</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">D</span><span class="hl-tag"> /&gt;</span>
   ...
  <span class="hl-tag">&lt;/txnmgr&gt;</span></pre><p>may be good for some small applications, but you risk ending up having to
configure multiple transaction managers for different classes of transactions
(e.g., network management, authorization, draft capture, etc.) or add
complexity to participants in order to operate or do nothing depending
on the transation type.</p><p>In order to simplify the TransactionManager configuration, we&#8217;ve added a very
simple interface called <code class="literal">GroupSelector</code>:</p><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> GroupSelector <span class="hl-keyword">extends</span> TransactionParticipant {
        <span class="hl-keyword">public</span> String select (<span class="hl-keyword">long</span> id, Serializable context);
    }</pre><p>A participant implementing the <code class="literal">GroupSelector</code> interface can modify the flow of
a transaction by returning a space-separated list of group names (or can
specify <span class="emphasis"><em>null</em></span> to signify no action).</p><p>Our Q2-based TransactionManager reference implementation supports this
interface and lets you design your own configuration file with a structure
like this:</p><pre class="programlisting">  <span class="hl-tag">&lt;txnmgr</span> <span class="hl-attribute">...&gt;</span>
   <span class="hl-attribute">&lt;participant</span> <span class="hl-attribute">A</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">B</span><span class="hl-tag"> /&gt;</span>
   ...
   ...
   <span class="hl-tag">&lt;group</span> <span class="hl-attribute">name</span>=<span class="hl-value">"GroupA"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">A</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">B</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">C</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;/group&gt;</span>
   <span class="hl-tag">&lt;group</span> <span class="hl-attribute">name</span>=<span class="hl-value">"GroupB"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">J</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">K</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">L</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;/group&gt;</span>
   <span class="hl-tag">&lt;group</span> <span class="hl-attribute">name</span>=<span class="hl-value">"GroupC"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">X</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">Y</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">Z</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;/group&gt;</span>
   ...
   ...
  <span class="hl-tag">&lt;/txnmgr&gt;</span></pre><div class="example"><a name="d0e8615"></a><p class="title"><b>Example&nbsp;9.1.&nbsp;Sample GroupSelector implementation</b></p><div class="example-contents"><pre class="programlisting">    <span class="hl-keyword">public</span> <span class="hl-keyword">class</span> Switch <span class="hl-keyword">implements</span> GroupSelector {
        <span class="hl-keyword">public</span> <span class="hl-keyword">int</span>  prepare (<span class="hl-keyword">long</span> id, Serializable context) {
            <span class="hl-keyword">return</span> PREPARED | READONLY | NO_JOIN;
        }
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> commit   (<span class="hl-keyword">long</span> id, Serializable context) { }
        <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> abort    (<span class="hl-keyword">long</span> id, Serializable context) { }
        <span class="hl-keyword">public</span> String select (<span class="hl-keyword">long</span> id, Serializable context) {
            <span class="hl-keyword">try</span> {
                ISOMsg m = (ISOMsg) ((Context)context).get (ISOMSG);
                String groups = cfg.get (m.getMTI(), null);
                <span class="hl-keyword">return</span> groups;
            } <span class="hl-keyword">catch</span> (Exception e) {
                warn (e);
                <span class="hl-keyword">return</span> null;
            }
        }
    }</pre></div></div><br class="example-break"><p>By using the <code class="literal">Switch</code> presented in the previous example, you can write a
TransactionManager configuration file like this:</p><pre class="programlisting">   ...
   ...
   <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.my.Switch"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0100"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Authorization Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0200"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Financial Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0220"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Notification Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0221"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Notification Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0420"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Reversal Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0421"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Reversal Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0500"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"BatchManagement Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0421"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Reversal Response Log"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"0800"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"NetworkManagement Response Log"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;/participant&gt;</span>
   ...
   ...
   <span class="hl-tag">&lt;group</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Financial"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.my.company.CheckRequiredFields"</span><span class="hl-tag">&gt;</span>
     <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"fields"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"0,3,4,17,49,32,41,43,37,PAN,AMOUNT"</span><span class="hl-tag"> /&gt;</span>
    <span class="hl-tag">&lt;/participant&gt;</span>
    <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.my.company.CheckCurrency"</span><span class="hl-tag"> /&gt;</span>
    ...
    ...
   <span class="hl-tag">&lt;/group&gt;</span>

   <span class="hl-tag">&lt;group</span> <span class="hl-attribute">name</span>=<span class="hl-value">"Reversal"</span><span class="hl-tag">&gt;</span>
    ...
    ...
   <span class="hl-tag">&lt;/group&gt;</span>
   ...
   ...</pre><p>Using the previous approach, the application can be designed using small
reusable participants. Moreover, using XML entity expansion, the resulting
configuration file can be very readable.</p><p>We have found it very useful to have very small participants to perform tasks
like: Debug the context; introduce Delays (during testing); Open  and Close
O/R mapping sessions, etc.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_transactionmanager_implementation"></a>9.7&nbsp;TransactionManager implementation</h2></div></div></div><p>The <code class="literal">TransactionManager</code> is a jPOS Service that monitors a Space queue waiting
for transactions to be processed. These transactions are expected to be any
<code class="literal">Serializable</code> object, but in most jPOS applications those are actually
<code class="literal">org.jpos.transaction.Context</code> objects.</p><p>The following image shows a typical scenario:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">A QServer (or a QMUX) receives a message and delegate its handling to an <code class="literal">ISORequestListener</code>
implementation</li><li class="listitem">The <code class="literal">ISORequestListener</code> creates an instance of a <code class="literal">Context</code>, puts there some information relevant
to the transaction (such as a reference to the received <code class="literal">ISOMsg</code> and the originating <code class="literal">ISOSource</code>)
and place it in a well known space, using a well known <code class="literal">key</code>. We use the space as a <span class="emphasis"><em>queue</em></span>
so we call it <span class="emphasis"><em>queue</em></span>, but it&#8217;s just a regular entry in the space under a well known name.</li><li class="listitem">The <code class="literal">TransactionManager</code> picks the entry from the space (using a regular <code class="literal">in</code> operation)
and runs the previously described two-phase commit protocol on the configured participants.</li></ul></div><p><span class="inlinemediaobject"><img src="images/tm_example.png" alt="TransactionManager Example"></span></p><p>Each participant is instantiated and configured just once by the TransactionManager at
init time, they use the <span class="emphasis"><em>Flyweight pattern</em></span>, but the TransactionManager uses several
simultaneous sessions to handle transactions.</p><p><span class="inlinemediaobject"><img src="images/tm_sessions.png" alt="TransactionManager Sessions"></span></p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the previous paragraph we mention that the TransactionManager uses the
<span class="emphasis"><em>Flyweight pattern</em></span>.  It is extremely important to understand the pattern
before implementing participants. Each participant is instantiated once, but
multiple sessions can run simultaneously. In addition, sessions can be paused
and continued. All session information must be stored in the Context, which the
transaction manager appropriately sets before calling a participant, but <span class="strong"><strong>never
ever</strong></span> in member variables.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Participants usually don&#8217;t need a reference to their TransactionManager.
If required, the participant can implement a method:</p><p><code class="literal">setTransactionManager(TransactionManager tm)</code></p><p>that will get called once at initialization time using reflection.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tm_use_of_spaces"></a>9.7.1&nbsp;TM use of spaces</h3></div></div></div><p>The TransactionManager uses 3 different spaces for operation.</p><p>We see in the previous diagram that the producer (depicted as <span class="emphasis"><em>client</em></span> in the
image) places entries in a Space, to be consumed by the TransactionManager.</p><p>This can be the general purpose <span class="emphasis"><em>default</em></span> space (<code class="literal">tspace:default</code>), but in
high demanding environments, it is possible to define a separate space,
defined as <code class="literal">input-space</code>.</p><p>Internally, it also needs a transient space to keep track of the in-flight
transactions. Again, if not specified, the TransactionManager will use
<code class="literal">tspace:default</code>, but it is possible to configure a separate space for
that using the <code class="literal">space</code> property in the XML configuration file.</p><p>For recovery purposes, a persistent space (defined with the property
<code class="literal">persistent-space</code>) is required, i.e.: <code class="literal">je:XXXX</code> (XXXX being the name
of the space). But taking snapshots to disk reduces the TM speed by
probably an order of magnitude, and many applications that use the
TransactionManager don&#8217;t take advantage of its recovery features,
this space defaults to an internal space.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration"></a>9.7.2&nbsp;Configuration</h3></div></div></div><p>The TransactionManager is implemented by <code class="literal">org.jpos.transaction.TransactionManager</code>
but <code class="literal">QFactory.properties</code> defines a couple of handy names for it:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">txnmgr</code>, or</li><li class="listitem"><code class="literal">transaction-manager</code></li></ul></div><p>So a TM configuration can look like this:</p><pre class="programlisting"><span class="hl-tag">&lt;txnmgr</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myTM"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"TM"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myTMQueue"</span><span class="hl-tag"> /&gt;</span>
  ...
  ...
<span class="hl-tag">&lt;/txnmgr&gt;</span></pre><p>or</p><pre class="programlisting"><span class="hl-tag">&lt;transaction-manager</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myTM"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"TM"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myTMQueue"</span><span class="hl-tag"> /&gt;</span>
  ...
  ...
<span class="hl-tag">&lt;/transaction-manager&gt;</span></pre><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">name</code> attribute is not technically required, if ommitted, the transaction manager would
get registered in the <code class="literal">NameRegistrar</code> using its root-element name (i.e.: <code class="literal">txnmgr</code> or
<code class="literal">transaction-manager</code> depending on your configuration). But if you are deploying more than
one TM in the same Q2 instance, the second one would get a <code class="literal">duplicate name</code> error, and your
XML QBean descriptor would get renamed to <code class="literal">.DUP</code>. Using the <code class="literal">name</code> attribute with unique
names solves the problem.</p></td></tr></table></div><p>The TM requires a mandatory property (<code class="literal">queue</code>) and honors some optional ones,
which have sensible defaults.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>queue</strong></span>
This is the Space-based <span class="emphasis"><em>queue</em></span> where the TM looks for transactions to be processed.
As described above, these transactions are actually <code class="literal">Serializable</code> objects, typically
an instance of <code class="literal">org.jpos.transaction.Context</code>. This is a mandatary property.</li><li class="listitem"><span class="strong"><strong>input-space</strong></span>
This is the Space where the TransactionManager&#8217;s sessions wait for transactions
to be queued. It defaults to the default space returned by <code class="literal">SpaceFactory.getSpace()</code>
that is currently set to <code class="literal">tspace:default</code>.</li><li class="listitem"><span class="strong"><strong>space</strong></span>
Space used by the TransactionManager to handle in-flight transactions. The TM uses
a Space-based circular queue. This Space also uses the system&#8217;s default, but
in high load systems it is reasonable to consider using a unique space for
each TransactionManager.</li><li class="listitem"><span class="strong"><strong>persistent-space</strong></span>
If the application takes advantage of crash recovery features, a persistent
space has to be defined. It can be any persistent space, such as <code class="literal">jdbm</code> or
the more robust <code class="literal">je</code> based spaces (i.e. <code class="literal">je:mytm:/path/to/mytm</code>).</li><li class="listitem"><span class="strong"><strong>recover</strong></span>
When the TransactionManager starts, it checks the persistent space for
in-flight transactions from a previous run. If this feature is not being
used, it is recommended to set <code class="literal">recover</code> to false (although it doesn&#8217;t hurt
to keep it on in most situations).</li><li class="listitem"><span class="strong"><strong>debug</strong></span>
If true, the TransactionManager logs a small report after each transaction
indicating which participants took place. The log looks like this:</li></ul></div><pre class="programlisting">  <span class="hl-tag">&lt;debug&gt;</span>
    txnmgr-1:2
            prepare: org.jpos.jcard.PrepareContext NO_JOIN
            prepare: org.jpos.jcard.CheckVersion READONLY NO_JOIN
            prepare: org.jpos.transaction.Open READONLY NO_JOIN
            prepare: org.jpos.jcard.Switch READONLY NO_JOIN
      groupSelector: notsupported prepareresponse close sendresponse
            prepare: org.jpos.jcard.NotSupported NO_JOIN
            prepare: org.jpos.jcard.PrepareResponse NO_JOIN
            prepare: org.jpos.transaction.Close READONLY
            prepare: org.jpos.jcard.SendResponse READONLY
            prepare: org.jpos.jcard.ProtectDebugInfo READONLY
            prepare: org.jpos.transaction.Debug READONLY
             commit: org.jpos.transaction.Close
             commit: org.jpos.jcard.SendResponse
             commit: org.jpos.jcard.ProtectDebugInfo
             commit: org.jpos.transaction.Debug
    head=3, tail=3, outstanding=0, active-sessions=2/2, tps=0, peak=0,
    avg=0.00, elapsed=22ms
  <span class="hl-tag">&lt;/debug&gt;</span></pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>profiler</strong></span>
If the profiler property is set to true, in addition to the debug output, the
TransactionManager records the time consumed by each participant callback.
Setting profiler to <code class="literal">true</code> also sets <code class="literal">debug</code> to true automatically.</li></ul></div><p>This adds the following information to the log</p><pre class="programlisting">  <span class="hl-tag">&lt;debug&gt;</span>
    ....
    ....
    <span class="hl-tag">&lt;profiler&gt;</span>
      prepare: org.jpos.jcard.PrepareContext [0.0/0.0]
      prepare: org.jpos.jcard.CheckVersion [0.0/0.0]
      prepare: org.jpos.transaction.Open [0.5/0.6]
      prepare: org.jpos.jcard.Switch [0.0/0.6]
      prepare: org.jpos.jcard.NotSupported [0.1/0.7]
      prepare: org.jpos.jcard.PrepareResponse [5.8/6.6]
      prepare: org.jpos.transaction.Close [0.0/6.6]
      prepare: org.jpos.jcard.SendResponse [0.0/6.6]
      prepare: org.jpos.jcard.ProtectDebugInfo [0.0/6.7]
      prepare: org.jpos.transaction.Debug [0.0/6.7]
       commit: org.jpos.transaction.Close [1.0/7.7]
       commit: org.jpos.jcard.SendResponse [4.3/12.0]
       commit: org.jpos.jcard.ProtectDebugInfo [0.2/12.3]
       commit: org.jpos.transaction.Debug [9.3/21.7]
      end [22.8/22.8]
    <span class="hl-tag">&lt;/profiler&gt;</span>
  <span class="hl-tag">&lt;/debug&gt;</span></pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>sessions</strong></span>
Defines the number of simultaneous sessions (Threads) used to process transactions.
Defaults to one. It is recommended to keep the <code class="literal">sessions</code> property within a
reasonable value commensurate the number of CPU cores of the system. A
large number here just slows down the capacity of the system.</li><li class="listitem"><span class="strong"><strong>max-sessions</strong></span>
In order to deal with occasional traffic spikes (sometimes caused by small
network glitches), the TransactionManager can temporarily increase the
number of sessions. This property defines that maximum. It defaults to
the value set for <code class="literal">sessions</code>. For obvious reasons, <code class="literal">max-sessions</code> can&#8217;t
be less than <code class="literal">sessions</code>.</li><li class="listitem"><span class="strong"><strong>max-active-sessions</strong></span>
When using the TransactionManager <span class="emphasis"><em>continuations</em></span> feature (where the prepare callback
returns <code class="literal">PAUSE</code> modifier), it is possible that a small number of sessions
can process a large number of in-flight transactions. Those transactions
may place in the <code class="literal">Context</code> references to live objects such as JDBC
sessions. In order to place a cap on the number of in-flight transactions
to avoid exhausting resources (for example a JDBC pool), this
<code class="literal">max-active-sessions</code> property can be set.
The default is 0, which means no limit is imposed.</li></ul></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If you&#8217;re <span class="emphasis"><em>pausing</em></span> your transactions, please read the previous paragraph
multiple times and make sure you understand it.</p></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>call-selector-on-abort</strong></span>
The transaction manager calls the <code class="literal">prepare</code> method, and then, if the participant
implements the <code class="literal">GroupSelector</code> interface, it calls its <code class="literal">select</code> method, regardless
of the result of the <code class="literal">prepare</code> call. While in practice that&#8217;s a reasonable and
useful behavior, it can be argued that technically, the TM shouldn&#8217;t call <code class="literal">select</code>
if the transaction is bound to abort. We have provided this configuration parameter
that can be set to <code class="literal">false</code> in order to enable that behavior.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_transactionstatuslistener"></a>9.7.3&nbsp;TransactionStatusListener</h3></div></div></div><p>It is possible to monitor a TransactionManager by adding a <code class="literal">TransactionListener</code></p><p>The interface is very simple:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> TransactionStatusListener <span class="hl-keyword">extends</span> EventListener {
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> update (TransactionStatusEvent e);
}</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">see <a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/TransactionStatusListener.html" target="_top">TransactionStatusListener</a> and</li><li class="listitem"><a class="link" href="http://jpos.org/doc/javadoc/org/jpos/transaction/TransactionStatusEvent.html" target="_top">TransactionStatusEvent</a></li></ul></div><p>A <code class="literal">TransactionStatusListener</code> can be either added dynamically (using the
<code class="literal">TransactionManager.addListener(TransactionStatusListener)</code> method) or using
XML configuration like this:</p><pre class="programlisting"><span class="hl-tag">&lt;transaction-manager</span> <span class="hl-attribute">name</span>=<span class="hl-value">"myTM"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"TM"</span><span class="hl-tag">&gt;</span>
  ...
  ...
  <span class="hl-tag">&lt;status-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"your.transaction.Listener"</span><span class="hl-tag"> /&gt;</span>
  ...
  ...
<span class="hl-tag">&lt;/transaction-manager&gt;</span></pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>standard logger, realm, and properties can be used.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Calls to the transaction status listener are synchronous, the implementation
is expected to return really fast.</p></td></tr></table></div><p>The <code class="literal">TMMON</code> CLI command (see <a class="xref" href="#cli_commands" title="--cli">the section called &#8220;<code class="literal">--cli</code>&#8221;</a>) is an example of a <code class="literal">TransactionStatusListener</code> interface
and so is the <code class="literal">org.jpos.transaction.gui.TMMonitor</code> implementation.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_transaction_participants"></a>9.8&nbsp;Transaction Participants</h2></div></div></div><p>jPOS comes with some general purpose transaction participant implementations that
can be used as-is or used as a reference to write your own.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>The <code class="literal">&lt;participant ...&gt;</code> element supports an optional <code class="literal">enabled</code> attribute
that can be used disable participants at runtime. The <code class="literal">enabled</code> value can
either be 'yes/no/true/false` or a list of environment names (i.e.: <code class="literal">prod, staging</code>).</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_switch_participant"></a>9.8.1&nbsp;Switch participant</h3></div></div></div><p>The <code class="literal">org.jpos.transaction.participant.Switch</code> is a general
purpose <code class="literal">GroupSelector</code> that uses a context entry&#8217;s
value to return a set of groups picked from a standard <code class="literal">Configuration</code>.</p><div class="table"><a name="d0e9060"></a><p class="title"><b>Table&nbsp;9.3.&nbsp;Switch participant Configuration Properties</b></p><div class="table-contents"><table summary="Switch participant Configuration Properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>txnname</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Context entry to use as key</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">TXNNAME</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>unknown</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Set of groups to be used on not found</p></td><td style="" align="left" valign="top"><p>""</p></td></tr></tbody></table></div></div><br class="table-break"><p>Here is a sample configuration taken from jCard:</p><pre class="programlisting"> <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.Switch"</span>
      <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"Switch"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.30"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"balanceinquiry prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.30.182"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"customer-balanceinquiry prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.00"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"authorization prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.02"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"auth-void prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.20"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"refund prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.22"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"refund-void prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"100.00.201"</span>
           <span class="hl-attribute">value</span>=<span class="hl-value">"auth-adjustment prepareresponse logit close sendresponse"</span><span class="hl-tag"> /&gt;</span>
   ...
   ...</pre><p>A previous participant puts in the context under the key <code class="literal">TXNNAME</code> data taken from
the request ISOMsg (i.e. MTI, processing code, function code).</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_checkfields_participant"></a>9.8.2&nbsp;CheckFields participant</h3></div></div></div><p>The <code class="literal">org.jpos.transaction.participant.CheckFields</code> is a general
participant that can be used to check for mandatory as well as
optional fields present in the context.</p><div class="table"><a name="d0e9114"></a><p class="title"><b>Table&nbsp;9.4.&nbsp;CheckFields Configuration Properties</b></p><div class="table-contents"><table summary="CheckFields Configuration Properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>request</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Name of the ISOMsg to be checked</p></td><td style="" align="left" valign="top"><p><code class="literal">REQUEST</code></p></td></tr></tbody></table></div></div><br class="table-break"><p>Here is a sample configuration:</p><pre class="programlisting"> <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.CheckFields"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"mandatory"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"PCODE,TRANSMISSION_TIMESTAMP,11,12,AMOUNT,CARD,41"</span><span class="hl-tag"> /&gt;</span>
   <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"optional"</span>  <span class="hl-attribute">value</span>=<span class="hl-value">"15,17,21,22,24,32,37,42,43,46,60,63,62,111,113"</span><span class="hl-tag"> /&gt;</span>
   ...
   ...
<span class="hl-tag">&lt;/participant&gt;</span></pre><p>The <code class="literal">CheckFields</code> handle standard numeric fields performing minimum validations (i.e. <code class="literal">7,11,12,35</code>),
it just checks for presence of those fields, but it handle some special names that are relevant to
most jPOS applications, specially those dealing with <a class="link" href="http://jpos.org/doc/jPOS-CMF.pdf" target="_top">jPOS-CMF</a>.</p><p>In those situations, <code class="literal">CheckFields</code> performs additional parsing, validation, and places in the
Context handy objects that other participants can use.</p><p>For example, if we use the name <code class="literal">CARD</code>, then <code class="literal">CheckFields</code> participant tries to get us a <code class="literal">Card</code>
object taking it from either fields 2 and 14 (manual entry) as well as 35 (track2) or 45 (track1).
In addition, it verifies that track1 and track2 are valid, and matches the PAN and EXP values
present in fields 2 and 14 (if available).</p><p>The complete list of special names are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">PCODE</code> - parses the processing code.</li><li class="listitem"><code class="literal">CARD</code>  - creates a <code class="literal">org.jpos.core.Card</code> Object.</li><li class="listitem"><code class="literal">TID</code>   - Terminal ID picked from field 41.</li><li class="listitem"><code class="literal">MID</code>   - Merchant ID picked from field 42.</li><li class="listitem"><code class="literal">TRANSMISSION_TIMESTAMP</code> - creates a Date object picked from field 7 (ISO-8583 v2003 format).</li><li class="listitem"><code class="literal">TRANSACTION_TIMESTAMP</code> - creates a Date object picked from field 12 (ISO-8583 v2003 format).</li><li class="listitem"><code class="literal">POS_DATA_CODE</code> - create a POSDataCode from field 22.</li><li class="listitem"><code class="literal">CAPTURE_DATE</code> - date object picked from field 17</li><li class="listitem"><code class="literal">AMOUNT</code> - picks <code class="literal">ISOAmount</code> from either field 4 or 5. If field 5 is available, then <code class="literal">AMOUNT</code> holds the content of field 5 (settlement amount)
while field 4 gets stored in another Context variable called <code class="literal">LOCAL_AMOUNT</code> (ISO-8583 v2003 format).</li><li class="listitem"><code class="literal">ORIGINAL_DATA_ELEMENTS</code> parses original MTI, STAN and TIMESTAMP from field 56 (ISO-8583 v2003 format).</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_selectdestination"></a>9.8.3&nbsp;SelectDestination</h3></div></div></div><p><code class="literal">org.jpos.transaction.participant.SelectDestination</code> can be used to select
the proper destination for a given message based on BIN, extended BIN or
full or partial PAN number.</p><p>Sample configuration:</p><pre class="programlisting"> <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.SelectDestination"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;endpoint</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"MyMux"</span><span class="hl-tag">&gt;</span>
     4                          <a name="CO26-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
     5..7                       <a name="CO26-2"></a><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span>
     32..35                     <a name="CO26-3"></a><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span>
     366666                     <a name="CO26-4"></a><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span>
     366667
     5111111111111111           <a name="CO26-5"></a><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span>
  <span class="hl-tag">&lt;/endpoint&gt;</span>
  <span class="hl-tag">&lt;endpoint</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"AnotherMux"</span><span class="hl-tag">&gt;</span>
     ...
     ...
  <span class="hl-tag">&lt;/endpoint&gt;</span>
  <span class="hl-tag">&lt;regexp</span> <span class="hl-attribute">destination</span>=<span class="hl-value">"VISA"</span><span class="hl-tag">&gt;</span>   <a name="CO26-6"></a><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span>
    ^4[\d]{15}?$
   <span class="hl-tag">&lt;/regexp&gt;</span>
 <span class="hl-tag">&lt;/participant&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>All cards starting with 4 go to this destination</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-2"><span><img src="images/icons/callouts/2.png" alt="2" border="0"></span></a> </p></td><td valign="top" align="left"><p>Cards starting with 5, 6 or 7</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-3"><span><img src="images/icons/callouts/3.png" alt="3" border="0"></span></a> </p></td><td valign="top" align="left"><p>Cards starting with 32, 33, 34 or 35</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-4"><span><img src="images/icons/callouts/4.png" alt="4" border="0"></span></a> </p></td><td valign="top" align="left"><p>Only cards starging with BIN 366666</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-5"><span><img src="images/icons/callouts/5.png" alt="5" border="0"></span></a> </p></td><td valign="top" align="left"><p>Full PAN matching</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO26-6"><span><img src="images/icons/callouts/6.png" alt="6" border="0"></span></a> </p></td><td valign="top" align="left"><p>Regular expression based matching (takes priority over the endpoint number matching)</p></td></tr></table></div><p>These BIN or BIN ranges have 1 to 19 digits. More specific ranges (more digits)
get priority over less specific ones.</p><p>If the Context has a <code class="literal">DESTINATION</code> entry already, and this participant finds an
endpoint in its routing tables, then that <code class="literal">DESTINATION</code> will be overridden. On the
other hand, if <code class="literal">DESTINATION</code> is not present in the context, and this participant
doesn&#8217;t find a route <span class="strong"><strong>and</strong></span> there&#8217;s a <code class="literal">default-destination</code> property present in
the configuration, then the <code class="literal">default-destination</code> will be set.</p><div class="table"><a name="d0e9301"></a><p class="title"><b>Table&nbsp;9.5.&nbsp;SelectDestination Configuration Properties</b></p><div class="table-contents"><table summary="SelectDestination Configuration Properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ISOMsg used to derive destination</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REQUEST</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Destination Context variable</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DESTINATION</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>default-destination</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>If no routing found, route to this destination</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top">&nbsp;</td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ignore-luhn</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Set to <code class="literal">true</code> to lift LUHN validation</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">false</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>fail</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Set to <code class="literal">true</code> to fail if no route found</p></td><td style="" align="left" valign="top"><p><code class="literal">false</code></p></td></tr></tbody></table></div></div><br class="table-break"><p><code class="literal">SelectDestination</code> may place CMF failure messages in the Context, i.e.:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>INVALID_CARD_OR_CARDHOLDER_NUMBER</strong></span> when Card is present but invalid.</li><li class="listitem"><span class="strong"><strong>ROUTING_ERROR</strong></span> when no route could be found.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_queryhost"></a>9.8.4&nbsp;QueryHost</h3></div></div></div><p><code class="literal">org.jpos.transaction.participant.QueryHost</code> can be used to send an ISOMsg
to a remote host using a MUX and wait for a response.</p><p>It can operate in synchronous mode (waits a given timeout for a response to
arrive) or use TransactionManager&#8217;s <span class="emphasis"><em>continuations</em></span> (default) to actually
<code class="literal">PAUSE</code> the transaction until a response arrives.</p><p>It provides sensible defaults up to the point that it can be easily
configured without any property, i.e.:</p><pre class="programlisting"> <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.QueryHost"</span><span class="hl-tag">/&gt;</span></pre><div class="table"><a name="d0e9409"></a><p class="title"><b>Table&nbsp;9.6.&nbsp;QueryHost Configuration Properties</b></p><div class="table-contents"><table summary="QueryHost Configuration Properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>ISOMsg to be transmitted</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REQUEST</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>response</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Response object</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">RESPONSE</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>destination</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Destination MUX</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">DESTINATION</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Time to wait for response in milliseconds</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>30000</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>wait-timeout</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>Time to wait for connection in case MUX is disconnected in milliseconds</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p>12000</p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>continuations</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Set to false in order to operate in sync mode</p></td><td style="" align="left" valign="top"><p>true</p></td></tr></tbody></table></div></div><br class="table-break"><p><code class="literal">QueryHost</code> may place CMF failure messages in the Context, i.e.:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>MISCONFIGURED_ENDPOINT</strong></span> when Context doesn&#8217;t have a <code class="literal">DESTINATION</code> object or the destination MUX is not available in the <code class="literal">NameRegistrar</code></li><li class="listitem"><span class="strong"><strong>INVALID_REQUEST</strong></span> if <code class="literal">REQUEST</code> is not in the context</li><li class="listitem"><span class="strong"><strong>HOST_UNREACHABLE</strong></span> if MUX can not connect to the host or a response is not provided within the specified timeout</li><li class="listitem"><span class="strong"><strong>SYSTEM_ERROR</strong></span> on ISOException</li></ul></div><p>A MUX/Server can have a request listener like this:</p><pre class="programlisting"> <span class="hl-tag">&lt;request-listener</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.iso.IncomingListener"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span>     <span class="hl-attribute">value</span>=<span class="hl-value">"TXNMGR"</span><span class="hl-tag"> /&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"ctx.DESTINATION"</span>  <span class="hl-attribute">value</span>=<span class="hl-value">"MYMUX"</span><span class="hl-tag"> /&gt;</span>
 <span class="hl-tag">&lt;/request-listener&gt;</span></pre><p>Then a TransactionManager can be configured like this:</p><pre class="programlisting"> <span class="hl-tag">&lt;txnmgr</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.TransactionManager"</span> <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span><span class="hl-tag">&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"queue"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"TXNMGR"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessions"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"2"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"max-sessions"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"128"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"debug"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"true"</span><span class="hl-tag">/&gt;</span>

  <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.QueryHost"</span><span class="hl-tag">/&gt;</span>
  <span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.SendResponse"</span><span class="hl-tag">/&gt;</span>
 <span class="hl-tag">&lt;/txnmgr&gt;</span></pre><p>In the previous example <code class="literal">IncomingListener</code> will create a context and set the
<code class="literal">SOURCE</code>, <code class="literal">REQUEST</code> and <code class="literal">DESTINATION</code> variables. Those will be queued through
a Space to the <code class="literal">TXNMGR</code> queue. The TransactionManager will query the remote host
using a MUX called <code class="literal">MYMUX</code> (the <code class="literal">NameRegistrar</code> will show <code class="literal">mux.MYMUX</code>) and the
response (if present) should be placed in the context under the name <code class="literal">RESPONSE</code>.</p><p><code class="literal">SendResponse</code> participant will pick that information to provide a response.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>The previous was an ideal situation where we get a response. In a real world application,
a small participant sitting before <code class="literal">SendResponse</code> would analyze <code class="literal">ctx.getResult()</code> for failures
and set the appropriate response.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_sendresponse"></a>9.8.5&nbsp;SendResponse</h3></div></div></div><p>The <code class="literal">org.jpos.transaction.participant.SendResponse</code> can be used
to provide responses to a given source. It looks for a <code class="literal">SOURCE</code>
property and a <code class="literal">RESPONSE</code> property in the Context and if both
are present, and the source is connected, it sends back the response.</p><div class="table"><a name="d0e9585"></a><p class="title"><b>Table&nbsp;9.7.&nbsp;SendResponse Configuration Properties</b></p><div class="table-contents"><table summary="SendResponse Configuration Properties" style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="col_1"><col class="col_2"><col class="col_3"></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Property</th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top">Description</th><th style="border-bottom: 0.5pt solid ; " align="left" valign="top">Default Value</th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>source</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">ISOSource</code> used to send back the response</p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">SOURCE</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>request</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>The request <code class="literal">ISOMsg</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">REQUEST</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>response</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " align="left" valign="top"><p>A response <code class="literal">ISOMsg</code></p></td><td style="border-bottom: 0.5pt solid ; " align="left" valign="top"><p><code class="literal">RESPONSE</code></p></td></tr><tr><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>header-strategy</p></td><td style="border-right: 0.5pt solid ; " align="left" valign="top"><p>Header handling</p></td><td style="" align="left" valign="top"><p><code class="literal">PRESERVE_RESPONSE</code></p></td></tr></tbody></table></div></div><br class="table-break"><p>The <code class="literal">header-strategy</code> is used to define how to handle the message&#8217;s header.
It supports the following values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">PRESERVE_RESPONSE</code> (default) use the response&#8217;s header</li><li class="listitem"><code class="literal">PRESERVE_ORIGINAL</code> use the request&#8217;s header</li><li class="listitem"><code class="literal">SET_TO_NULL</code> ditto - sets the response header to null</li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>As a safety net, the <code class="literal">SendResponse</code> participant verifies that there is
no entry in the Context under the name <code class="literal">TX</code> (typically used to store a
JDBC/DB transaction). This is an arbitrary convention, we want to make
sure that transactions are committed to disk before actually sending
back responses.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_jsparticipant"></a>9.8.6&nbsp;JSParticipant</h3></div></div></div><p>The <code class="literal">org.jpos.transaction.participant.JSParticipant</code> is a handy stock
participant that leverages Java 8 Nashorn.</p><p>Here is a sample invocation:</p><pre class="programlisting"><span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.JSParticipant"</span>
    <span class="hl-attribute">logger</span>=<span class="hl-value">"Q2"</span> <span class="hl-attribute">realm</span>=<span class="hl-value">"js"</span> <span class="hl-attribute">src</span>=<span class="hl-value">'deploy/test.js'</span><span class="hl-tag"> /&gt;</span></pre><p>And here is a sample script:</p><pre class="programlisting"><span class="hl-keyword">var</span> K = Java.type(<span class="hl-string">"org.jpos.transaction.TransactionConstants"</span>);

<span class="hl-keyword">var</span> prepare = <span class="hl-keyword">function</span>(id, ctx) {
    <span class="hl-keyword">var</span> map = ctx.getMap();
    ctx.log (<span class="hl-string">"Prepare has been called"</span>);
    ctx.log (map.TIMESTAMP);
    map.NEWPROPERTY=<span class="hl-string">'ABC'</span>;
    <span class="hl-keyword">return</span> K.PREPARED;
}

<span class="hl-keyword">var</span> prepareForAbort = <span class="hl-keyword">function</span>(id, ctx) {
    ctx.put (<span class="hl-string">"Test"</span>, <span class="hl-string">"Test from JS transaction $id"</span>);
    ctx.log (<span class="hl-string">"prepareForAbort has been called"</span>);
    <span class="hl-keyword">return</span> K.PREPARED;
}

<span class="hl-keyword">var</span> commit = <span class="hl-keyword">function</span>(id, ctx) {
    ctx.log (<span class="hl-string">"Commit has been called"</span>);
}

<span class="hl-keyword">var</span> abort = <span class="hl-keyword">function</span>(id, ctx) {
    ctx.log (<span class="hl-string">"Abort has been called"</span>);
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_pause"></a>9.8.7&nbsp;Pause</h3></div></div></div><p>The <code class="literal">org.jpos.transaction.participant.Pause</code> can be used to slow down
the flow of selected transactions, without consuming TransactionManager&#8217;s
sessions (it pauses the transaction).</p><p>Here is a sample use:</p><pre class="programlisting"><span class="hl-tag">&lt;participant</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.jpos.transaction.participant.Pause"</span><span class="hl-tag">&gt;</span>
 <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"timeout"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"5000"</span><span class="hl-tag"> /&gt;</span>                       <a name="CO27-1"></a><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span>
<span class="hl-tag">&lt;/participant&gt;</span></pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO27-1"><span><img src="images/icons/callouts/1.png" alt="1" border="0"></span></a> </p></td><td valign="top" align="left"><p>Pauses the transaction for 5 seconds</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>This can be used to slightly delay specific transactions that may
come in bursts (i.e. during a SAF download), such as reversals.</p></td></tr></table></div></div></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_resultcode"></a>10.&nbsp;ResultCode</h1></div></div></div><p>Most jPOS applications need to deal with result codes going and coming
to and from different endpoints.</p><p>A "Card Expired" result code (data element 39) can be <code class="literal">14</code> for a given
ISO-8583 v1987 endpoint, a <code class="literal">54</code> in another v87 one and <code class="literal">1001</code> in a
v2003 link.</p><p>In addition to the 100+ properly defined result codes in the ISO-8583
v2003 spec (used by jPOS Common Message format)<a href="#ftn.d0e9736" class="footnote" name="d0e9736"><sup class="footnote">[6]</sup></a>
jPOS as well as user applications need to define and map their own result codes.</p><p><code class="literal">org.jpos.rc</code> defines two main interfaces:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>IRC</strong></span> (Internal Result Code)</li><li class="listitem"><span class="strong"><strong>RC</strong></span> (Result Code, which represents an external result code)</li></ul></div><p>The <code class="literal">IRC</code> interface is very simple, it just holds an integer value:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IRC {
    <span class="hl-keyword">int</span> irc();
}</pre><p>and the <code class="literal">RC</code> looks like this:</p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> RC {
    String rc();
    String display();
}</pre><p>Then we have an <code class="literal">IRCConverter</code> interface that maps an <code class="literal">IRC</code> into an <code class="literal">RC</code></p><pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IRCConverter {
    RC convert (IRC irc);
    IRC convert (RC rc);
}</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_cmf"></a>10.1&nbsp;CMF</h2></div></div></div><p><code class="literal">org.jpos.rc.CMF</code> is an enum that implements <code class="literal">IRC</code> and defines all jPOS-CMF possible internal result codes,</p><pre class="programlisting"><span class="hl-keyword">public</span> enum CMF <span class="hl-keyword">implements</span> IRC {
    <span class="hl-comment">// Approved</span>
    APPROVED         (<span class="hl-number">0</span>),
    HONOR_WITH_ID    (<span class="hl-number">1</span>),
    APPROVED_PARTIAL (<span class="hl-number">2</span>),
    APPROVED_VIP     (<span class="hl-number">3</span>),
    APPROVED_UPDATE_TRACK3 (<span class="hl-number">4</span>),
    APPROVED_ISSUER_SPECIFIED_ACCOUNT (<span class="hl-number">5</span>),
    APPROVED_PARTIAL_ISSUER_SPECIFIED_ACCOUNT (<span class="hl-number">6</span>),
    APPROVED_FEES_DISPUTED(<span class="hl-number">8</span>),
    APPROVED_WITH_OVERDRAFT(<span class="hl-number">9</span>),
    APPROVED_CUSTOMER_REACTIVATED(<span class="hl-number">10</span>),
    APPROVED_TERMINAL_UNABLE_TO_PROCESS_ONLINE(<span class="hl-number">11</span>),
    APPROVED_OFFLINE (<span class="hl-number">12</span>),
    APPROVED_OFFLINE_REFERRAL (<span class="hl-number">13</span>),

    <span class="hl-comment">// Denied Authorization</span>
    DO_NOT_HONOUR(<span class="hl-number">1000</span>),
    EXPIRED (<span class="hl-number">1001</span>),
    SUSPECTED_FRAUD(<span class="hl-number">1002</span>),
    CONTACT_ACQUIRER(<span class="hl-number">1003</span>),
    RESTRICTED_CARD(<span class="hl-number">1004</span>),
    CONTACT_ACQUIRER_SECURITY(<span class="hl-number">1005</span>),
    MAX_PIN_TRIES_EXCEEDED(<span class="hl-number">1006</span>),
    REFER_TO_ISSUER(<span class="hl-number">1007</span>),
    REFER_TO_ISSUER_SPECIAL(<span class="hl-number">1008</span>),
    INVALID_CARD_ACCEPTOR(<span class="hl-number">1009</span>),
    ...
    ...
    GENERAL_DECLINE(<span class="hl-number">9999</span>),

    <span class="hl-comment">// jPOS specific result code</span>
    JPOS(<span class="hl-number">10000</span>),

    <span class="hl-comment">// User specific result code</span>
    USER(<span class="hl-number">90000</span>);
    ...
    ...
}</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>See <a class="link" href="https://github.com/jpos/jPOS/blob/master/jpos/src/main/java/org/jpos/rc/CMF.java" target="_top">CMF.java at Github</a>
for an up-to-date list of possible CMF IRCs.</p></td></tr></table></div><p>The standard <code class="literal">CMF</code> enum defines two special result codes, <code class="literal">JPOS</code> (with an irc
value 10000) and <code class="literal">USER</code> (with an irc value 90000).</p><p>jPOS.org standard applications would use values 10000 to 19999 for its result
codes and we suggest user applications using the jPOS framework to use result codes
90000 to 99999.</p><p>This of course is optional.</p><p>We provide a general purpose converter implementation called <code class="literal">CMFConverter</code> that has the following
features:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">It provides reasonable IRC-to-RC mapping for all result codes provided in the <code class="literal">CMF</code> enum</li><li class="listitem">Default values can be overridden by a result bundle provided in the classpath</li><li class="listitem">Default values can be overridden by means of a Configuration object (<code class="literal">CMFConverter</code> implements <code class="literal">Configurable</code>).</li></ul></div><p>The <code class="literal">CMFConverter</code> reads optional override resource bundles in the following locations within the classpath
(the second bundle overrides the first one):</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">org/jpos/rc/CMF.properties</code></li><li class="listitem"><code class="literal">META-INF/org/jpos/rc/CMF.properties</code></li></ul></div><p>And then an optional <code class="literal">Configuration</code> object. The format for those overrides is:</p><p><code class="literal">IRC=RC,DISPLAY</code>, i.e:</p><pre class="screen">9999=ZZZZ,General Decline</pre><p>This would return <code class="literal">ZZZZ</code> as the result code instead of <code class="literal">9999</code> with a display message <code class="literal">General Decline</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_result_holder_class"></a>10.2&nbsp;Result holder class</h2></div></div></div><p>Financial applications typically have to perform a lot of validations,
a typical jPOS application for instance using the Transaction Manager has
participants to check mandatory and optional fields, check the terminal,
the merchant, the card, PIN, etc.</p><p>While certifying these kind of applications we usually detect the first
error and abort. Once the error gets corrected we find there&#8217;s another
error in the next test, and yet another on a third one.</p><p>So instead of early-failing, applications can "collect" result information
in the <code class="literal">Result</code> object.</p><p>We handle three type of results:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">INFO</code></li><li class="listitem"><code class="literal">WARN</code></li><li class="listitem"><code class="literal">FAIL</code></li></ul></div><p><code class="literal">INFO</code> as well as <code class="literal">WARN</code> won&#8217;t stop a transaction from succedding, while those
results with a <code class="literal">FAIL</code> type should cause the transaction to fail.</p><p>A <code class="literal">Result</code> object is typically placed in the Transaction&#8217;s Context which
now has a handy <code class="literal">getResult()</code> helper method, so a participant can use
code like this:</p><pre class="programlisting">ctx.getResult().fail (CMF.EXPIRED, Caller.info(), <span class="hl-string">"Card expired"</span>);</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p><code class="literal">Caller.info()</code> is a handy static method available in <code class="literal">org.jpos.util.Caller</code> class.</p></td></tr></table></div><p>In addition to <code class="literal">fail</code> messages, it is possible to call <code class="literal">warn</code> or <code class="literal">info</code>.
Those methods don&#8217;t require an <code class="literal">IRC</code> parameter.</p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d0e9736" class="footnote"><p><a href="#d0e9736" class="simpara"><sup class="simpara">[6] </sup></a>jPOS Common Message Format - <a class="link" href="http://jpos.org/doc/jPOS-CMF.pdf" target="_top">http://jpos.org/doc/jPOS-CMF.pdf</a></p></div></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="getting_involved"></a>Appendix&nbsp;A.&nbsp;Getting involved</h1></div></div></div><p>Most action happens in the <a class="link" href="http://groups.google.com/group/jpos-users" target="_top">jPOS Users</a> mailing list.</p><p>There you&#8217;ll find over a thousand jPOS users and developers sharing useful
information about jPOS and related technology, use cases as well as success
stories.</p><p>There&#8217;s an older <a class="link" href="http://tech.groups.yahoo.com/group/jpos-dev" target="_top">jPOS Developers</a> mailing list that we keep
as read-only reference, we rarely use it for new content.</p><p>The source code is hosted in <a class="link" href="http://github.com/jpos/jPOS" target="_top">Github/jPOS</a>. Commits are automatically
posted on Twitter <a class="link" href="https://twitter.com/jposcommits" target="_top">@jposcommits</a> and the <code class="literal">#jpos</code> channel in
<code class="literal">irc.freenode.net</code>.</p><p>There&#8217;s a low traffic <a class="link" href="http://jpos.org" target="_top">jPOS Announcements</a> mailing list and <a class="link" href="http://jpos.org/blog" target="_top">jPOS Blog</a>.</p><p>For additional resources, you can visit the <a class="link" href="http://jpos.org/resources" target="_top">jPOS Resources</a> page.</p><div class="example"><a name="d0e9987"></a><p class="title"><b>Example&nbsp;A.1.&nbsp;jPOS Team</b></p><div class="example-contents"><p><span class="inlinemediaobject"><img src="images/team.jpg" alt="jPOS Team"></span></p></div></div><br class="example-break"><p>See the <a class="link" href="https://github.com/jpos/jPOS/blob/master/CREDITS" target="_top">CREDITS</a> page for
a larger list of contributors. If you feel you belong to that list and you&#8217;re not
there, just drop us an email.</p><p>For significants code contributions to the project, users are required to sign
a standard <a class="link" href="https://github.com/jpos/jPOS/blob/master/legal/cla-template.txt" target="_top">Contributor License Agreement</a>.
For company contributions, an additional
<a class="link" href="https://github.com/jpos/jPOS/blob/master/legal/cla-template.txt" target="_top">Corporate Contributor License Agreement</a>
may be required.</p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>You can find jPOS users online in <code class="literal">irc.freenode.net</code>, on the <code class="literal">#jpos</code> channel.
jPOS Consulting office is usually online from 1600 to 2000 GMT.</p></td></tr></table></div></div><div class="appendix"><div class="titlepage"><div><div><h1 class="title"><a name="appendix_license"></a>Appendix&nbsp;B.&nbsp;License</h1></div></div></div><div class="informalexample"><p><span class="strong"><strong>GNU AFFERO GENERAL PUBLIC LICENSE</strong></span></p><p>Version 3, 19 November 2007</p><p>Copyright &copy; 2007 Free Software Foundation, Inc.
&lt;<a class="link" href="http://fsf.org/" target="_top">http://fsf.org/</a>&gt; 
 Everyone is permitted to copy and distribute verbatim copies of this
license document, but changing it is not allowed.</p><p><span class="strong"><strong>Preamble</strong></span></p><p>The GNU Affero General Public License is a free, copyleft license for
software and other kinds of works, specifically designed to ensure
cooperation with the community in the case of network server software.</p><p>The licenses for most software and other practical works are designed to
take away your freedom to share and change the works. By contrast, our
General Public Licenses are intended to guarantee your freedom to share
and change all versions of a program&#8212;&#8203;to make sure it remains free
software for all its users.</p><p>When we speak of free software, we are referring to freedom, not price.
Our General Public Licenses are designed to make sure that you have the
freedom to distribute copies of free software (and charge for them if
you wish), that you receive source code or can get it if you want it,
that you can change the software or use pieces of it in new free
programs, and that you know you can do these things.</p><p>Developers that use our General Public Licenses protect your rights with
two steps: (1) assert copyright on the software, and (2) offer you this
License which gives you legal permission to copy, distribute and/or
modify the software.</p><p>A secondary benefit of defending all users' freedom is that improvements
made in alternate versions of the program, if they receive widespread
use, become available for other developers to incorporate. Many
developers of free software are heartened and encouraged by the
resulting cooperation. However, in the case of software used on network
servers, this result may fail to come about. The GNU General Public
License permits making a modified version and letting the public access
it on a server without ever releasing its source code to the public.</p><p>The GNU Affero General Public License is designed specifically to ensure
that, in such cases, the modified source code becomes available to the
community. It requires the operator of a network server to provide the
source code of the modified version running there to the users of that
server. Therefore, public use of a modified version, on a publicly
accessible server, gives the public access to the source code of the
modified version.</p><p>An older license, called the Affero General Public License and published
by Affero, was designed to accomplish similar goals. This is a different
license, not a version of the Affero GPL, but Affero has released a new
version of the Affero GPL which permits relicensing under this license.</p><p>The precise terms and conditions for copying, distribution and
modification follow.</p><p><span class="strong"><strong>TERMS AND CONDITIONS</strong></span></p><p><span class="strong"><strong>0. Definitions.</strong></span></p><p>"This License" refers to version 3 of the GNU Affero General Public
License.</p><p>"Copyright" also means copyright-like laws that apply to other kinds of
works, such as semiconductor masks.</p><p>"The Program" refers to any copyrightable work licensed under this
License. Each licensee is addressed as "you". "Licensees" and
"recipients" may be individuals or organizations.</p><p>To "modify" a work means to copy from or adapt all or part of the work
in a fashion requiring copyright permission, other than the making of an
exact copy. The resulting work is called a "modified version" of the
earlier work or a work "based on" the earlier work.</p><p>A "covered work" means either the unmodified Program or a work based on
the Program.</p><p>To "propagate" a work means to do anything with it that, without
permission, would make you directly or secondarily liable for
infringement under applicable copyright law, except executing it on a
computer or modifying a private copy. Propagation includes copying,
distribution (with or without modification), making available to the
public, and in some countries other activities as well.</p><p>To "convey" a work means any kind of propagation that enables other
parties to make or receive copies. Mere interaction with a user through
a computer network, with no transfer of a copy, is not conveying.</p><p>An interactive user interface displays "Appropriate Legal Notices" to
the extent that it includes a convenient and prominently visible feature
that (1) displays an appropriate copyright notice, and (2) tells the
user that there is no warranty for the work (except to the extent that
warranties are provided), that licensees may convey the work under this
License, and how to view a copy of this License. If the interface
presents a list of user commands or options, such as a menu, a prominent
item in the list meets this criterion.</p><p><span class="strong"><strong>1. Source Code.</strong></span></p><p>The "source code" for a work means the preferred form of the work for
making modifications to it. "Object code" means any non-source form of a
work.</p><p>A "Standard Interface" means an interface that either is an official
standard defined by a recognized standards body, or, in the case of
interfaces specified for a particular programming language, one that is
widely used among developers working in that language.</p><p>The "System Libraries" of an executable work include anything, other
than the work as a whole, that (a) is included in the normal form of
packaging a Major Component, but which is not part of that Major
Component, and (b) serves only to enable use of the work with that Major
Component, or to implement a Standard Interface for which an
implementation is available to the public in source code form. A "Major
Component", in this context, means a major essential component (kernel,
window system, and so on) of the specific operating system (if any) on
which the executable work runs, or a compiler used to produce the work,
or an object code interpreter used to run it.</p><p>The "Corresponding Source" for a work in object code form means all the
source code needed to generate, install, and (for an executable work)
run the object code and to modify the work, including scripts to control
those activities. However, it does not include the work&#8217;s System
Libraries, or general-purpose tools or generally available free programs
which are used unmodified in performing those activities but which are
not part of the work. For example, Corresponding Source includes
interface definition files associated with source files for the work,
and the source code for shared libraries and dynamically linked
subprograms that the work is specifically designed to require, such as
by intimate data communication or control flow between those subprograms
and other parts of the work.</p><p>The Corresponding Source need not include anything that users can
regenerate automatically from other parts of the Corresponding Source.</p><p>The Corresponding Source for a work in source code form is that same
work.</p><p><span class="strong"><strong>2. Basic Permissions.</strong></span></p><p>All rights granted under this License are granted for the term of
copyright on the Program, and are irrevocable provided the stated
conditions are met. This License explicitly affirms your unlimited
permission to run the unmodified Program. The output from running a
covered work is covered by this License only if the output, given its
content, constitutes a covered work. This License acknowledges your
rights of fair use or other equivalent, as provided by copyright law.</p><p>You may make, run and propagate covered works that you do not convey,
without conditions so long as your license otherwise remains in force.
You may convey covered works to others for the sole purpose of having
them make modifications exclusively for you, or provide you with
facilities for running those works, provided that you comply with the
terms of this License in conveying all material for which you do not
control copyright. Those thus making or running the covered works for
you must do so exclusively on your behalf, under your direction and
control, on terms that prohibit them from making any copies of your
copyrighted material outside their relationship with you.</p><p>Conveying under any other circumstances is permitted solely under the
conditions stated below. Sublicensing is not allowed; section 10 makes
it unnecessary.</p><p><span class="strong"><strong>3. Protecting Users' Legal Rights From Anti-Circumvention Law.</strong></span></p><p>No covered work shall be deemed part of an effective technological
measure under any applicable law fulfilling obligations under article 11
of the WIPO copyright treaty adopted on 20 December 1996, or similar
laws prohibiting or restricting circumvention of such measures.</p><p>When you convey a covered work, you waive any legal power to forbid
circumvention of technological measures to the extent such circumvention
is effected by exercising rights under this License with respect to the
covered work, and you disclaim any intention to limit operation or
modification of the work as a means of enforcing, against the work&#8217;s
users, your or third parties' legal rights to forbid circumvention of
technological measures.</p><p><span class="strong"><strong>4. Conveying Verbatim Copies.</strong></span></p><p>You may convey verbatim copies of the Program&#8217;s source code as you
receive it, in any medium, provided that you conspicuously and
appropriately publish on each copy an appropriate copyright notice; keep
intact all notices stating that this License and any non-permissive
terms added in accord with section 7 apply to the code; keep intact all
notices of the absence of any warranty; and give all recipients a copy
of this License along with the Program.</p><p>You may charge any price or no price for each copy that you convey, and
you may offer support or warranty protection for a fee.</p><p><span class="strong"><strong>5. Conveying Modified Source Versions.</strong></span></p><p>You may convey a work based on the Program, or the modifications to
produce it from the Program, in the form of source code under the terms
of section 4, provided that you also meet all of these conditions:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">The work must carry prominent notices stating that you modified it,
and giving a relevant date.</li><li class="listitem">The work must carry prominent notices stating that it is released
under this License and any conditions added under section 7. This
requirement modifies the requirement in section 4 to "keep intact all
notices".</li><li class="listitem">You must license the entire work, as a whole, under this License to
anyone who comes into possession of a copy. This License will therefore
apply, along with any applicable section 7 additional terms, to the
whole of the work, and all its parts, regardless of how they are
packaged. This License gives no permission to license the work in any
other way, but it does not invalidate such permission if you have
separately received it.</li><li class="listitem">If the work has interactive user interfaces, each must display
Appropriate Legal Notices; however, if the Program has interactive
interfaces that do not display Appropriate Legal Notices, your work need
not make them do so.</li></ol></div><p>A compilation of a covered work with other separate and independent
works, which are not by their nature extensions of the covered work, and
which are not combined with it such as to form a larger program, in or
on a volume of a storage or distribution medium, is called an
"aggregate" if the compilation and its resulting copyright are not used
to limit the access or legal rights of the compilation&#8217;s users beyond
what the individual works permit. Inclusion of a covered work in an
aggregate does not cause this License to apply to the other parts of the
aggregate.</p><p><span class="strong"><strong>6. Conveying Non-Source Forms.</strong></span></p><p>You may convey a covered work in object code form under the terms of
sections 4 and 5, provided that you also convey the machine-readable
Corresponding Source under the terms of this License, in one of these
ways:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">Convey the object code in, or embodied in, a physical product
(including a physical distribution medium), accompanied by the
Corresponding Source fixed on a durable physical medium customarily used
for software interchange.</li><li class="listitem">Convey the object code in, or embodied in, a physical product
(including a physical distribution medium), accompanied by a written
offer, valid for at least three years and valid for as long as you offer
spare parts or customer support for that product model, to give anyone
who possesses the object code either (1) a copy of the Corresponding
Source for all the software in the product that is covered by this
License, on a durable physical medium customarily used for software
interchange, for a price no more than your reasonable cost of physically
performing this conveying of source, or (2) access to copy the
Corresponding Source from a network server at no charge.</li><li class="listitem">Convey individual copies of the object code with a copy of the
written offer to provide the Corresponding Source. This alternative is
allowed only occasionally and noncommercially, and only if you received
the object code with such an offer, in accord with subsection 6b.</li><li class="listitem">Convey the object code by offering access from a designated place
(gratis or for a charge), and offer equivalent access to the
Corresponding Source in the same way through the same place at no
further charge. You need not require recipients to copy the
Corresponding Source along with the object code. If the place to copy
the object code is a network server, the Corresponding Source may be on
a different server (operated by you or a third party) that supports
equivalent copying facilities, provided you maintain clear directions
next to the object code saying where to find the Corresponding Source.
Regardless of what server hosts the Corresponding Source, you remain
obligated to ensure that it is available for as long as needed to
satisfy these requirements.</li><li class="listitem">Convey the object code using peer-to-peer transmission, provided
you inform other peers where the object code and Corresponding Source of
the work are being offered to the general public at no charge under
subsection 6d.</li></ol></div><p>A separable portion of the object code, whose source code is excluded
from the Corresponding Source as a System Library, need not be included
in conveying the object code work.</p><p>A "User Product" is either (1) a "consumer product", which means any
tangible personal property which is normally used for personal, family,
or household purposes, or (2) anything designed or sold for
incorporation into a dwelling. In determining whether a product is a
consumer product, doubtful cases shall be resolved in favor of coverage.
For a particular product received by a particular user, "normally used"
refers to a typical or common use of that class of product, regardless
of the status of the particular user or of the way in which the
particular user actually uses, or expects or is expected to use, the
product. A product is a consumer product regardless of whether the
product has substantial commercial, industrial or non-consumer uses,
unless such uses represent the only significant mode of use of the
product.</p><p>"Installation Information" for a User Product means any methods,
procedures, authorization keys, or other information required to install
and execute modified versions of a covered work in that User Product
from a modified version of its Corresponding Source. The information
must suffice to ensure that the continued functioning of the modified
object code is in no case prevented or interfered with solely because
modification has been made.</p><p>If you convey an object code work under this section in, or with, or
specifically for use in, a User Product, and the conveying occurs as
part of a transaction in which the right of possession and use of the
User Product is transferred to the recipient in perpetuity or for a
fixed term (regardless of how the transaction is characterized), the
Corresponding Source conveyed under this section must be accompanied by
the Installation Information. But this requirement does not apply if
neither you nor any third party retains the ability to install modified
object code on the User Product (for example, the work has been
installed in ROM).</p><p>The requirement to provide Installation Information does not include a
requirement to continue to provide support service, warranty, or updates
for a work that has been modified or installed by the recipient, or for
the User Product in which it has been modified or installed. Access to a
network may be denied when the modification itself materially and
adversely affects the operation of the network or violates the rules and
protocols for communication across the network.</p><p>Corresponding Source conveyed, and Installation Information provided, in
accord with this section must be in a format that is publicly documented
(and with an implementation available to the public in source code
form), and must require no special password or key for unpacking,
reading or copying.</p><p><span class="strong"><strong>7. Additional Terms.</strong></span></p><p>"Additional permissions" are terms that supplement the terms of this
License by making exceptions from one or more of its conditions.
Additional permissions that are applicable to the entire Program shall
be treated as though they were included in this License, to the extent
that they are valid under applicable law. If additional permissions
apply only to part of the Program, that part may be used separately
under those permissions, but the entire Program remains governed by this
License without regard to the additional permissions.</p><p>When you convey a copy of a covered work, you may at your option remove
any additional permissions from that copy, or from any part of it.
(Additional permissions may be written to require their own removal in
certain cases when you modify the work.) You may place additional
permissions on material, added by you to a covered work, for which you
have or can give appropriate copyright permission.</p><p>Notwithstanding any other provision of this License, for material you
add to a covered work, you may (if authorized by the copyright holders
of that material) supplement the terms of this License with terms:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">Disclaiming warranty or limiting liability differently from the
terms of sections 15 and 16 of this License; or</li><li class="listitem">Requiring preservation of specified reasonable legal notices or
author attributions in that material or in the Appropriate Legal Notices
displayed by works containing it; or</li><li class="listitem">Prohibiting misrepresentation of the origin of that material, or
requiring that modified versions of such material be marked in
reasonable ways as different from the original version; or</li><li class="listitem">Limiting the use for publicity purposes of names of licensors or
authors of the material; or</li><li class="listitem">Declining to grant rights under trademark law for use of some trade
names, trademarks, or service marks; or</li><li class="listitem">Requiring indemnification of licensors and authors of that material
by anyone who conveys the material (or modified versions of it) with
contractual assumptions of liability to the recipient, for any liability
that these contractual assumptions directly impose on those licensors
and authors.</li></ol></div><p>All other non-permissive additional terms are considered "further
restrictions" within the meaning of section 10. If the Program as you
received it, or any part of it, contains a notice stating that it is
governed by this License along with a term that is a further
restriction, you may remove that term. If a license document contains a
further restriction but permits relicensing or conveying under this
License, you may add to a covered work material governed by the terms of
that license document, provided that the further restriction does not
survive such relicensing or conveying.</p><p>If you add terms to a covered work in accord with this section, you must
place, in the relevant source files, a statement of the additional terms
that apply to those files, or a notice indicating where to find the
applicable terms.</p><p>Additional terms, permissive or non-permissive, may be stated in the
form of a separately written license, or stated as exceptions; the above
requirements apply either way.</p><p><span class="strong"><strong>8. Termination.</strong></span></p><p>You may not propagate or modify a covered work except as expressly
provided under this License. Any attempt otherwise to propagate or
modify it is void, and will automatically terminate your rights under
this License (including any patent licenses granted under the third
paragraph of section 11).</p><p>However, if you cease all violation of this License, then your license
from a particular copyright holder is reinstated (a) provisionally,
unless and until the copyright holder explicitly and finally terminates
your license, and (b) permanently, if the copyright holder fails to
notify you of the violation by some reasonable means prior to 60 days
after the cessation.</p><p>Moreover, your license from a particular copyright holder is reinstated
permanently if the copyright holder notifies you of the violation by
some reasonable means, this is the first time you have received notice
of violation of this License (for any work) from that copyright holder,
and you cure the violation prior to 30 days after your receipt of the
notice.</p><p>Termination of your rights under this section does not terminate the
licenses of parties who have received copies or rights from you under
this License. If your rights have been terminated and not permanently
reinstated, you do not qualify to receive new licenses for the same
material under section 10.</p><p><span class="strong"><strong>9. Acceptance Not Required for Having Copies.</strong></span></p><p>You are not required to accept this License in order to receive or run a
copy of the Program. Ancillary propagation of a covered work occurring
solely as a consequence of using peer-to-peer transmission to receive a
copy likewise does not require acceptance. However, nothing other than
this License grants you permission to propagate or modify any covered
work. These actions infringe copyright if you do not accept this
License. Therefore, by modifying or propagating a covered work, you
indicate your acceptance of this License to do so.</p><p><span class="strong"><strong>10. Automatic Licensing of Downstream Recipients.</strong></span></p><p>Each time you convey a covered work, the recipient automatically
receives a license from the original licensors, to run, modify and
propagate that work, subject to this License. You are not responsible
for enforcing compliance by third parties with this License.</p><p>An "entity transaction" is a transaction transferring control of an
organization, or substantially all assets of one, or subdividing an
organization, or merging organizations. If propagation of a covered work
results from an entity transaction, each party to that transaction who
receives a copy of the work also receives whatever licenses to the work
the party&#8217;s predecessor in interest had or could give under the previous
paragraph, plus a right to possession of the Corresponding Source of the
work from the predecessor in interest, if the predecessor has it or can
get it with reasonable efforts.</p><p>You may not impose any further restrictions on the exercise of the
rights granted or affirmed under this License. For example, you may not
impose a license fee, royalty, or other charge for exercise of rights
granted under this License, and you may not initiate litigation
(including a cross-claim or counterclaim in a lawsuit) alleging that any
patent claim is infringed by making, using, selling, offering for sale,
or importing the Program or any portion of it.</p><p><span class="strong"><strong>11. Patents.</strong></span></p><p>A "contributor" is a copyright holder who authorizes use under this
License of the Program or a work on which the Program is based. The work
thus licensed is called the contributor&#8217;s "contributor version".</p><p>A contributor&#8217;s "essential patent claims" are all patent claims owned or
controlled by the contributor, whether already acquired or hereafter
acquired, that would be infringed by some manner, permitted by this
License, of making, using, or selling its contributor version, but do
not include claims that would be infringed only as a consequence of
further modification of the contributor version. For purposes of this
definition, "control" includes the right to grant patent sublicenses in
a manner consistent with the requirements of this License.</p><p>Each contributor grants you a non-exclusive, worldwide, royalty-free
patent license under the contributor&#8217;s essential patent claims, to make,
use, sell, offer for sale, import and otherwise run, modify and
propagate the contents of its contributor version.</p><p>In the following three paragraphs, a "patent license" is any express
agreement or commitment, however denominated, not to enforce a patent
(such as an express permission to practice a patent or covenant not to
sue for patent infringement). To "grant" such a patent license to a
party means to make such an agreement or commitment not to enforce a
patent against the party.</p><p>If you convey a covered work, knowingly relying on a patent license, and
the Corresponding Source of the work is not available for anyone to
copy, free of charge and under the terms of this License, through a
publicly available network server or other readily accessible means,
then you must either (1) cause the Corresponding Source to be so
available, or (2) arrange to deprive yourself of the benefit of the
patent license for this particular work, or (3) arrange, in a manner
consistent with the requirements of this License, to extend the patent
license to downstream recipients. "Knowingly relying" means you have
actual knowledge that, but for the patent license, your conveying the
covered work in a country, or your recipient&#8217;s use of the covered work
in a country, would infringe one or more identifiable patents in that
country that you have reason to believe are valid.</p><p>If, pursuant to or in connection with a single transaction or
arrangement, you convey, or propagate by procuring conveyance of, a
covered work, and grant a patent license to some of the parties
receiving the covered work authorizing them to use, propagate, modify or
convey a specific copy of the covered work, then the patent license you
grant is automatically extended to all recipients of the covered work
and works based on it.</p><p>A patent license is "discriminatory" if it does not include within the
scope of its coverage, prohibits the exercise of, or is conditioned on
the non-exercise of one or more of the rights that are specifically
granted under this License. You may not convey a covered work if you are
a party to an arrangement with a third party that is in the business of
distributing software, under which you make payment to the third party
based on the extent of your activity of conveying the work, and under
which the third party grants, to any of the parties who would receive
the covered work from you, a discriminatory patent license (a) in
connection with copies of the covered work conveyed by you (or copies
made from those copies), or (b) primarily for and in connection with
specific products or compilations that contain the covered work, unless
you entered into that arrangement, or that patent license was granted,
prior to 28 March 2007.</p><p>Nothing in this License shall be construed as excluding or limiting any
implied license or other defenses to infringement that may otherwise be
available to you under applicable patent law.</p><p><span class="strong"><strong>12. No Surrender of Others' Freedom.</strong></span></p><p>If conditions are imposed on you (whether by court order, agreement or
otherwise) that contradict the conditions of this License, they do not
excuse you from the conditions of this License. If you cannot convey a
covered work so as to satisfy simultaneously your obligations under this
License and any other pertinent obligations, then as a consequence you
may not convey it at all. For example, if you agree to terms that
obligate you to collect a royalty for further conveying from those to
whom you convey the Program, the only way you could satisfy both those
terms and this License would be to refrain entirely from conveying the
Program.</p><p><span class="strong"><strong>13. Remote Network Interaction; Use with the GNU General Public License.</strong></span></p><p>Notwithstanding any other provision of this License, if you modify the
Program, your modified version must prominently offer all users
interacting with it remotely through a computer network (if your version
supports such interaction) an opportunity to receive the Corresponding
Source of your version by providing access to the Corresponding Source
from a network server at no charge, through some standard or customary
means of facilitating copying of software. This Corresponding Source
shall include the Corresponding Source for any work covered by version 3
of the GNU General Public License that is incorporated pursuant to the
following paragraph.</p><p>Notwithstanding any other provision of this License, you have permission
to link or combine any covered work with a work licensed under version 3
of the GNU General Public License into a single combined work, and to
convey the resulting work. The terms of this License will continue to
apply to the part which is the covered work, but the work with which it
is combined will remain governed by version 3 of the GNU General Public
License.</p><p><span class="strong"><strong>14. Revised Versions of this License.</strong></span></p><p>The Free Software Foundation may publish revised and/or new versions of
the GNU Affero General Public License from time to time. Such new
versions will be similar in spirit to the present version, but may
differ in detail to address new problems or concerns.</p><p>Each version is given a distinguishing version number. If the Program
specifies that a certain numbered version of the GNU Affero General
Public License "or any later version" applies to it, you have the option
of following the terms and conditions either of that numbered version or
of any later version published by the Free Software Foundation. If the
Program does not specify a version number of the GNU Affero General
Public License, you may choose any version ever published by the Free
Software Foundation.</p><p>If the Program specifies that a proxy can decide which future versions
of the GNU Affero General Public License can be used, that proxy&#8217;s
public statement of acceptance of a version permanently authorizes you
to choose that version for the Program.</p><p>Later license versions may give you additional or different permissions.
However, no additional obligations are imposed on any author or
copyright holder as a result of your choosing to follow a later version.</p><p><span class="strong"><strong>15. Disclaimer of Warranty.</strong></span></p><p>THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
APPLICABLE LAW. EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT
WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF
THE PROGRAM IS WITH YOU. SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME
THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.</p><p><span class="strong"><strong>16. Limitation of Liability.</strong></span></p><p>IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR
CONVEYS THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES
ARISING OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT
NOT LIMITED TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES
SUSTAINED BY YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE
WITH ANY OTHER PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN
ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p><p><span class="strong"><strong>17. Interpretation of Sections 15 and 16.</strong></span></p><p>If the disclaimer of warranty and limitation of liability provided above
cannot be given local legal effect according to their terms, reviewing
courts shall apply local law that most closely approximates an absolute
waiver of all civil liability in connection with the Program, unless a
warranty or assumption of liability accompanies a copy of the Program in
return for a fee.</p><p>END OF TERMS AND CONDITIONS</p><p><span class="strong"><strong>How to Apply These Terms to Your New Programs</strong></span></p><p>If you develop a new program, and you want it to be of the greatest
possible use to the public, the best way to achieve this is to make it
free software which everyone can redistribute and change under these
terms.</p><p>To do so, attach the following notices to the program. It is safest to
attach them to the start of each source file to most effectively state
the exclusion of warranty; and each file should have at least the
"copyright" line and a pointer to where the full notice is found.</p><pre class="screen">    &lt;one line to give the program's name and a brief idea of what it does.&gt;
    Copyright (C) &lt;year&gt;  &lt;name of author&gt;

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</pre><p>Also add information on how to contact you by electronic and paper mail.</p><p>If your software can interact with users remotely through a computer
network, you should also make sure that it provides a way for users to
get its source. For example, if your program is a web application, its
interface could display a "Source" link that leads users to an archive
of the code. There are many ways you could offer source, and different
solutions will be better for different programs; see section 13 for the
specific requirements.</p><p>You should also get your employer (if you work as a programmer) or
school, if any, to sign a "copyright disclaimer" for the program, if
necessary. For more information on this, and how to apply and follow the
GNU AGPL, see
&lt;<a class="link" href="http://www.gnu.org/licenses/" target="_top">http://www.gnu.org/licenses/</a>&gt;.</p></div></div></div></body></html>